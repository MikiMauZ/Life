
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LIFE ERP - Logistics Integrated For Excellence</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #2563eb;
            --primary-dark: #1d4ed8;
            --secondary: #64748b;
            --success: #22c55e;
            --warning: #f59e0b;
            --error: #ef4444;
            --background: #f8fafc;
            --card-bg: #ffffff;
            --border: #e2e8f0;
            --text-primary: #1e293b;
            --text-secondary: #64748b;
            --sidebar-width: 280px;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--background);
            color: var(--text-primary);
            line-height: 1.6;
            overflow-x: hidden;
        }

        /* Layout Principal */
        .app-container {
            display: flex;
            min-height: 100vh;
        }

        /* Sidebar */
        .sidebar {
            width: var(--sidebar-width);
            background: var(--card-bg);
            border-right: 1px solid var(--border);
            position: fixed;
            top: 0;
            left: 0;
            height: 100vh;
            z-index: 1000;
            overflow-y: auto;
            transition: transform 0.3s ease;
        }

        .sidebar.collapsed {
            transform: translateX(-100%);
        }

        .sidebar-header {
            padding: 24px 20px;
            border-bottom: 1px solid var(--border);
            background: var(--primary);
            color: white;
            text-align: center;
        }

        .sidebar-header h1 {
            font-size: 20px;
            font-weight: 700;
            margin-bottom: 4px;
        }

        .sidebar-header .subtitle {
            font-size: 12px;
            opacity: 0.9;
            font-weight: 300;
        }

        .sidebar-nav {
            padding: 16px 0;
        }

        .nav-section {
            margin-bottom: 24px;
        }

        .nav-section-title {
            padding: 8px 20px;
            font-size: 12px;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .nav-item {
            display: block;
            padding: 12px 20px;
            color: var(--text-secondary);
            text-decoration: none;
            transition: all 0.2s;
            border: none;
            background: none;
            width: 100%;
            text-align: left;
            cursor: pointer;
            font-size: 14px;
        }

        .nav-item:hover {
            background: #f1f5f9;
            color: var(--primary);
        }

        .nav-item.active {
            background: #e0f2fe;
            color: var(--primary);
            border-right: 3px solid var(--primary);
        }

        .nav-item i {
            width: 20px;
            margin-right: 12px;
        }

        /* Main Content */
        .main-content {
            flex: 1;
            margin-left: var(--sidebar-width);
            transition: margin-left 0.3s ease;
        }

        .main-content.expanded {
            margin-left: 0;
        }

        /* Header */
        .header {
            background: var(--card-bg);
            border-bottom: 1px solid var(--border);
            padding: 16px 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .menu-toggle {
            background: none;
            border: none;
            font-size: 18px;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 8px;
            display: none;
        }

        .page-title {
            font-size: 24px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .user-details {
            text-align: right;
        }

        .user-name {
            font-weight: 500;
            color: var(--text-primary);
            font-size: 14px;
        }

        .user-role {
            font-size: 12px;
            color: var(--text-secondary);
        }

        .logout-btn {
            background: none;
            border: 1px solid var(--border);
            padding: 8px 16px;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.2s;
            font-size: 14px;
        }

        .logout-btn:hover {
            background: var(--error);
            color: white;
            border-color: var(--error);
        }

        /* Content Area */
        .content {
            padding: 24px;
        }

        .screen {
            display: none;
        }

        .screen.active {
            display: block;
        }

        .screen-content {
            display: none;
        }

        .screen-content.active {
            display: block;
        }

        /* Cards */
        .card {
            background: var(--card-bg);
            border: 1px solid var(--border);
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
            margin-bottom: 24px;
        }

        .card-header {
            padding: 20px 24px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .card-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .card-content {
            padding: 24px;
        }

        /* Buttons */
        .btn {
            padding: 10px 20px;
            border: none;
            cursor: pointer;
            font-family: inherit;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            white-space: nowrap;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-dark);
        }

        .btn-secondary {
            background: var(--secondary);
            color: white;
        }

        .btn-success {
            background: var(--success);
            color: white;
        }

        .btn-warning {
            background: var(--warning);
            color: white;
        }

        .btn-danger {
            background: var(--error);
            color: white;
        }

        .btn-outline {
            background: transparent;
            border: 1px solid var(--border);
            color: var(--text-secondary);
        }

        .btn-outline:hover {
            background: var(--border);
        }

        .btn-small {
            padding: 6px 12px;
            font-size: 12px;
        }

        .btn-large {
            padding: 14px 28px;
            font-size: 16px;
        }

        /* Forms */
        .form-group {
            margin-bottom: 16px;
        }

        .form-row {
            display: flex;
            gap: 16px;
        }

        .form-row .form-group {
            flex: 1;
        }

        .form-label {
            display: block;
            margin-bottom: 6px;
            font-weight: 500;
            color: var(--text-primary);
            font-size: 14px;
        }

        .form-input, .form-select, .form-textarea {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid var(--border);
            font-family: inherit;
            font-size: 14px;
            background: var(--card-bg);
            transition: border-color 0.2s;
        }

        .form-input:focus, .form-select:focus, .form-textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        .form-textarea {
            resize: vertical;
            min-height: 80px;
        }

        .form-checkbox, .form-radio {
            margin-right: 8px;
        }

        .checkbox-group, .radio-group {
            display: flex;
            flex-wrap: wrap;
            gap: 16px;
        }

        .checkbox-item, .radio-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* Grid System */
        .grid {
            display: grid;
            gap: 24px;
        }

        .grid-1 { grid-template-columns: 1fr; }
        .grid-2 { grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); }
        .grid-3 { grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); }
        .grid-4 { grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); }

        /* Table */
        .table-container {
            overflow-x: auto;
        }

        .table {
            width: 100%;
            border-collapse: collapse;
            min-width: 600px;
        }

        .table th, .table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid var(--border);
            font-size: 14px;
        }

        .table th {
            background: #f8fafc;
            font-weight: 600;
            color: var(--text-primary);
            position: sticky;
            top: 0;
        }

        .table tbody tr:hover {
            background: #f8fafc;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 2000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: var(--card-bg);
            width: 100%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            padding: 20px 24px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            font-size: 18px;
            font-weight: 600;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: var(--text-secondary);
            padding: 4px;
        }

        .modal-body {
            padding: 24px;
        }

        .modal-footer {
            padding: 20px 24px;
            border-top: 1px solid var(--border);
            display: flex;
            gap: 12px;
            justify-content: flex-end;
        }

        /* Toast */
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 16px 20px;
            color: white;
            font-weight: 500;
            z-index: 3000;
            transform: translateX(100%);
            transition: transform 0.3s ease;
            font-size: 14px;
            max-width: 300px;
        }

        .toast.show {
            transform: translateX(0);
        }

        .toast.success {
            background: var(--success);
        }

        .toast.error {
            background: var(--error);
        }

        .toast.warning {
            background: var(--warning);
        }

        .toast.info {
            background: var(--primary);
        }

        /* Status Badges */
        .badge {
            padding: 4px 8px;
            font-size: 12px;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .badge-active {
            background: #dcfce7;
            color: #166534;
        }

        .badge-inactive {
            background: #fee2e2;
            color: #991b1b;
        }

        .badge-pending {
            background: #fef3c7;
            color: #92400e;
        }

        .badge-approved {
            background: #dbeafe;
            color: #1e40af;
        }

        .badge-delivered {
            background: #dcfce7;
            color: #166534;
        }

        .badge-ordered {
            background: #e0e7ff;
            color: #3730a3;
        }

        /* Stock Indicators */
        .stock-critical {
            color: var(--error);
            font-weight: 600;
        }

        .stock-low {
            color: var(--warning);
            font-weight: 600;
        }

        .stock-good {
            color: var(--success);
            font-weight: 600;
        }

        /* Dashboard Stats */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 24px;
        }

        .stat-card {
            background: var(--card-bg);
            border: 1px solid var(--border);
            padding: 20px;
            text-align: center;
        }

        .stat-number {
            font-size: 32px;
            font-weight: 700;
            color: var(--primary);
            display: block;
        }

        .stat-label {
            font-size: 14px;
            color: var(--text-secondary);
            margin-top: 4px;
        }

        /* Center Cards */
        .center-card {
            background: var(--card-bg);
            border: 1px solid var(--border);
            padding: 20px;
            transition: box-shadow 0.2s;
        }

        .center-card:hover {
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .center-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 16px;
        }

        .center-name {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .center-type {
            font-size: 12px;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .center-details {
            font-size: 14px;
            color: var(--text-secondary);
            margin-bottom: 16px;
        }

        .center-actions {
            display: flex;
            gap: 8px;
            justify-content: flex-end;
        }

        /* Loading Spinner */
        .loading {
            display: none;
            text-align: center;
            padding: 40px;
        }

        .loading.show {
            display: block;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid var(--border);
            border-top: 4px solid var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 16px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Login Screen */
        .login-container {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            padding: 20px;
        }

        .login-card {
            background: var(--card-bg);
            padding: 40px;
            width: 100%;
            max-width: 400px;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
        }

        .login-header {
            text-align: center;
            margin-bottom: 32px;
        }

        .login-title {
            font-size: 28px;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 8px;
        }

        .login-subtitle {
            font-size: 14px;
            color: var(--text-secondary);
        }

        /* Quantity Controls */
        .quantity-control {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .quantity-btn {
            width: 32px;
            height: 32px;
            border: 1px solid var(--border);
            background: var(--card-bg);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            transition: background-color 0.2s;
        }

        .quantity-btn:hover {
            background: var(--border);
        }

        .quantity-input {
            width: 80px;
            text-align: center;
            padding: 6px;
            border: 1px solid var(--border);
            font-size: 14px;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .menu-toggle {
                display: block;
            }

            .sidebar {
                transform: translateX(-100%);
            }

            .sidebar.show {
                transform: translateX(0);
            }

            .main-content {
                margin-left: 0;
            }

            .header {
                padding: 12px 16px;
            }

            .page-title {
                font-size: 20px;
            }

            .content {
                padding: 16px;
            }

            .card-content {
                padding: 16px;
            }

            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 12px;
            }

            .form-row {
                flex-direction: column;
            }

            .modal-content {
                margin: 10px;
                max-width: none;
            }

            .modal-body {
                padding: 16px;
            }

            .center-actions {
                flex-direction: column;
            }

            .btn {
                justify-content: center;
            }
        }

        @media (max-width: 480px) {
            .stats-grid {
                grid-template-columns: 1fr;
            }

            .login-card {
                padding: 24px;
            }

            .checkbox-group, .radio-group {
                flex-direction: column;
                gap: 8px;
            }
        }

        /* Calendar Styles */
        .calendar-container {
            background: var(--card-bg);
            border: 1px solid var(--border);
            padding: 20px;
        }

        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .calendar-nav {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 1px;
            background: var(--border);
            border: 1px solid var(--border);
        }

        .calendar-day-header {
            background: var(--background);
            padding: 12px 8px;
            text-align: center;
            font-weight: 600;
            font-size: 14px;
            color: var(--text-secondary);
        }

        .calendar-day {
            background: var(--card-bg);
            min-height: 100px;
            padding: 8px;
            position: relative;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .calendar-day:hover {
            background: var(--background);
        }

        .calendar-day.other-month {
            opacity: 0.3;
        }

        .calendar-day.today {
            background: rgba(37, 99, 235, 0.1);
            border: 2px solid var(--primary);
        }

        .calendar-day-number {
            font-weight: 500;
            margin-bottom: 4px;
        }

        .calendar-event {
            background: var(--primary);
            color: white;
            padding: 2px 6px;
            font-size: 11px;
            border-radius: 3px;
            margin-bottom: 2px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .calendar-event.event-urgent {
            background: var(--error);
        }

        .calendar-event.event-warning {
            background: var(--warning);
        }

        /* Time Log Styles */
        .time-entry {
            display: flex;
            gap: 16px;
            align-items: center;
            padding: 12px;
            background: var(--card-bg);
            border: 1px solid var(--border);
            margin-bottom: 8px;
            border-radius: 4px;
        }

        .time-entry:hover {
            background: var(--background);
        }

        .time-controls {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .timer-display {
            font-size: 24px;
            font-weight: 700;
            font-family: 'Courier New', monospace;
            color: var(--primary);
            min-width: 120px;
            text-align: center;
        }

        .timer-running {
            color: var(--success);
        }

        .timer-paused {
            color: var(--warning);
        }

        /* Time Log Summary */
        .time-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }

        .time-summary-card {
            background: var(--card-bg);
            border: 1px solid var(--border);
            padding: 16px;
            text-align: center;
            border-radius: 4px;
        }

        .time-summary-value {
            font-size: 20px;
            font-weight: 700;
            color: var(--primary);
            display: block;
        }

        .time-summary-label {
            font-size: 12px;
            color: var(--text-secondary);
            margin-top: 4px;
        }

        /* Accounting Tab Styles */
        .accounting-tab {
            border-color: var(--border) !important;
            transition: all 0.2s;
        }

        .accounting-tab.active {
            background: var(--primary) !important;
            color: white !important;
            border-color: var(--primary) !important;
        }

        .accounting-tab:not(.active):hover {
            background: var(--background);
            border-color: var(--primary);
        }

        .accounting-tab-content {
            display: none;
        }

        .accounting-tab-content.active {
            display: block;
        }

        /* Financial Cards */
        .financial-summary-card {
            background: var(--card-bg);
            border: 1px solid var(--border);
            padding: 16px;
            border-radius: 4px;
            margin-bottom: 12px;
        }

        .financial-summary-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .financial-summary-center {
            font-weight: 600;
            color: var(--text-primary);
        }

        .financial-summary-period {
            font-size: 12px;
            color: var(--text-secondary);
        }

        .financial-summary-metrics {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
        }

        .financial-metric {
            text-align: center;
            padding: 8px;
            background: var(--background);
            border-radius: 4px;
        }

        .financial-metric-value {
            font-size: 16px;
            font-weight: 600;
            color: var(--primary);
        }

        .financial-metric-label {
            font-size: 11px;
            color: var(--text-secondary);
            margin-top: 2px;
        }

        /* Budget Cards */
        .budget-card {
            background: var(--card-bg);
            border: 1px solid var(--border);
            border-radius: 4px;
            padding: 16px;
            margin-bottom: 16px;
        }

        .budget-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .budget-title {
            font-weight: 600;
            color: var(--text-primary);
        }

        .budget-period {
            font-size: 12px;
            color: var(--text-secondary);
        }

        .budget-progress {
            margin-bottom: 12px;
        }

        .budget-progress-bar {
            width: 100%;
            height: 8px;
            background: var(--border);
            border-radius: 4px;
            overflow: hidden;
        }

        .budget-progress-fill {
            height: 100%;
            background: var(--primary);
            transition: width 0.3s ease;
        }

        .budget-progress-fill.warning {
            background: var(--warning);
        }

        .budget-progress-fill.danger {
            background: var(--error);
        }

        .budget-details {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            font-size: 14px;
        }

        .budget-spent {
            color: var(--text-secondary);
        }

        .budget-remaining {
            color: var(--success);
            text-align: right;
        }

        /* Transaction Table Enhancements */
        .transaction-type-income {
            color: var(--success);
            font-weight: 600;
        }

        .transaction-type-expense {
            color: var(--error);
            font-weight: 600;
        }

        .transaction-amount-positive {
            color: var(--success);
            font-weight: 600;
        }

        .transaction-amount-negative {
            color: var(--error);
            font-weight: 600;
        }

        /* Budget Category Items */
        .budget-category-item {
            background: var(--background);
            transition: all 0.2s;
        }

        .budget-category-item:hover {
            background: var(--border);
        }

        /* Utilities */
        .text-center { text-align: center; }
        .text-right { text-align: right; }
        .text-left { text-align: left; }
        .font-bold { font-weight: 700; }
        .font-medium { font-weight: 500; }
        .text-sm { font-size: 14px; }
        .text-xs { font-size: 12px; }
        .text-lg { font-size: 18px; }
        .mb-4 { margin-bottom: 16px; }
        .mt-4 { margin-top: 16px; }
        .mb-2 { margin-bottom: 8px; }
        .mt-2 { margin-top: 8px; }
        .hidden { display: none; }
        .flex { display: flex; }
        .items-center { align-items: center; }
        .justify-between { justify-content: space-between; }
        .justify-center { justify-content: center; }
        .gap-2 { gap: 8px; }
        .gap-4 { gap: 16px; }
        .w-full { width: 100%; }
        .h-full { height: 100%; }
        .text-secondary { color: var(--text-secondary); }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div id="loginScreen" class="screen active">
        <div class="login-container">
            <div class="login-card">
                <div class="login-header">
                    <h1 class="login-title">LIFE ERP</h1>
                    <p class="login-subtitle">Logistics Integrated For Excellence</p>
                    <div style="background: #e3f2fd; padding: 12px; border-radius: 4px; margin-top: 16px; font-size: 14px; color: #1565c0;">
                        <strong>Credenciales por defecto:</strong><br>
                        Email: admin@life.com<br>
                        Contraseña: admin123
                    </div>
                </div>
                <form id="loginForm">
                    <div class="form-group">
                        <label class="form-label">Email</label>
                        <input type="email" id="loginEmail" class="form-input" required placeholder="admin@life.com" value="admin@life.com">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Contraseña</label>
                        <input type="password" id="loginPassword" class="form-input" required placeholder="admin123" value="admin123">
                    </div>
                    <button type="submit" class="btn btn-primary btn-large w-full">
                        <i class="fas fa-sign-in-alt"></i>
                        Iniciar Sesión
                    </button>
                </form>
                <div id="loginLoading" class="loading">
                    <div class="spinner"></div>
                    <p>Autenticando...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Main App -->
    <div id="appScreen" class="screen">
        <div class="app-container">
            <!-- Sidebar -->
            <aside id="sidebar" class="sidebar">
                <div class="sidebar-header">
                    <h1>LIFE ERP</h1>
                    <p class="subtitle">Logistics Excellence</p>
                </div>
                <nav class="sidebar-nav" id="sidebarNav">
                    <!-- Navigation will be populated by JavaScript -->
                </nav>
            </aside>

            <!-- Main Content -->
            <main class="main-content" id="mainContent">
                <!-- Header -->
                <header class="header">
                    <div class="header-left">
                        <button class="menu-toggle" id="menuToggle">
                            <i class="fas fa-bars"></i>
                        </button>
                        <h1 class="page-title" id="pageTitle">Dashboard</h1>
                    </div>
                    <div class="header-center" style="display: flex; align-items: center; gap: 16px;">
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <i class="fas fa-building" style="color: var(--text-secondary);"></i>
                            <select id="globalCenterFilter" class="form-select" style="min-width: 200px;">
                                <option value="">Todos los centros</option>
                            </select>
                        </div>
                    </div>
                    <div class="user-info">
                        <div class="user-details">
                            <div class="user-name" id="userName">Usuario</div>
                            <div class="user-role" id="userRole">Rol</div>
                        </div>
                        <button class="logout-btn" id="logoutBtn">
                            <i class="fas fa-sign-out-alt"></i>
                            Salir
                        </button>
                    </div>
                </header>

                <!-- Content -->
                <div class="content">
                    <!-- Dashboard Screen -->
                    <div id="dashboardContent" class="screen-content active">
                        <div class="stats-grid" id="dashboardStats">
                            <!-- Stats will be populated by JavaScript -->
                        </div>

                        <div class="grid-2">
                            <div class="card">
                                <div class="card-header">
                                    <h2 class="card-title">Resumen de Actividad</h2>
                                </div>
                                <div class="card-content">
                                    <div id="activitySummary">
                                        <p class="text-center text-secondary">Cargando datos...</p>
                                    </div>
                                </div>
                            </div>

                            <div class="card">
                                <div class="card-header">
                                    <h2 class="card-title">Alertas y Notificaciones</h2>
                                </div>
                                <div class="card-content">
                                    <div id="alertsList">
                                        <p class="text-center text-secondary">Sin alertas pendientes</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Centers Management Screen -->
                    <div id="centersContent" class="screen-content">
                        <div class="card">
                            <div class="card-header">
                                <h2 class="card-title">Gestión de Centros</h2>
                                <button class="btn btn-primary" id="addCenterBtn">
                                    <i class="fas fa-plus"></i>
                                    Nuevo Centro
                                </button>
                            </div>
                            <div class="card-content">
                                <div id="centersGrid" class="grid-2">
                                    <!-- Centers will be populated here -->
                                </div>
                                <div id="centersLoading" class="loading">
                                    <div class="spinner"></div>
                                    <p>Cargando centros...</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Users Management Screen -->
                    <div id="usersContent" class="screen-content">
                        <div class="card">
                            <div class="card-header">
                                <h2 class="card-title">Gestión de Usuarios</h2>
                                <button class="btn btn-primary" id="addUserBtn">
                                    <i class="fas fa-user-plus"></i>
                                    Nuevo Usuario
                                </button>
                            </div>
                            <div class="card-content">
                                <div class="table-container">
                                    <table class="table" id="usersTable">
                                        <thead>
                                            <tr>
                                                <th>Nombre</th>
                                                <th>Email</th>
                                                <th>Rol</th>
                                                <th>Centros Asignados</th>
                                                <th>Estado</th>
                                                <th>Acciones</th>
                                            </tr>
                                        </thead>
                                        <tbody id="usersTableBody">
                                            <!-- Users will be populated here -->
                                        </tbody>
                                    </table>
                                </div>
                                <div id="usersLoading" class="loading">
                                    <div class="spinner"></div>
                                    <p>Cargando usuarios...</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Inventory Screen -->
                    <div id="inventoryContent" class="screen-content">
                        <div class="card">
                            <div class="card-header">
                                <h2 class="card-title">Inventario</h2>
                                <div class="flex gap-2">
                                    <select id="departmentFilter" class="form-select" style="width: auto;">
                                        <option value="">Todos los departamentos</option>
                                    </select>
                                    <button class="btn btn-primary" id="addInventoryBtn">
                                        <i class="fas fa-plus"></i>
                                        Nuevo Producto
                                    </button>
                                </div>
                            </div>
                            <div class="card-content">
                                <div class="table-container">
                                    <table class="table" id="inventoryTable">
                                        <thead>
                                            <tr>
                                                <th>Producto</th>
                                                <th>Centro</th>
                                                <th>Departamento</th>
                                                <th>Stock Actual</th>
                                                <th>Mín / Máx</th>
                                                <th>Fecha Vencimiento</th>
                                                <th>Estado</th>
                                                <th>Acciones</th>
                                            </tr>
                                        </thead>
                                        <tbody id="inventoryTableBody">
                                            <!-- Inventory items will be populated here -->
                                        </tbody>
                                    </table>
                                </div>
                                <div id="inventoryLoading" class="loading">
                                    <div class="spinner"></div>
                                    <p>Cargando inventario...</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Orders Screen -->
                    <div id="ordersContent" class="screen-content">
                        <div class="card">
                            <div class="card-header">
                                <h2 class="card-title">Pedidos</h2>
                                <button class="btn btn-primary" id="addOrderBtn">
                                    <i class="fas fa-plus"></i>
                                    Nuevo Pedido
                                </button>
                            </div>
                            <div class="card-content">
                                <div class="table-container">
                                    <table class="table" id="ordersTable">
                                        <thead>
                                            <tr>
                                                <th>ID Pedido</th>
                                                <th>Centro</th>
                                                <th>Fecha</th>
                                                <th>Total</th>
                                                <th>Estado</th>
                                                <th>Creado por</th>
                                                <th>Acciones</th>
                                            </tr>
                                        </thead>
                                        <tbody id="ordersTableBody">
                                            <!-- Orders will be populated here -->
                                        </tbody>
                                    </table>
                                </div>
                                <div id="ordersLoading" class="loading">
                                    <div class="spinner"></div>
                                    <p>Cargando pedidos...</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Calendar Screen -->
                    <div id="calendarContent" class="screen-content">
                        <div class="card">
                            <div class="card-header">
                                <h2 class="card-title">Calendario</h2>
                                <button class="btn btn-primary" id="addEventBtn">
                                    <i class="fas fa-plus"></i>
                                    Nuevo Evento
                                </button>
                            </div>
                            <div class="card-content">
                                <div class="calendar-container">
                                    <div class="calendar-header">
                                        <h3 id="calendarTitle" class="font-medium">Enero 2024</h3>
                                        <div class="calendar-nav">
                                            <button class="btn btn-outline btn-small" id="prevMonth">
                                                <i class="fas fa-chevron-left"></i>
                                            </button>
                                            <button class="btn btn-outline btn-small" id="todayBtn">Hoy</button>
                                            <button class="btn btn-outline btn-small" id="nextMonth">
                                                <i class="fas fa-chevron-right"></i>
                                            </button>
                                        </div>
                                    </div>
                                    <div class="calendar-grid" id="calendarGrid">
                                        <!-- Calendar will be populated by JavaScript -->
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Time Log Screen -->
                    <div id="timelogContent" class="screen-content">
                        <div class="card">
                            <div class="card-header">
                                <h2 class="card-title">Registro de Horas</h2>
                                <button class="btn btn-primary" id="addTimeEntryBtn">
                                    <i class="fas fa-plus"></i>
                                    Nueva Entrada
                                </button>
                            </div>
                            <div class="card-content">
                                <!-- Time Summary -->
                                <div class="time-summary" id="timeSummary">
                                    <div class="time-summary-card">
                                        <span class="time-summary-value" id="todayHours">0:00</span>
                                        <div class="time-summary-label">Hoy</div>
                                    </div>
                                    <div class="time-summary-card">
                                        <span class="time-summary-value" id="weekHours">0:00</span>
                                        <div class="time-summary-label">Esta Semana</div>
                                    </div>
                                    <div class="time-summary-card">
                                        <span class="time-summary-value" id="monthHours">0:00</span>
                                        <div class="time-summary-label">Este Mes</div>
                                    </div>
                                </div>

                                <!-- Active Timer -->
                                <div class="card" style="margin-bottom: 20px;">
                                    <div class="card-header">
                                        <h3 class="card-title">Timer Activo</h3>
                                    </div>
                                    <div class="card-content">
                                        <div class="flex items-center justify-between">
                                            <div class="flex items-center gap-4">
                                                <div class="timer-display" id="activeTimer">00:00:00</div>
                                                <div>
                                                    <input type="text" id="activeTask" class="form-input" placeholder="¿En qué estás trabajando?" style="width: 300px;">
                                                    <div class="text-sm text-secondary" id="activeTaskInfo">Sin tarea activa</div>
                                                </div>
                                            </div>
                                            <div class="time-controls">
                                                <button class="btn btn-success" id="startTimer">
                                                    <i class="fas fa-play"></i>
                                                    Iniciar
                                                </button>
                                                <button class="btn btn-warning hidden" id="pauseTimer">
                                                    <i class="fas fa-pause"></i>
                                                    Pausar
                                                </button>
                                                <button class="btn btn-danger hidden" id="stopTimer">
                                                    <i class="fas fa-stop"></i>
                                                    Finalizar
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Time Entries List -->
                                <div class="card">
                                    <div class="card-header">
                                        <h3 class="card-title">Entradas de Tiempo</h3>
                                        <div class="flex gap-2">
                                            <input type="date" id="timelogDateFilter" class="form-input" style="width: auto;">
                                            <select id="timelogTaskFilter" class="form-select" style="width: auto;">
                                                <option value="">Todas las tareas</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="card-content">
                                        <div id="timeEntriesList">
                                            <p class="text-center text-secondary">No hay entradas de tiempo registradas</p>
                                        </div>
                                        <div id="timelogLoading" class="loading">
                                            <div class="spinner"></div>
                                            <p>Cargando entradas...</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Suppliers Screen -->
                    <div id="suppliersContent" class="screen-content">
                        <div class="card">
                            <div class="card-header">
                                <h2 class="card-title">Gestión de Proveedores</h2>
                                <div class="flex gap-2">
                                    <select id="supplierCategoryFilter" class="form-select" style="width: auto;">
                                        <option value="">Todas las categorías</option>
                                    </select>
                                    <button class="btn btn-primary" id="addSupplierBtn">
                                        <i class="fas fa-plus"></i>
                                        Nuevo Proveedor
                                    </button>
                                </div>
                            </div>
                            <div class="card-content">
                                <div class="table-container">
                                    <table class="table" id="suppliersTable">
                                        <thead>
                                            <tr>
                                                <th>Proveedor</th>
                                                <th>Categorías</th>
                                                <th>Contacto</th>
                                                <th>Calificación</th>
                                                <th>Tiempo Entrega</th>
                                                <th>Estado</th>
                                                <th>Acciones</th>
                                            </tr>
                                        </thead>
                                        <tbody id="suppliersTableBody">
                                            <!-- Suppliers will be populated here -->
                                        </tbody>
                                    </table>
                                </div>
                                <div id="suppliersLoading" class="loading">
                                    <div class="spinner"></div>
                                    <p>Cargando proveedores...</p>
                                </div>
                            </div>
                        </div>

                        <!-- Purchase Orders Section -->
                        <div class="card">
                            <div class="card-header">
                                <h2 class="card-title">Órdenes de Compra</h2>
                                <div class="flex gap-2">
                                    <select id="purchaseOrderStatusFilter" class="form-select" style="width: auto;">
                                        <option value="">Todos los estados</option>
                                        <option value="draft">Borrador</option>
                                        <option value="sent">Enviada</option>
                                        <option value="confirmed">Confirmada</option>
                                        <option value="in_transit">En Tránsito</option>
                                        <option value="delivered">Entregada</option>
                                        <option value="cancelled">Cancelada</option>
                                    </select>
                                    <button class="btn btn-primary" id="createPurchaseOrderBtn">
                                        <i class="fas fa-plus"></i>
                                        Nueva Orden de Compra
                                    </button>
                                </div>
                            </div>
                            <div class="card-content">
                                <div class="table-container">
                                    <table class="table" id="purchaseOrdersTable">
                                        <thead>
                                            <tr>
                                                <th>ID Orden</th>
                                                <th>Proveedor</th>
                                                <th>Centro</th>
                                                <th>Fecha</th>
                                                <th>Total</th>
                                                <th>Estado</th>
                                                <th>Acciones</th>
                                            </tr>
                                        </thead>
                                        <tbody id="purchaseOrdersTableBody">
                                            <!-- Purchase orders will be populated here -->
                                        </tbody>
                                    </table>
                                </div>
                                <div id="purchaseOrdersLoading" class="loading">
                                    <div class="spinner"></div>
                                    <p>Cargando órdenes de compra...</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Accounting Screen -->
                    <div id="accountingContent" class="screen-content">
                        <!-- Financial Overview -->
                        <div class="stats-grid" style="margin-bottom: 24px;">
                            <div class="stat-card">
                                <span class="stat-number" id="totalIncome">€0</span>
                                <div class="stat-label">Ingresos del Mes</div>
                            </div>
                            <div class="stat-card">
                                <span class="stat-number" id="totalExpenses">€0</span>
                                <div class="stat-label">Gastos del Mes</div>
                            </div>
                            <div class="stat-card">
                                <span class="stat-number" id="netProfit">€0</span>
                                <div class="stat-label">Beneficio Neto</div>
                            </div>
                            <div class="stat-card">
                                <span class="stat-number" id="pendingPayments">€0</span>
                                <div class="stat-label">Pagos Pendientes</div>
                            </div>
                        </div>

                        <!-- Accounting Tabs -->
                        <div class="card">
                            <div class="card-header">
                                <h2 class="card-title">Contabilidad</h2>
                                <div class="flex gap-2">
                                    <button class="btn btn-outline accounting-tab active" onclick="showAccountingTab('overview')">
                                        <i class="fas fa-chart-pie"></i> Resumen
                                    </button>
                                    <button class="btn btn-outline accounting-tab" onclick="showAccountingTab('transactions')">
                                        <i class="fas fa-exchange-alt"></i> Transacciones
                                    </button>
                                    <button class="btn btn-outline accounting-tab" onclick="showAccountingTab('reports')">
                                        <i class="fas fa-chart-line"></i> Reportes
                                    </button>
                                    <button class="btn btn-outline accounting-tab" onclick="showAccountingTab('budgets')">
                                        <i class="fas fa-calculator"></i> Presupuestos
                                    </button>
                                </div>
                            </div>
                            <div class="card-content">
                                <!-- Overview Tab -->
                                <div id="accountingOverview" class="accounting-tab-content active">
                                    <div class="grid-2">
                                        <div class="card">
                                            <div class="card-header">
                                                <h3 class="card-title">Flujo de Caja</h3>
                                            </div>
                                            <div class="card-content">
                                                <div id="cashFlowChart" class="text-center text-secondary">
                                                    <i class="fas fa-chart-line" style="font-size: 48px; margin-bottom: 16px; opacity: 0.3;"></i>
                                                    <p>Gráfico de flujo de caja</p>
                                                    <small>Próximamente: Integración con Chart.js</small>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="card">
                                            <div class="card-header">
                                                <h3 class="card-title">Resumen por Centro</h3>
                                            </div>
                                            <div class="card-content">
                                                <div id="centerFinancialSummary">
                                                    <!-- Financial summary by center will be populated here -->
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Transactions Tab -->
                                <div id="accountingTransactions" class="accounting-tab-content">
                                    <div class="flex justify-between items-center mb-4">
                                        <div class="flex gap-2">
                                            <select id="transactionTypeFilter" class="form-select" style="width: auto;">
                                                <option value="">Todos los tipos</option>
                                                <option value="income">Ingresos</option>
                                                <option value="expense">Gastos</option>
                                                <option value="purchase_order">Orden de Compra</option>
                                            </select>
                                            <input type="month" id="transactionMonthFilter" class="form-input" style="width: auto;">
                                        </div>
                                        <button class="btn btn-primary" id="addTransactionBtn">
                                            <i class="fas fa-plus"></i> Nueva Transacción
                                        </button>
                                    </div>

                                    <div class="table-container">
                                        <table class="table" id="transactionsTable">
                                            <thead>
                                                <tr>
                                                    <th>Fecha</th>
                                                    <th>Tipo</th>
                                                    <th>Descripción</th>
                                                    <th>Centro</th>
                                                    <th>Categoría</th>
                                                    <th>Monto</th>
                                                    <th>Estado</th>
                                                    <th>Acciones</th>
                                                </tr>
                                            </thead>
                                            <tbody id="transactionsTableBody">
                                                <!-- Transactions will be populated here -->
                                            </tbody>
                                        </table>
                                    </div>
                                    <div id="transactionsLoading" class="loading">
                                        <div class="spinner"></div>
                                        <p>Cargando transacciones...</p>
                                    </div>
                                </div>

                                <!-- Reports Tab -->
                                <div id="accountingReports" class="accounting-tab-content">
                                    <div class="grid-2">
                                        <div class="card">
                                            <div class="card-header">
                                                <h3 class="card-title">Generar Reportes</h3>
                                            </div>
                                            <div class="card-content">
                                                <div class="form-group">
                                                    <label class="form-label">Tipo de Reporte</label>
                                                    <select id="reportType" class="form-select">
                                                        <option value="profit_loss">Estado de Resultados</option>
                                                        <option value="balance_sheet">Balance de Situación</option>
                                                        <option value="cash_flow">Flujo de Caja</option>
                                                        <option value="center_comparison">Comparación por Centro</option>
                                                    </select>
                                                </div>
                                                <div class="form-row">
                                                    <div class="form-group">
                                                        <label class="form-label">Fecha Inicio</label>
                                                        <input type="date" id="reportStartDate" class="form-input">
                                                    </div>
                                                    <div class="form-group">
                                                        <label class="form-label">Fecha Fin</label>
                                                        <input type="date" id="reportEndDate" class="form-input">
                                                    </div>
                                                </div>
                                                <button class="btn btn-primary w-full" onclick="generateReport()">
                                                    <i class="fas fa-file-pdf"></i> Generar Reporte
                                                </button>
                                            </div>
                                        </div>
                                        <div class="card">
                                            <div class="card-header">
                                                <h3 class="card-title">Reportes Recientes</h3>
                                            </div>
                                            <div class="card-content">
                                                <div id="recentReports">
                                                    <p class="text-center text-secondary">No hay reportes generados</p>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Budgets Tab -->
                                <div id="accountingBudgets" class="accounting-tab-content">
                                    <div class="flex justify-between items-center mb-4">
                                        <h3 class="font-medium">Presupuestos por Centro</h3>
                                        <button class="btn btn-primary" id="addBudgetBtn">
                                            <i class="fas fa-plus"></i> Nuevo Presupuesto
                                        </button>
                                    </div>

                                    <div class="grid-2">
                                        <div id="budgetsGrid">
                                            <!-- Budgets will be populated here -->
                                        </div>
                                    </div>
                                    <div id="budgetsLoading" class="loading">
                                        <div class="spinner"></div>
                                        <p>Cargando presupuestos...</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Configuration Screen -->
                    <div id="configContent" class="screen-content">
                        <div class="grid-2">
                            <div class="card">
                                <div class="card-header">
                                    <h2 class="card-title">Configuración Global</h2>
                                </div>
                                <div class="card-content">
                                    <form id="globalConfigForm">
                                        <div class="form-group">
                                            <label class="form-label">Categorías de Productos</label>
                                            <div id="categoriesList">
                                                <!-- Categories will be populated here -->
                                            </div>
                                            <button type="button" class="btn btn-outline btn-small" id="addCategoryBtn">
                                                <i class="fas fa-plus"></i>
                                                Añadir Categoría
                                            </button>
                                        </div>

                                        <div class="form-group">
                                            <label class="form-label">Departamentos Disponibles</label>
                                            <div id="departmentsList">
                                                <!-- Departments will be populated here -->
                                            </div>
                                            <button type="button" class="btn btn-outline btn-small" id="addDepartmentBtn">
                                                <i class="fas fa-plus"></i>
                                                Añadir Departamento
                                            </button>
                                        </div>

                                        <button type="submit" class="btn btn-primary">
                                            <i class="fas fa-save"></i>
                                            Guardar Configuración
                                        </button>
                                    </form>
                                </div>
                            </div>

                            <div class="card">
                                <div class="card-header">
                                    <h2 class="card-title">Templates de Centro</h2>
                                </div>
                                <div class="card-content">
                                    <div id="templatesGrid">
                                        <div class="center-card">
                                            <div class="center-header">
                                                <div>
                                                    <div class="center-name">Template Clínica</div>
                                                    <div class="center-type">CLINICA</div>
                                                </div>
                                                <span class="badge badge-active">Predefinido</span>
                                            </div>
                                            <div class="center-details">
                                                <p><i class="fas fa-building"></i> Enfermería, Quirófano, Farmacia, Limpieza</p>
                                                <p><i class="fas fa-boxes"></i> Material Sanitario, Farmacia, Limpieza</p>
                                            </div>
                                        </div>

                                        <div class="center-card">
                                            <div class="center-header">
                                                <div>
                                                    <div class="center-name">Template Residencia</div>
                                                    <div class="center-type">RESIDENCIA</div>
                                                </div>
                                                <span class="badge badge-active">Predefinido</span>
                                            </div>
                                            <div class="center-details">
                                                <p><i class="fas fa-building"></i> Enfermería, Cocina, Limpieza, Lavandería</p>
                                                <p><i class="fas fa-boxes"></i> Alimentario, Material Sanitario, Textil</p>
                                            </div>
                                        </div>

                                        <div class="center-card">
                                            <div class="center-header">
                                                <div>
                                                    <div class="center-name">Template Hotel</div>
                                                    <div class="center-type">HOTEL</div>
                                                </div>
                                                <span class="badge badge-active">Predefinido</span>
                                            </div>
                                            <div class="center-details">
                                                <p><i class="fas fa-building"></i> Recepción, Limpieza, Lavandería, Cocina</p>
                                                <p><i class="fas fa-boxes"></i> Amenities, Limpieza, Alimentario, Textil</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Add Center Modal -->
    <div id="addCenterModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Nuevo Centro</h3>
                <button class="modal-close" onclick="closeModal('addCenterModal')">&times;</button>
            </div>
            <div class="modal-body">
                <form id="addCenterForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Nombre del Centro *</label>
                            <input type="text" id="centerName" class="form-input" required placeholder="Ej: Clínica San José">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Tipo de Centro *</label>
                            <select id="centerType" class="form-select" required>
                                <option value="">Seleccionar tipo</option>
                                <option value="CLINICA">Clínica</option>
                                <option value="RESIDENCIA">Residencia</option>
                                <option value="HOTEL">Hotel</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Dirección *</label>
                        <input type="text" id="centerAddress" class="form-input" required placeholder="Calle, número, ciudad">
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Teléfono</label>
                            <input type="tel" id="centerPhone" class="form-input" placeholder="+34 600 000 000">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Email de Contacto</label>
                            <input type="email" id="centerEmail" class="form-input" placeholder="contacto@centro.com">
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Departamentos *</label>
                        <div class="checkbox-group" id="centerDepartments">
                            <!-- Departments will be populated by JavaScript -->
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Administrador del Centro</label>
                        <select id="centerAdmin" class="form-select">
                            <option value="">Seleccionar administrador</option>
                            <!-- Users will be populated by JavaScript -->
                        </select>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Notas</label>
                        <textarea id="centerNotes" class="form-textarea" placeholder="Información adicional sobre el centro..."></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline" onclick="closeModal('addCenterModal')">Cancelar</button>
                <button type="submit" form="addCenterForm" class="btn btn-primary">
                    <i class="fas fa-save"></i>
                    Crear Centro
                </button>
            </div>
        </div>
    </div>

    <!-- Add User Modal -->
    <div id="addUserModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Nuevo Usuario</h3>
                <button class="modal-close" onclick="closeModal('addUserModal')">&times;</button>
            </div>
            <div class="modal-body">
                <form id="addUserForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Nombre Completo *</label>
                            <input type="text" id="userName" class="form-input" required placeholder="Juan Pérez">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Email *</label>
                            <input type="email" id="userEmail" class="form-input" required placeholder="usuario@empresa.com">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Rol *</label>
                            <select id="userRole" class="form-select" required>
                                <option value="">Seleccionar rol</option>
                                <option value="LIFE_ADMIN">LIFE Admin</option>
                                <option value="CENTER_ADMIN">Center Admin</option>
                                <option value="CLIENT_VIEWER">Client Viewer</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Contraseña Temporal *</label>
                            <input type="password" id="userPassword" class="form-input" required placeholder="••••••••">
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Centros Asignados</label>
                        <div class="checkbox-group" id="userCenters">
                            <!-- Centers will be populated by JavaScript -->
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Departamento</label>
                        <input type="text" id="userDepartment" class="form-input" placeholder="Ej: Enfermería, Administración">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline" onclick="closeModal('addUserModal')">Cancelar</button>
                <button type="submit" form="addUserForm" class="btn btn-primary">
                    <i class="fas fa-user-plus"></i>
                    Crear Usuario
                </button>
            </div>
        </div>
    </div>

    <!-- Add Inventory Modal -->
    <div id="addInventoryModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Nuevo Producto en Inventario</h3>
                <button class="modal-close" onclick="closeModal('addInventoryModal')">&times;</button>
            </div>
            <div class="modal-body">
                <form id="addInventoryForm">
                    <div class="form-row" id="inventoryCenterRow">
                        <div class="form-group">
                            <label class="form-label">Centro *</label>
                            <select id="inventoryCenter" class="form-select" required>
                                <option value="">Seleccionar centro</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Departamento *</label>
                            <select id="inventoryDepartment" class="form-select" required>
                                <option value="">Seleccionar departamento</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-group" id="inventoryDepartmentOnly" style="display: none;">
                        <label class="form-label">Departamento *</label>
                        <select id="inventoryDepartmentAlt" class="form-select" required>
                            <option value="">Seleccionar departamento</option>
                        </select>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Nombre del Producto *</label>
                            <input type="text" id="inventoryProduct" class="form-input" required placeholder="Ej: Gasas estériles 10x10">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Categoría *</label>
                            <select id="inventoryCategory" class="form-select" required>
                                <option value="">Seleccionar categoría</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Stock Actual *</label>
                            <input type="number" id="inventoryStock" class="form-input" required min="0" placeholder="0">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Stock Mínimo *</label>
                            <input type="number" id="inventoryMinStock" class="form-input" required min="0" placeholder="10">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Stock Máximo *</label>
                            <input type="number" id="inventoryMaxStock" class="form-input" required min="0" placeholder="100">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Fecha de Vencimiento</label>
                            <input type="date" id="inventoryExpiry" class="form-input">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Código/Lote</label>
                            <input type="text" id="inventoryLot" class="form-input" placeholder="Código de lote o referencia">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Ubicación</label>
                            <input type="text" id="inventoryLocation" class="form-input" placeholder="Ej: Almacén A, Estante 2">
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Observaciones</label>
                        <textarea id="inventoryNotes" class="form-textarea" placeholder="Notas adicionales sobre el producto..."></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline" onclick="closeModal('addInventoryModal')">Cancelar</button>
                <button type="submit" form="addInventoryForm" class="btn btn-primary">
                    <i class="fas fa-save"></i>
                    Añadir Producto
                </button>
            </div>
        </div>
    </div>

    <!-- Add Order Modal -->
    <div id="addOrderModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Nuevo Pedido</h3>
                <button class="modal-close" onclick="closeModal('addOrderModal')">&times;</button>
            </div>
            <div class="modal-body">
                <form id="addOrderForm">
                    <div class="form-group" id="orderCenterGroup">
                        <label class="form-label">Centro *</label>
                        <select id="orderCenter" class="form-select" required>
                            <option value="">Seleccionar centro</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Productos del Pedido</label>
                        <div id="orderItems">
                            <div class="order-item" style="display: flex; gap: 8px; margin-bottom: 8px; align-items: end;">
                                <div style="flex: 1;">
                                    <label class="form-label text-xs">Producto</label>
                                    <input type="text" class="form-input order-product" placeholder="Nombre del producto" required>
                                </div>
                                <div style="width: 100px;">
                                    <label class="form-label text-xs">Cantidad</label>
                                    <input type="number" class="form-input order-quantity" placeholder="1" min="1" required>
                                </div>
                                <div style="width: 120px;">
                                    <label class="form-label text-xs">Urgencia</label>
                                    <select class="form-select order-urgency">
                                        <option value="normal">Normal</option>
                                        <option value="urgente">Urgente</option>
                                        <option value="critico">Crítico</option>
                                    </select>
                                </div>
                                <button type="button" class="btn btn-danger btn-small" onclick="removeOrderItem(this)" style="height: 38px;">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                        <button type="button" class="btn btn-outline btn-small" onclick="addOrderItem()">
                            <i class="fas fa-plus"></i>
                            Añadir Producto
                        </button>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Observaciones</label>
                        <textarea id="orderNotes" class="form-textarea" placeholder="Información adicional sobre el pedido..."></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline" onclick="closeModal('addOrderModal')">Cancelar</button>
                <button type="submit" form="addOrderForm" class="btn btn-primary">
                    <i class="fas fa-shopping-cart"></i>
                    Crear Pedido
                </button>
            </div>
        </div>
    </div>

    <!-- Edit Stock Modal -->
    <div id="editStockModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Actualizar Stock</h3>
                <button class="modal-close" onclick="closeModal('editStockModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="mb-4">
                    <h4 id="stockProductName" class="font-medium"></h4>
                    <p class="text-sm text-secondary" id="stockProductDetails"></p>
                </div>

                <form id="editStockForm">
                    <div class="form-group">
                        <label class="form-label">Stock Actual</label>
                        <div class="quantity-control">
                            <button type="button" class="quantity-btn" onclick="adjustStock(-1)">-</button>
                            <input type="number" id="stockQuantity" class="quantity-input" min="0" required>
                            <button type="button" class="quantity-btn" onclick="adjustStock(1)">+</button>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Motivo del Cambio</label>
                        <select id="stockReason" class="form-select" required>
                            <option value="">Seleccionar motivo</option>
                            <option value="recepcion">Recepción de mercancía</option>
                            <option value="consumo">Consumo normal</option>
                            <option value="caducidad">Retirada por caducidad</option>
                            <option value="rotura">Rotura o deterioro</option>
                            <option value="inventario">Ajuste de inventario</option>
                            <option value="devolucion">Devolución</option>
                            <option value="otro">Otro</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Observaciones</label>
                        <textarea id="stockNotes" class="form-textarea" placeholder="Detalles del cambio de stock..."></textarea>
                    </div>

                    <input type="hidden" id="stockItemId">
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline" onclick="closeModal('editStockModal')">Cancelar</button>
                <button type="submit" form="editStockForm" class="btn btn-primary">
                    <i class="fas fa-save"></i>
                    Actualizar Stock
                </button>
            </div>
        </div>
    </div>

    <!-- Add Event Modal -->
    <div id="addEventModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Nuevo Evento</h3>
                <button class="modal-close" onclick="closeModal('addEventModal')">&times;</button>
            </div>
            <div class="modal-body">
                <form id="addEventForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Título del Evento *</label>
                            <input type="text" id="eventTitle" class="form-input" required placeholder="Reunión con equipo">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Tipo de Evento</label>
                            <select id="eventType" class="form-select">
                                <option value="meeting">Reunión</option>
                                <option value="deadline">Fecha límite</option>
                                <option value="maintenance">Mantenimiento</option>
                                <option value="training">Capacitación</option>
                                <option value="delivery">Entrega</option>
                                <option value="other">Otro</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Fecha *</label>
                            <input type="date" id="eventDate" class="form-input" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Hora</label>
                            <input type="time" id="eventTime" class="form-input">
                        </div>
                    </div>

                    <div class="form-group" id="eventCenterGroup">
                        <label class="form-label">Centro</label>
                        <select id="eventCenter" class="form-select">
                            <option value="">Todos los centros</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Prioridad</label>
                        <select id="eventPriority" class="form-select">
                            <option value="normal">Normal</option>
                            <option value="high">Alta</option>
                            <option value="urgent">Urgente</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Descripción</label>
                        <textarea id="eventDescription" class="form-textarea" placeholder="Detalles del evento..."></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline" onclick="closeModal('addEventModal')">Cancelar</button>
                <button type="submit" form="addEventForm" class="btn btn-primary">
                    <i class="fas fa-save"></i>
                    Crear Evento
                </button>
            </div>
        </div>
    </div>

    <!-- Add Supplier Modal -->
    <div id="addSupplierModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Nuevo Proveedor</h3>
                <button class="modal-close" onclick="closeModal('addSupplierModal')">&times;</button>
            </div>
            <div class="modal-body">
                <form id="addSupplierForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Nombre de la Empresa *</label>
                            <input type="text" id="supplierName" class="form-input" required placeholder="Ej: Distribuciones Médicas S.A.">
                        </div>
                        <div class="form-group">
                            <label class="form-label">CIF/NIF *</label>
                            <input type="text" id="supplierTaxId" class="form-input" required placeholder="A12345678">
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Dirección *</label>
                        <input type="text" id="supplierAddress" class="form-input" required placeholder="Calle, número, ciudad, código postal">
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Teléfono *</label>
                            <input type="tel" id="supplierPhone" class="form-input" required placeholder="+34 900 000 000">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Email *</label>
                            <input type="email" id="supplierEmail" class="form-input" required placeholder="contacto@proveedor.com">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Persona de Contacto</label>
                            <input type="text" id="supplierContact" class="form-input" placeholder="Nombre del contacto principal">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Tiempo de Entrega (días)</label>
                            <input type="number" id="supplierDeliveryTime" class="form-input" min="1" placeholder="7">
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Categorías de Productos *</label>
                        <div class="checkbox-group" id="supplierCategories">
                            <!-- Categories will be populated by JavaScript -->
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Pedido Mínimo (€)</label>
                            <input type="number" id="supplierMinOrder" class="form-input" step="0.01" placeholder="100.00">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Descuento por Volumen (%)</label>
                            <input type="number" id="supplierDiscount" class="form-input" step="0.1" max="100" placeholder="5.0">
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Condiciones de Pago</label>
                        <select id="supplierPaymentTerms" class="form-select">
                            <option value="immediate">Pago inmediato</option>
                            <option value="15_days">15 días</option>
                            <option value="30_days">30 días</option>
                            <option value="60_days">60 días</option>
                            <option value="90_days">90 días</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Notas</label>
                        <textarea id="supplierNotes" class="form-textarea" placeholder="Información adicional sobre el proveedor..."></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline" onclick="closeModal('addSupplierModal')">Cancelar</button>
                <button type="submit" form="addSupplierForm" class="btn btn-primary">
                    <i class="fas fa-save"></i>
                    Crear Proveedor
                </button>
            </div>
        </div>
    </div>

    <!-- Create Purchase Order Modal -->
    <div id="createPurchaseOrderModal" class="modal">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h3 class="modal-title">Nueva Orden de Compra</h3>
                <button class="modal-close" onclick="closeModal('createPurchaseOrderModal')">&times;</button>
            </div>
            <div class="modal-body">
                <form id="createPurchaseOrderForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Proveedor *</label>
                            <select id="purchaseOrderSupplier" class="form-select" required>
                                <option value="">Seleccionar proveedor</option>
                            </select>
                        </div>
                        <div class="form-group" id="purchaseOrderCenterGroup">
                            <label class="form-label">Centro *</label>
                            <select id="purchaseOrderCenter" class="form-select" required>
                                <option value="">Seleccionar centro</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Productos de la Orden</label>
                        <div id="purchaseOrderItems">
                            <div class="purchase-order-item" style="display: flex; gap: 8px; margin-bottom: 8px; align-items: end; padding: 12px; border: 1px solid var(--border); border-radius: 4px;">
                                <div style="flex: 1;">
                                    <label class="form-label text-xs">Producto</label>
                                    <input type="text" class="form-input po-product" placeholder="Nombre del producto" required>
                                </div>
                                <div style="width: 100px;">
                                    <label class="form-label text-xs">Cantidad</label>
                                    <input type="number" class="form-input po-quantity" placeholder="1" min="1" required>
                                </div>
                                <div style="width: 120px;">
                                    <label class="form-label text-xs">Precio Unit. (€)</label>
                                    <input type="number" class="form-input po-price" placeholder="0.00" step="0.01" min="0" required>
                                </div>
                                <div style="width: 120px;">
                                    <label class="form-label text-xs">Total (€)</label>
                                    <input type="number" class="form-input po-total" readonly style="background: #f8f9fa;">
                                </div>
                                <button type="button" class="btn btn-danger btn-small" onclick="removePurchaseOrderItem(this)" style="height: 38px;">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                        <button type="button" class="btn btn-outline btn-small" onclick="addPurchaseOrderItem()">
                            <i class="fas fa-plus"></i>
                            Añadir Producto
                        </button>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Fecha de Entrega Esperada</label>
                            <input type="date" id="purchaseOrderDeliveryDate" class="form-input">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Total de la Orden</label>
                            <input type="text" id="purchaseOrderTotal" class="form-input" readonly style="background: #f8f9fa; font-weight: bold;" value="€0.00">
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Observaciones</label>
                        <textarea id="purchaseOrderNotes" class="form-textarea" placeholder="Información adicional sobre la orden..."></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline" onclick="closeModal('createPurchaseOrderModal')">Cancelar</button>
                <button type="submit" form="createPurchaseOrderForm" class="btn btn-primary">
                    <i class="fas fa-shopping-cart"></i>
                    Crear Orden de Compra
                </button>
            </div>
        </div>
    </div>

    <!-- Supplier Products Modal -->
    <div id="supplierProductsModal" class="modal">
        <div class="modal-content" style="max-width: 900px;">
            <div class="modal-header">
                <h3 class="modal-title">Catálogo de Productos</h3>
                <button class="modal-close" onclick="closeModal('supplierProductsModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="mb-4">
                    <h4 id="supplierProductsTitle" class="font-medium mb-2"></h4>
                    <div class="flex gap-2 mb-4">
                        <button class="btn btn-primary btn-small" id="addSupplierProductBtn">
                            <i class="fas fa-plus"></i>
                            Añadir Producto
                        </button>
                    </div>
                </div>

                <div class="table-container">
                    <table class="table" id="supplierProductsTable">
                        <thead>
                            <tr>
                                <th>Producto</th>
                                <th>Categoría</th>
                                <th>Precio</th>
                                <th>Cantidad Mínima</th>
                                <th>Tiempo Entrega</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="supplierProductsTableBody">
                            <!-- Products will be populated here -->
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline" onclick="closeModal('supplierProductsModal')">Cerrar</button>
            </div>
        </div>
    </div>

    <!-- Request Quote Modal -->
    <div id="requestQuoteModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Solicitar Cotización</h3>
                <button class="modal-close" onclick="closeModal('requestQuoteModal')">&times;</button>
            </div>
            <div class="modal-body">
                <form id="requestQuoteForm">
                    <div class="form-group">
                        <label class="form-label">Proveedores Seleccionados</label>
                        <div id="selectedSuppliersForQuote" class="checkbox-group">
                            <!-- Selected suppliers will be populated here -->
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Productos a Cotizar</label>
                        <div id="quoteItems">
                            <div class="quote-item" style="display: flex; gap: 8px; margin-bottom: 8px; align-items: end;">
                                <div style="flex: 1;">
                                    <label class="form-label text-xs">Producto</label>
                                    <input type="text" class="form-input quote-product" placeholder="Nombre del producto" required>
                                </div>
                                <div style="width: 100px;">
                                    <label class="form-label text-xs">Cantidad</label>
                                    <input type="number" class="form-input quote-quantity" placeholder="1" min="1" required>
                                </div>
                                <div style="width: 150px;">
                                    <label class="form-label text-xs">Especificaciones</label>
                                    <input type="text" class="form-input quote-specs" placeholder="Opcional">
                                </div>
                                <button type="button" class="btn btn-danger btn-small" onclick="removeQuoteItem(this)" style="height: 38px;">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                        <button type="button" class="btn btn-outline btn-small" onclick="addQuoteItem()">
                            <i class="fas fa-plus"></i>
                            Añadir Producto
                        </button>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Fecha Límite de Respuesta</label>
                            <input type="date" id="quoteDeadline" class="form-input" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Fecha de Entrega Deseada</label>
                            <input type="date" id="quoteDeliveryDate" class="form-input">
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Observaciones</label>
                        <textarea id="quoteNotes" class="form-textarea" placeholder="Información adicional para los proveedores..."></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline" onclick="closeModal('requestQuoteModal')">Cancelar</button>
                <button type="submit" form="requestQuoteForm" class="btn btn-primary">
                    <i class="fas fa-paper-plane"></i>
                    Enviar Solicitud
                </button>
            </div>
        </div>
    </div>

    <!-- Add Time Entry Modal -->
    <div id="addTimeEntryModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Nueva Entrada de Tiempo</h3>
                <button class="modal-close" onclick="closeModal('addTimeEntryModal')">&times;</button>
            </div>
            <div class="modal-body">
                <form id="addTimeEntryForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Tarea/Proyecto *</label>
                            <input type="text" id="timeEntryTask" class="form-input" required placeholder="Descripción de la tarea">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Categoría</label>
                            <select id="timeEntryCategory" class="form-select">
                                <option value="administrative">Administrativo</option>
                                <option value="operational">Operacional</option>
                                <option value="maintenance">Mantenimiento</option>
                                <option value="training">Capacitación</option>
                                <option value="meeting">Reuniones</option>
                                <option value="other">Otro</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Fecha *</label>
                            <input type="date" id="timeEntryDate" class="form-input" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Duración (horas) *</label>
                            <input type="number" id="timeEntryHours" class="form-input" step="0.25" min="0" required placeholder="1.5">
                        </div>
                    </div>

                    <div class="form-group" id="timeEntryCenterGroup">
                        <label class="form-label">Centro</label>
                        <select id="timeEntryCenter" class="form-select">
                            <option value="">Seleccionar centro</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Notas</label>
                        <textarea id="timeEntryNotes" class="form-textarea" placeholder="Detalles adicionales..."></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline" onclick="closeModal('addTimeEntryModal')">Cancelar</button>
                <button type="submit" form="addTimeEntryForm" class="btn btn-primary">
                    <i class="fas fa-save"></i>
                    Guardar Entrada
                </button>
            </div>
        </div>
    </div>

    <!-- Add Transaction Modal -->
    <div id="addTransactionModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Nueva Transacción</h3>
                <button class="modal-close" onclick="closeModal('addTransactionModal')">&times;</button>
            </div>
            <div class="modal-body">
                <form id="addTransactionForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Tipo de Transacción *</label>
                            <select id="transactionType" class="form-select" required>
                                <option value="">Seleccionar tipo</option>
                                <option value="income">Ingreso</option>
                                <option value="expense">Gasto</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Fecha *</label>
                            <input type="date" id="transactionDate" class="form-input" required>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Descripción *</label>
                        <input type="text" id="transactionDescription" class="form-input" required placeholder="Descripción de la transacción">
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Monto (€) *</label>
                            <input type="number" id="transactionAmount" class="form-input" step="0.01" min="0" required placeholder="0.00">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Categoría *</label>
                            <select id="transactionCategory" class="form-select" required>
                                <option value="">Seleccionar categoría</option>
                                <option value="supplies">Suministros</option>
                                <option value="maintenance">Mantenimiento</option>
                                <option value="utilities">Servicios</option>
                                <option value="personnel">Personal</option>
                                <option value="equipment">Equipamiento</option>
                                <option value="services">Servicios Médicos</option>
                                <option value="other">Otros</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-group" id="transactionCenterGroup">
                        <label class="form-label">Centro</label>
                        <select id="transactionCenter" class="form-select">
                            <option value="">Seleccionar centro</option>
                        </select>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Método de Pago</label>
                            <select id="transactionPaymentMethod" class="form-select">
                                <option value="cash">Efectivo</option>
                                <option value="bank_transfer">Transferencia</option>
                                <option value="card">Tarjeta</option>
                                <option value="check">Cheque</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Estado</label>
                            <select id="transactionStatus" class="form-select">
                                <option value="completed">Completado</option>
                                <option value="pending">Pendiente</option>
                                <option value="cancelled">Cancelado</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Notas</label>
                        <textarea id="transactionNotes" class="form-textarea" placeholder="Información adicional..."></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline" onclick="closeModal('addTransactionModal')">Cancelar</button>
                <button type="submit" form="addTransactionForm" class="btn btn-primary">
                    <i class="fas fa-save"></i>
                    Guardar Transacción
                </button>
            </div>
        </div>
    </div>

    <!-- Add Budget Modal -->
    <div id="addBudgetModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Nuevo Presupuesto</h3>
                <button class="modal-close" onclick="closeModal('addBudgetModal')">&times;</button>
            </div>
            <div class="modal-body">
                <form id="addBudgetForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Centro *</label>
                            <select id="budgetCenter" class="form-select" required>
                                <option value="">Seleccionar centro</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Período *</label>
                            <select id="budgetPeriod" class="form-select" required>
                                <option value="monthly">Mensual</option>
                                <option value="quarterly">Trimestral</option>
                                <option value="annual">Anual</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Fecha Inicio *</label>
                            <input type="date" id="budgetStartDate" class="form-input" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Fecha Fin *</label>
                            <input type="date" id="budgetEndDate" class="form-input" required>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Presupuesto por Categorías</label>
                        <div id="budgetCategories">
                            <div class="budget-category-item" style="display: flex; gap: 8px; margin-bottom: 8px; align-items: center; padding: 8px; border: 1px solid var(--border); border-radius: 4px;">
                                <div style="flex: 1;">
                                    <select class="form-select budget-category" required>
                                        <option value="">Seleccionar categoría</option>
                                        <option value="supplies">Suministros</option>
                                        <option value="maintenance">Mantenimiento</option>
                                        <option value="utilities">Servicios</option>
                                        <option value="personnel">Personal</option>
                                        <option value="equipment">Equipamiento</option>
                                    </select>
                                </div>
                                <div style="width: 120px;">
                                    <input type="number" class="form-input budget-amount" placeholder="€0.00" step="0.01" min="0" required>
                                </div>
                                <button type="button" class="btn btn-danger btn-small" onclick="removeBudgetCategory(this)">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                        <button type="button" class="btn btn-outline btn-small" onclick="addBudgetCategory()">
                            <i class="fas fa-plus"></i>
                            Añadir Categoría
                        </button>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Notas</label>
                        <textarea id="budgetNotes" class="form-textarea" placeholder="Información adicional sobre el presupuesto..."></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline" onclick="closeModal('addBudgetModal')">Cancelar</button>
                <button type="submit" form="addBudgetForm" class="btn btn-primary">
                    <i class="fas fa-save"></i>
                    Crear Presupuesto
                </button>
            </div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="toast"></div>

    <!-- JavaScript -->
    <script type="module">
        // Firebase imports
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js';
        import { 
            getAuth, 
            signInWithEmailAndPassword, 
            signOut, 
            onAuthStateChanged, 
            createUserWithEmailAndPassword 
        } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js';
        import { 
            getFirestore, 
            collection, 
            addDoc, 
            getDocs, 
            doc, 
            updateDoc, 
            deleteDoc, 
            query, 
            where, 
            orderBy, 
            setDoc,
            getDoc,
            limit,
            serverTimestamp 
        } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js';

        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyB0OHpzGIoKanftbiUR6GDGnm36uC5UaI0",
            authDomain: "lifelogxd.firebaseapp.com",
            projectId: "lifelogxd",
            storageBucket: "lifelogxd.firebasestorage.app",
            messagingSenderId: "831585354400",
            appId: "1:831585354400:web:c7f871519b432e95ca7fc5",
            measurementId: "G-5VZSDJNZEM"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Global State
        let currentUser = null;
        let userData = null;
        let currentScreen = 'dashboard';
        let selectedCenterId = '';
        let allCenters = [];
        let allInventoryItems = [];
        let allOrders = [];
        let allUsers = [];
        let allEvents = [];
        let allTimeEntries = [];
        let allSuppliers = [];
        let allPurchaseOrders = [];
        let allTransactions = [];
        let allBudgets = [];
        let currentCalendarDate = new Date();
        let currentAccountingTab = 'overview';
        let timerState = {
            isRunning: false,
            startTime: null,
            elapsed: 0,
            task: '',
            interval: null
        };
        let globalConfig = {
            categories: ['material_sanitario', 'alimentario', 'limpieza', 'farmacia', 'amenities', 'textil', 'mantenimiento'],
            departments: ['enfermeria', 'quirofano', 'farmacia', 'cocina', 'limpieza', 'mantenimiento', 'lavanderia', 'recepcion']
        };

        // Navigation Configuration
        const navigationConfig = {
            LIFE_ADMIN: [
                { id: 'dashboard', label: 'Dashboard', icon: 'fas fa-home' },
                { id: 'centers', label: 'Centros', icon: 'fas fa-building' },
                { id: 'users', label: 'Usuarios', icon: 'fas fa-users' },
                { id: 'inventory', label: 'Inventario', icon: 'fas fa-boxes' },
                { id: 'orders', label: 'Pedidos', icon: 'fas fa-shopping-cart' },
                { id: 'calendar', label: 'Calendario', icon: 'fas fa-calendar' },
                { id: 'timelog', label: 'Registro de Horas', icon: 'fas fa-clock' },
                { id: 'suppliers', label: 'Proveedores', icon: 'fas fa-truck' },
                { id: 'accounting', label: 'Contabilidad', icon: 'fas fa-calculator' },
                { id: 'config', label: 'Configuración', icon: 'fas fa-cog' }
            ],
            CENTER_ADMIN: [
                { id: 'dashboard', label: 'Dashboard', icon: 'fas fa-home' },
                { id: 'users', label: 'Mi Equipo', icon: 'fas fa-users' },
                { id: 'inventory', label: 'Inventario', icon: 'fas fa-boxes' },
                { id: 'orders', label: 'Pedidos', icon: 'fas fa-shopping-cart' },
                { id: 'suppliers', label: 'Proveedores', icon: 'fas fa-truck' },
                { id: 'accounting', label: 'Contabilidad', icon: 'fas fa-calculator' },
                { id: 'calendar', label: 'Calendario', icon: 'fas fa-calendar' },
                { id: 'timelog', label: 'Registro de Horas', icon: 'fas fa-clock' }
            ],
            CLIENT_VIEWER: [
                { id: 'dashboard', label: 'Dashboard', icon: 'fas fa-home' },
                { id: 'inventory', label: 'Inventario', icon: 'fas fa-boxes' },
                { id: 'orders', label: 'Pedidos', icon: 'fas fa-shopping-cart' },
                { id: 'suppliers', label: 'Consultar Proveedores', icon: 'fas fa-truck' },
                { id: 'calendar', label: 'Calendario', icon: 'fas fa-calendar' },
                { id: 'timelog', label: 'Registro de Horas', icon: 'fas fa-clock' }
            ]
        };

        // Initialize App
        function initApp() {
            setupEventListeners();
            checkAuthState();
            loadGlobalConfig();
        }

        // Event Listeners
        function setupEventListeners() {
            // Login Form
            document.getElementById('loginForm').addEventListener('submit', handleLogin);

            // Logout
            document.getElementById('logoutBtn').addEventListener('click', handleLogout);

            // Menu Toggle
            document.getElementById('menuToggle').addEventListener('click', toggleSidebar);

            // Modal Forms
            document.getElementById('addCenterForm').addEventListener('submit', handleAddCenter);
            document.getElementById('addUserForm').addEventListener('submit', handleAddUser);
            document.getElementById('addInventoryForm').addEventListener('submit', handleAddInventory);
            document.getElementById('addOrderForm').addEventListener('submit', handleAddOrder);
            document.getElementById('editStockForm').addEventListener('submit', handleEditStock);

            // Modal Buttons
            document.getElementById('addCenterBtn').addEventListener('click', () => {
                resetCenterForm();
                populateUserCenters();
                openModal('addCenterModal');
            });
            document.getElementById('addUserBtn').addEventListener('click', () => {
                resetUserForm();
                populateUserCenters();
                openModal('addUserModal');
            });
            document.getElementById('addInventoryBtn').addEventListener('click', () => {
                populateInventoryFilters();
                openModal('addInventoryModal');
            });
            document.getElementById('addOrderBtn').addEventListener('click', () => {
                populateOrderCenters();
                resetOrderItems();
                openModal('addOrderModal');
            });
            document.getElementById('addEventBtn').addEventListener('click', () => {
                populateEventCenters();
                setTodayDate('eventDate');
                openModal('addEventModal');
            });
            document.getElementById('addTimeEntryBtn').addEventListener('click', () => {
                populateTimeEntryCenters();
                setTodayDate('timeEntryDate');
                openModal('addTimeEntryModal');
            });
            document.getElementById('addSupplierBtn').addEventListener('click', () => {
                populateSupplierCategories();
                openModal('addSupplierModal');
            });
            document.getElementById('createPurchaseOrderBtn').addEventListener('click', () => {
                populatePurchaseOrderData();
                resetPurchaseOrderItems();
                openModal('createPurchaseOrderModal');
            });
            document.getElementById('addTransactionBtn').addEventListener('click', () => {
                populateTransactionCenters();
                setTodayDate('transactionDate');
                openModal('addTransactionModal');
            });
            document.getElementById('addBudgetBtn').addEventListener('click', () => {
                populateBudgetCenters();
                setDefaultBudgetDates();
                openModal('addBudgetModal');
            });

            // Center type change
            document.getElementById('centerType').addEventListener('change', handleCenterTypeChange);

            // Global center filter
            document.getElementById('globalCenterFilter').addEventListener('change', handleGlobalCenterFilter);

            // Filters
            document.getElementById('departmentFilter').addEventListener('change', filterInventory);

            // Global config
            document.getElementById('globalConfigForm').addEventListener('submit', handleGlobalConfig);
            document.getElementById('addCategoryBtn').addEventListener('click', addCategoryField);
            document.getElementById('addDepartmentBtn').addEventListener('click', addDepartmentField);

            // Calendar controls
            document.getElementById('prevMonth').addEventListener('click', () => changeMonth(-1));
            document.getElementById('nextMonth').addEventListener('click', () => changeMonth(1));
            document.getElementById('todayBtn').addEventListener('click', goToToday);

            // Time tracking
            document.getElementById('startTimer').addEventListener('click', startTimer);
            document.getElementById('pauseTimer').addEventListener('click', pauseTimer);
            document.getElementById('stopTimer').addEventListener('click', stopTimer);

            // Forms
            document.getElementById('addEventForm').addEventListener('submit', handleAddEvent);
            document.getElementById('addTimeEntryForm').addEventListener('submit', handleAddTimeEntry);
            document.getElementById('addSupplierForm').addEventListener('submit', handleAddSupplier);
            document.getElementById('createPurchaseOrderForm').addEventListener('submit', handleCreatePurchaseOrder);
            document.getElementById('requestQuoteForm').addEventListener('submit', handleRequestQuote);
            document.getElementById('addTransactionForm').addEventListener('submit', handleAddTransaction);
            document.getElementById('addBudgetForm').addEventListener('submit', handleAddBudget);

            // Filters
            document.getElementById('timelogDateFilter').addEventListener('change', filterTimeEntries);
            document.getElementById('timelogTaskFilter').addEventListener('change', filterTimeEntries);
            document.getElementById('supplierCategoryFilter').addEventListener('change', filterSuppliers);
            document.getElementById('purchaseOrderStatusFilter').addEventListener('change', filterPurchaseOrders);
            document.getElementById('transactionTypeFilter').addEventListener('change', filterTransactions);
            document.getElementById('transactionMonthFilter').addEventListener('change', filterTransactions);
        }

        // Authentication Functions
        async function handleLogin(e) {
            e.preventDefault();

            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;

            showLoading('loginLoading');

            try {
                // First try to sign in
                let userCredential;
                try {
                    userCredential = await signInWithEmailAndPassword(auth, email, password);
                } catch (authError) {
                    // If user doesn't exist and it's the admin email, create it
                    if (authError.code === 'auth/user-not-found' || authError.code === 'auth/invalid-login-credentials') {
                        if (email === 'admin@life.com' && password === 'admin123') {
                            try {
                                console.log('Creating default admin user...');
                                userCredential = await createUserWithEmailAndPassword(auth, email, password);
                                
                                // Create user document in Firestore
                                const defaultUserData = {
                                    name: 'Administrador LIFE',
                                    email: email,
                                    role: 'LIFE_ADMIN',
                                    centerIds: [],
                                    isActive: true,
                                    createdAt: serverTimestamp(),
                                    createdBy: 'system'
                                };
                                
                                await setDoc(doc(db, 'users', userCredential.user.uid), defaultUserData);
                                console.log('Default admin user created successfully');
                                showToast('Usuario administrador creado automáticamente', 'success');
                            } catch (createError) {
                                console.error('Error creating default admin:', createError);
                                throw new Error('No se pudo crear el usuario administrador: ' + createError.message);
                            }
                        } else {
                            throw new Error('Credenciales inválidas. Usa admin@life.com / admin123 para acceso inicial');
                        }
                    } else {
                        throw authError;
                    }
                }

                const user = userCredential.user;

                // Get user data from Firestore
                const userDoc = await getDoc(doc(db, 'users', user.uid));
                if (userDoc.exists()) {
                    userData = userDoc.data();
                    currentUser = user;
                    showApp();
                } else {
                    throw new Error('Usuario no encontrado en la base de datos');
                }
            } catch (error) {
                console.error('Error al iniciar sesión:', error);
                let errorMessage = 'Error al iniciar sesión';
                
                if (error.code === 'auth/invalid-login-credentials') {
                    errorMessage = 'Credenciales inválidas. Usa: admin@life.com / admin123';
                } else if (error.code === 'auth/user-not-found') {
                    errorMessage = 'Usuario no encontrado. Usa: admin@life.com / admin123';
                } else if (error.code === 'auth/wrong-password') {
                    errorMessage = 'Contraseña incorrecta. Usa: admin@life.com / admin123';
                } else if (error.code === 'auth/invalid-email') {
                    errorMessage = 'Email inválido';
                } else if (error.code === 'auth/network-request-failed') {
                    errorMessage = 'Error de conexión. Verifica tu conexión a internet';
                } else if (error.message) {
                    errorMessage = error.message;
                }
                
                showToast(errorMessage, 'error');
            } finally {
                hideLoading('loginLoading');
            }
        }

        async function handleLogout() {
            try {
                await signOut(auth);
                currentUser = null;
                userData = null;
                showLogin();
                showToast('Sesión cerrada correctamente', 'success');
            } catch (error) {
                console.error('Error al cerrar sesión:', error);
                showToast('Error al cerrar sesión', 'error');
            }
        }

        function checkAuthState() {
            onAuthStateChanged(auth, async (user) => {
                if (user && !currentUser) {
                    const userDoc = await getDoc(doc(db, 'users', user.uid));
                    if (userDoc.exists()) {
                        userData = userDoc.data();
                        currentUser = user;
                        showApp();
                    } else {
                        showLogin();
                    }
                } else if (!user) {
                    showLogin();
                }
            });
        }

        // UI Functions
        function showLogin() {
            document.getElementById('loginScreen').classList.add('active');
            document.getElementById('appScreen').classList.remove('active');
        }

        function showApp() {
            document.getElementById('loginScreen').classList.remove('active');
            document.getElementById('appScreen').classList.add('active');

            setupNavigation();
            updateUserInfo();
            setupGlobalCenterFilter();
            showScreen('dashboard');
        }

        async function setupGlobalCenterFilter() {
            try {
                let centersQuery = collection(db, 'centers');

                if (userData.role !== 'LIFE_ADMIN') {
                    centersQuery = query(centersQuery, where('id', 'in', userData.centerIds || []));
                }

                const snapshot = await getDocs(centersQuery);
                allCenters = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                const globalCenterFilter = document.getElementById('globalCenterFilter');
                globalCenterFilter.innerHTML = '<option value="">Todos los centros</option>' +
                    allCenters.map(center => `<option value="${center.id}">${center.name}</option>`).join('');

                // Si el usuario solo tiene acceso a un centro, seleccionarlo automáticamente
                if (userData.role !== 'LIFE_ADMIN' && allCenters.length === 1) {
                    selectedCenterId = allCenters[0].id;
                    globalCenterFilter.value = selectedCenterId;
                }
            } catch (error) {
                console.error('Error setting up global center filter:', error);
            }
        }

        function handleGlobalCenterFilter() {
            selectedCenterId = document.getElementById('globalCenterFilter').value;

            // Recargar datos del screen actual con el nuevo filtro
            loadScreenData(currentScreen);

            // Mostrar toast informativo
            if (selectedCenterId) {
                const selectedCenter = allCenters.find(c => c.id === selectedCenterId);
                if (selectedCenter) {
                    showToast(`Filtrando por: ${selectedCenter.name}`, 'info');
                }
            } else {
                showToast('Mostrando todos los centros', 'info');
            }
        }

        function setupNavigation() {
            const sidebarNav = document.getElementById('sidebarNav');
            const userRole = userData.role;
            const navigation = navigationConfig[userRole] || [];

            sidebarNav.innerHTML = '';

            // Main navigation
            const mainSection = document.createElement('div');
            mainSection.className = 'nav-section';

            const mainTitle = document.createElement('div');
            mainTitle.className = 'nav-section-title';
            mainTitle.textContent = 'Principal';
            mainSection.appendChild(mainTitle);

            navigation.forEach(item => {
                const navItem = document.createElement('button');
                navItem.className = 'nav-item';
                navItem.innerHTML = `<i class="${item.icon}"></i> ${item.label}`;
                navItem.onclick = () => showScreen(item.id);

                if (item.id === currentScreen) {
                    navItem.classList.add('active');
                }

                mainSection.appendChild(navItem);
            });

            sidebarNav.appendChild(mainSection);
        }

        function updateUserInfo() {
            document.getElementById('userName').textContent = userData.name || userData.email;
            document.getElementById('userRole').textContent = getRoleDisplayName(userData.role);
        }

        function getRoleDisplayName(role) {
            const roleNames = {
                'LIFE_ADMIN': 'Life Admin',
                'CENTER_ADMIN': 'Center Admin',
                'CLIENT_VIEWER': 'Client Viewer'
            };
            return roleNames[role] || role;
        }

        function showScreen(screenId) {
            // Update navigation
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
                if (item.onclick.toString().includes(screenId)) {
                    item.classList.add('active');
                }
            });

            // Update content
            document.querySelectorAll('.screen-content').forEach(content => {
                content.classList.remove('active');
            });

            const targetContent = document.getElementById(screenId + 'Content');
            if (targetContent) {
                targetContent.classList.add('active');
            }

            // Update page title
            const pageTitle = document.getElementById('pageTitle');
            const pageTitles = {
                'dashboard': 'Dashboard',
                'centers': 'Gestión de Centros',
                'users': 'Gestión de Usuarios',
                'inventory': 'Inventario',
                'orders': 'Pedidos',
                'suppliers': 'Gestión de Proveedores',
                'calendar': 'Calendario',
                'timelog': 'Registro de Horas',
                'accounting': 'Contabilidad',
                'config': 'Configuración'
            };
            pageTitle.textContent = pageTitles[screenId] || 'LIFE ERP';

            currentScreen = screenId;

            // Load data for the screen
            loadScreenData(screenId);

            // Close sidebar on mobile
            if (window.innerWidth <= 768) {
                document.getElementById('sidebar').classList.remove('show');
            }
        }

        async function loadScreenData(screenId) {
            switch (screenId) {
                case 'dashboard':
                    loadDashboard();
                    break;
                case 'centers':
                    loadCenters();
                    break;
                case 'users':
                    loadUsers();
                    break;
                case 'inventory':
                    loadInventory();
                    break;
                case 'orders':
                    loadOrders();
                    break;
                case 'calendar':
                    loadCalendar();
                    break;
                case 'timelog':
                    loadTimeLog();
                    break;
                case 'suppliers':
                    loadSuppliers();
                    break;
                case 'accounting':
                    loadAccounting();
                    break;
                case 'config':
                    loadConfiguration();
                    break;
            }
        }

        // Dashboard Functions
        async function loadDashboard() {
            try {
                const stats = await getDashboardStats();
                renderDashboardStats(stats);

                const activity = await getRecentActivity();
                renderActivitySummary(activity);

                const alerts = await getAlerts();
                renderAlerts(alerts);
            } catch (error) {
                console.error('Error loading dashboard:', error);
                showToast('Error al cargar el dashboard', 'error');
            }
        }

        async function getDashboardStats() {
            const stats = {
                totalCenters: 0,
                totalUsers: 0,
                totalOrders: 0,
                criticalStock: 0
            };

            try {
                // Get centers
                let centersQuery = collection(db, 'centers');
                if (userData.role !== 'LIFE_ADMIN') {
                    centersQuery = query(centersQuery, where('id', 'in', userData.centerIds || []));
                }
                const centersSnapshot = await getDocs(centersQuery);
                stats.totalCenters = centersSnapshot.size;

                // Get users
                if (userData.role === 'LIFE_ADMIN') {
                    const usersSnapshot = await getDocs(collection(db, 'users'));
                    stats.totalUsers = usersSnapshot.size;
                }

                // Get orders
                let ordersQuery = collection(db, 'orders');
                if (userData.role !== 'LIFE_ADMIN') {
                    ordersQuery = query(ordersQuery, where('centerId', 'in', userData.centerIds || []));
                }
                const ordersSnapshot = await getDocs(ordersQuery);
                stats.totalOrders = ordersSnapshot.size;

                // Get critical stock items
                let inventoryQuery = collection(db, 'inventory');
                if (userData.role !== 'LIFE_ADMIN') {
                    inventoryQuery = query(inventoryQuery, where('centerId', 'in', userData.centerIds || []));
                }
                const inventorySnapshot = await getDocs(inventoryQuery);
                stats.criticalStock = inventorySnapshot.docs.filter(doc => {
                    const data = doc.data();
                    return data.currentStock <= data.minStock;
                }).length;

            } catch (error) {
                console.error('Error getting dashboard stats:', error);
            }

            return stats;
        }

        function renderDashboardStats(stats) {
            const statsGrid = document.getElementById('dashboardStats');
            statsGrid.innerHTML = `
                <div class="stat-card">
                    <span class="stat-number">${stats.totalCenters}</span>
                    <div class="stat-label">Centros</div>
                </div>
                <div class="stat-card">
                    <span class="stat-number">${stats.totalUsers}</span>
                    <div class="stat-label">Usuarios</div>
                </div>
                <div class="stat-card">
                    <span class="stat-number">${stats.totalOrders}</span>
                    <div class="stat-label">Pedidos</div>
                </div>
                <div class="stat-card">
                    <span class="stat-number stock-critical">${stats.criticalStock}</span>
                    <div class="stat-label">Stock Crítico</div>
                </div>
            `;
        }

        async function getRecentActivity() {
            try {
                let ordersQuery = query(
                    collection(db, 'orders'),
                    orderBy('createdAt', 'desc'),
                    limit(5)
                );

                if (userData.role !== 'LIFE_ADMIN') {
                    ordersQuery = query(
                        collection(db, 'orders'),
                        where('centerId', 'in', userData.centerIds || []),
                        orderBy('createdAt', 'desc'),
                        limit(5)
                    );
                }

                const snapshot = await getDocs(ordersQuery);
                return snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            } catch (error) {
                console.error('Error getting recent activity:', error);
                return [];
            }
        }

        function renderActivitySummary(activity) {
            const container = document.getElementById('activitySummary');

            if (activity.length === 0) {
                container.innerHTML = '<p class="text-center text-secondary">No hay actividad reciente</p>';
                return;
            }

            container.innerHTML = activity.map(order => `
                <div style="padding: 8px 0; border-bottom: 1px solid var(--border);">
                    <div class="flex justify-between items-center">
                        <div>
                            <strong>Pedido #${order.id.substring(0, 8)}</strong>
                            <span class="badge badge-${order.status}">${getStatusDisplayName(order.status)}</span>
                        </div>
                        <div class="text-sm text-secondary">
                            ${formatDate(order.createdAt)}
                        </div>
                    </div>
                </div>
            `).join('');
        }

        async function getAlerts() {
            const alerts = [];

            try {
                // Check for critical stock
                let inventoryQuery = collection(db, 'inventory');
                if (userData.role !== 'LIFE_ADMIN') {
                    inventoryQuery = query(inventoryQuery, where('centerId', 'in', userData.centerIds || []));
                }

                const inventorySnapshot = await getDocs(inventoryQuery);
                inventorySnapshot.forEach(doc => {
                    const data = doc.data();
                    if (data.currentStock <= data.minStock) {
                        alerts.push({
                            type: 'warning',
                            message: `Stock bajo: ${data.productName} en ${data.centerName}`,
                            timestamp: new Date()
                        });
                    }

                    // Check expiry dates
                    if (data.expiryDate) {
                        const expiryDate = new Date(data.expiryDate);
                        const now = new Date();
                        const daysUntilExpiry = Math.ceil((expiryDate - now) / (1000 * 60 * 60 * 24));

                        if (daysUntilExpiry <= 7 && daysUntilExpiry > 0) {
                            alerts.push({
                                type: 'error',
                                message: `${data.productName} vence en ${daysUntilExpiry} días`,
                                timestamp: new Date()
                            });
                        }
                    }
                });

                // Check for pending orders
                let ordersQuery = query(collection(db, 'orders'), where('status', '==', 'pending'));
                if (userData.role !== 'LIFE_ADMIN') {
                    ordersQuery = query(
                        collection(db, 'orders'),
                        where('centerId', 'in', userData.centerIds || []),
                        where('status', '==', 'pending')
                    );
                }

                const ordersSnapshot = await getDocs(ordersQuery);
                if (ordersSnapshot.size > 0) {
                    alerts.push({
                        type: 'info',
                        message: `${ordersSnapshot.size} pedidos pendientes de aprobación`,
                        timestamp: new Date()
                    });
                }

            } catch (error) {
                console.error('Error getting alerts:', error);
            }

            return alerts.slice(0, 5); // Limit to 5 alerts
        }

        function renderAlerts(alerts) {
            const container = document.getElementById('alertsList');

            if (alerts.length === 0) {
                container.innerHTML = '<p class="text-center text-secondary">Sin alertas pendientes</p>';
                return;
            }

            container.innerHTML = alerts.map(alert => `
                <div style="padding: 8px 0; border-bottom: 1px solid var(--border);">
                    <div class="flex items-center gap-2">
                        <i class="fas fa-${getAlertIcon(alert.type)}" style="color: var(--${alert.type === 'info' ? 'primary' : alert.type});"></i>
                        <span class="text-sm">${alert.message}</span>
                    </div>
                </div>
            `).join('');
        }

        function getAlertIcon(type) {
            const icons = {
                'error': 'exclamation-triangle',
                'warning': 'exclamation-circle',
                'info': 'info-circle'
            };
            return icons[type] || 'info-circle';
        }

        // Centers Functions
        async function loadCenters() {
            showLoading('centersLoading');

            try {
                let centersQuery = collection(db, 'centers');

                if (userData.role !== 'LIFE_ADMIN') {
                    centersQuery = query(centersQuery, where('id', 'in', userData.centerIds || []));
                }

                const snapshot = await getDocs(centersQuery);
                const centers = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                renderCenters(centers);
            } catch (error) {
                console.error('Error loading centers:', error);
                showToast('Error al cargar centros', 'error');
            } finally {
                hideLoading('centersLoading');
            }
        }

        function renderCenters(centers) {
            const centersGrid = document.getElementById('centersGrid');

            if (centers.length === 0) {
                centersGrid.innerHTML = '<p class="text-center text-secondary">No hay centros registrados</p>';
                return;
            }

            centersGrid.innerHTML = centers.map(center => `
                <div class="center-card">
                    <div class="center-header">
                        <div>
                            <div class="center-name">${center.name}</div>
                            <div class="center-type">${center.type}</div>
                        </div>
                        <span class="badge badge-${center.isActive ? 'active' : 'inactive'}">
                            ${center.isActive ? 'Activo' : 'Inactivo'}
                        </span>
                    </div>
                    <div class="center-details">
                        <p><i class="fas fa-map-marker-alt"></i> ${center.address}</p>
                        ${center.phone ? `<p><i class="fas fa-phone"></i> ${center.phone}</p>` : ''}
                        ${center.email ? `<p><i class="fas fa-envelope"></i> ${center.email}</p>` : ''}
                        <p><i class="fas fa-building"></i> ${center.departments?.join(', ') || 'Sin departamentos'}</p>
                    </div>
                    <div class="center-actions">
                        ${userData.role === 'LIFE_ADMIN' ? `
                            <button class="btn btn-small btn-outline" onclick="editCenter('${center.id}')">
                                <i class="fas fa-edit"></i> Editar
                            </button>
                            <button class="btn btn-small ${center.isActive ? 'btn-warning' : 'btn-success'}" 
                                    onclick="toggleCenterStatus('${center.id}', ${!center.isActive})">
                                <i class="fas fa-${center.isActive ? 'pause' : 'play'}"></i>
                                ${center.isActive ? 'Desactivar' : 'Activar'}
                            </button>
                        ` : ''}
                        <button class="btn btn-small btn-primary" onclick="viewCenterDetails('${center.id}')">
                            <i class="fas fa-eye"></i> Ver
                        </button>
                    </div>
                </div>
            `).join('');
        }

        async function handleAddCenter(e) {
            e.preventDefault();

            if (userData.role !== 'LIFE_ADMIN') {
                showToast('No tienes permisos para crear centros', 'error');
                return;
            }

            const departments = Array.from(document.querySelectorAll('#centerDepartments input:checked'))
                .map(input => input.value);

            if (departments.length === 0) {
                showToast('Selecciona al menos un departamento', 'error');
                return;
            }

            const centerData = {
                name: document.getElementById('centerName').value.trim(),
                type: document.getElementById('centerType').value,
                address: document.getElementById('centerAddress').value.trim(),
                phone: document.getElementById('centerPhone').value.trim(),
                email: document.getElementById('centerEmail').value.trim(),
                departments: departments,
                adminId: document.getElementById('centerAdmin').value,
                isActive: true,
                createdAt: serverTimestamp(),
                createdBy: currentUser.uid,
                notes: document.getElementById('centerNotes').value.trim()
            };

            try {
                const docRef = await addDoc(collection(db, 'centers'), centerData);

                // Update center document with its own ID
                await updateDoc(doc(db, 'centers', docRef.id), {
                    id: docRef.id
                });

                showToast('Centro creado correctamente', 'success');
                closeModal('addCenterModal');
                resetCenterForm();
                loadCenters();
                setupGlobalCenterFilter(); // Refresh global filter

                // Reset form
                document.getElementById('addCenterForm').reset();
            } catch (error) {
                console.error('Error creating center:', error);
                showToast('Error al crear centro', 'error');
            }
        }

        function handleCenterTypeChange() {
            const centerType = document.getElementById('centerType').value;
            const departmentsContainer = document.getElementById('centerDepartments');

            // Default departments by center type
            const defaultDepartments = {
                'CLINICA': ['enfermeria', 'quirofano', 'farmacia', 'limpieza', 'mantenimiento'],
                'RESIDENCIA': ['enfermeria', 'cocina', 'limpieza', 'lavanderia', 'mantenimiento'],
                'HOTEL': ['recepcion', 'limpieza', 'lavanderia', 'mantenimiento', 'cocina']
            };

            const departments = defaultDepartments[centerType] || globalConfig.departments;

            departmentsContainer.innerHTML = departments.map(dept => `
                <div class="checkbox-item">
                    <input type="checkbox" value="${dept}" id="dept_${dept}" ${departments.includes(dept) ? 'checked' : ''}>
                    <label for="dept_${dept}">${formatDepartmentName(dept)}</label>
                </div>
            `).join('');
        }

        async function toggleCenterStatus(centerId, newStatus) {
            try {
                await updateDoc(doc(db, 'centers', centerId), {
                    isActive: newStatus,
                    updatedAt: serverTimestamp()
                });

                showToast(`Centro ${newStatus ? 'activado' : 'desactivado'} correctamente`, 'success');
                loadCenters();
            } catch (error) {
                console.error('Error updating center status:', error);
                showToast('Error al actualizar estado del centro', 'error');
            }
        }

        // Users Functions
        async function loadUsers() {
            showLoading('usersLoading');

            try {
                let usersQuery = collection(db, 'users');

                // Filter users based on role and global center filter
                if (selectedCenterId) {
                    usersQuery = query(usersQuery, where('centerIds', 'array-contains', selectedCenterId));
                } else if (userData.role === 'CENTER_ADMIN') {
                    // Center admins can only see users from their centers
                    usersQuery = query(usersQuery, where('centerIds', 'array-contains-any', userData.centerIds || []));
                }

                const snapshot = await getDocs(usersQuery);
                allUsers = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                renderUsers(allUsers);
                populateUserCenters();
            } catch (error) {
                console.error('Error loading users:', error);
                showToast('Error al cargar usuarios', 'error');
            } finally {
                hideLoading('usersLoading');
            }
        }

        function renderUsers(users) {
            const usersTableBody = document.getElementById('usersTableBody');

            if (users.length === 0) {
                usersTableBody.innerHTML = '<tr><td colspan="6" class="text-center text-secondary">No hay usuarios registrados</td></tr>';
                return;
            }

            usersTableBody.innerHTML = users.map(user => `
                <tr>
                    <td>${user.name || 'Sin nombre'}</td>
                    <td>${user.email}</td>
                    <td><span class="badge badge-active">${getRoleDisplayName(user.role)}</span></td>
                    <td>${user.centerIds?.length || 0} centros</td>
                    <td><span class="badge badge-active">Activo</span></td>
                    <td>
                        <div class="flex gap-1">
                            ${userData.role === 'LIFE_ADMIN' || canManageUser(user) ? `
                                <button class="btn btn-small btn-outline" onclick="editUser('${user.id}')">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn btn-small btn-danger" onclick="deleteUser('${user.id}')">
                                    <i class="fas fa-trash"></i>
                                </button>
                            ` : ''}
                            <button class="btn btn-small btn-primary" onclick="viewUser('${user.id}')">
                                <i class="fas fa-eye"></i>
                            </button>
                        </div>
                    </td>
                </tr>
            `).join('');
        }

        function canManageUser(user) {
            if (userData.role === 'LIFE_ADMIN') return true;
            if (userData.role === 'CENTER_ADMIN') {
                // Center admins can manage users from their centers
                return user.centerIds?.some(centerId => userData.centerIds?.includes(centerId));
            }
            return false;
        }

        async function populateUserCenters() {
            try {
                let centersQuery = collection(db, 'centers');

                if (userData.role !== 'LIFE_ADMIN') {
                    centersQuery = query(centersQuery, where('id', 'in', userData.centerIds || []));
                }

                const snapshot = await getDocs(centersQuery);
                const centers = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                const userCentersContainer = document.getElementById('userCenters');
                userCentersContainer.innerHTML = centers.map(center => `
                    <div class="checkbox-item">
                        <input type="checkbox" value="${center.id}" id="center_${center.id}">
                        <label for="center_${center.id}">${center.name}</label>
                    </div>
                `).join('');

                // Also populate center admin select
                const centerAdminSelect = document.getElementById('centerAdmin');
                centerAdminSelect.innerHTML = '<option value="">Seleccionar administrador</option>' +
                    centers.map(center => `<option value="${center.id}">${center.name}</option>`).join('');

            } catch (error) {
                console.error('Error populating centers:', error);
            }
        }

        async function handleAddUser(e) {
            e.preventDefault();

            if (userData.role !== 'LIFE_ADMIN' && userData.role !== 'CENTER_ADMIN') {
                showToast('No tienes permisos para crear usuarios', 'error');
                return;
            }

            const selectedCenters = Array.from(document.querySelectorAll('#userCenters input:checked'))
                .map(input => input.value);

            const email = document.getElementById('userEmail').value.trim();
            const password = document.getElementById('userPassword').value;
            const name = document.getElementById('userName').value.trim();

            // Validation
            if (!email || !password || !name) {
                showToast('Completa todos los campos obligatorios', 'error');
                return;
            }

            if (password.length < 6) {
                showToast('La contraseña debe tener al menos 6 caracteres', 'error');
                return;
            }

            const newUserData = {
                name: name,
                email: email,
                role: document.getElementById('userRole').value,
                centerIds: selectedCenters,
                department: document.getElementById('userDepartment').value,
                createdAt: serverTimestamp(),
                createdBy: currentUser.uid,
                isActive: true
            };

            // Validate that center admin can only create users for their centers
            if (userData.role === 'CENTER_ADMIN') {
                const invalidCenters = selectedCenters.filter(centerId => !userData.centerIds?.includes(centerId));
                if (invalidCenters.length > 0) {
                    showToast('Solo puedes crear usuarios para tus centros asignados', 'error');
                    return;
                }
            }

            try {
                // Create user in Firebase Auth with temporary auth context
                const tempAuth = getAuth();
                const userCredential = await createUserWithEmailAndPassword(tempAuth, email, password);
                const newUser = userCredential.user;

                // Create user document in Firestore
                await setDoc(doc(db, 'users', newUser.uid), newUserData);

                // Sign out the newly created user to avoid affecting current session
                await signOut(tempAuth);

                showToast('Usuario creado correctamente', 'success');
                closeModal('addUserModal');
                loadUsers();

                // Reset form
                document.getElementById('addUserForm').reset();
            } catch (error) {
                console.error('Error creating user:', error);
                let errorMessage = 'Error al crear usuario';

                if (error.code === 'auth/email-already-in-use') {
                    errorMessage = 'El email ya está en uso';
                } else if (error.code === 'auth/weak-password') {
                    errorMessage = 'La contraseña es muy débil (mínimo 6 caracteres)';
                } else if (error.code === 'auth/invalid-email') {
                    errorMessage = 'Email inválido';
                } else if (error.code === 'invalid-argument') {
                    errorMessage = 'Datos inválidos. Verifica todos los campos';
                }

                showToast(errorMessage, 'error');
            }
        }

        // Inventory Functions
        async function loadInventory() {
            showLoading('inventoryLoading');

            try {
                let inventoryQuery = collection(db, 'inventory');

                // Aplicar filtro global de centro si está seleccionado
                if (selectedCenterId) {
                    inventoryQuery = query(inventoryQuery, where('centerId', '==', selectedCenterId));
                } else if (userData.role !== 'LIFE_ADMIN') {
                    inventoryQuery = query(inventoryQuery, where('centerId', 'in', userData.centerIds || []));
                }

                const snapshot = await getDocs(inventoryQuery);
                allInventoryItems = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                renderInventory(allInventoryItems);
                populateInventoryFilters();
            } catch (error) {
                console.error('Error loading inventory:', error);
                showToast('Error al cargar inventario', 'error');
            } finally {
                hideLoading('inventoryLoading');
            }
        }

        function renderInventory(inventory) {
            const inventoryTableBody = document.getElementById('inventoryTableBody');

            if (inventory.length === 0) {
                inventoryTableBody.innerHTML = '<tr><td colspan="8" class="text-center text-secondary">No hay productos en inventario</td></tr>';
                return;
            }

            inventoryTableBody.innerHTML = inventory.map(item => {
                const stockStatus = getStockStatus(item.currentStock, item.minStock, item.maxStock);
                const expiryStatus = getExpiryStatus(item.expiryDate);

                return `
                    <tr>
                        <td>
                            <strong>${item.productName}</strong>
                            <br><small class="text-secondary">${formatCategoryName(item.category)}</small>
                        </td>
                        <td>${item.centerName || 'Sin asignar'}</td>
                        <td>${formatDepartmentName(item.department)}</td>
                        <td>
                            <span class="${stockStatus.class}">${item.currentStock}</span>
                            <div class="quantity-control mt-1">
                                <button class="quantity-btn" onclick="adjustInventoryStock('${item.id}', -1)">-</button>
                                <span style="min-width: 40px; text-align: center; display: inline-block;">${item.currentStock}</span>
                                <button class="quantity-btn" onclick="adjustInventoryStock('${item.id}', 1)">+</button>
                            </div>
                        </td>
                        <td>${item.minStock} / ${item.maxStock}</td>
                        <td>
                            ${item.expiryDate ? `
                                <span class="${expiryStatus.class}">${formatDate(item.expiryDate)}</span>
                                <br><small>${expiryStatus.message}</small>
                            ` : 'Sin fecha'}
                        </td>
                        <td>
                            <span class="badge badge-${stockStatus.badge}">${stockStatus.label}</span>
                        </td>
                        <td>
                            <div class="flex gap-1">
                                <button class="btn btn-small btn-primary" onclick="editStock('${item.id}')">
                                    <i class="fas fa-edit"></i>
                                </button>
                                ${userData.role === 'LIFE_ADMIN' ? `
                                    <button class="btn btn-small btn-danger" onclick="deleteInventoryItem('${item.id}')">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                ` : ''}
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function getStockStatus(current, min, max) {
            if (current <= min) {
                return { class: 'stock-critical', badge: 'inactive', label: 'Crítico' };
            } else if (current <= min * 1.5) {
                return { class: 'stock-low', badge: 'pending', label: 'Bajo' };
            } else {
                return { class: 'stock-good', badge: 'active', label: 'Normal' };
            }
        }

        function getExpiryStatus(expiryDate) {
            if (!expiryDate) return { class: '', message: '' };

            const expiry = new Date(expiryDate);
            const now = new Date();
            const daysUntilExpiry = Math.ceil((expiry - now) / (1000 * 60 * 60 * 24));

            if (daysUntilExpiry < 0) {
                return { class: 'stock-critical', message: 'Vencido' };
            } else if (daysUntilExpiry <= 7) {
                return { class: 'stock-critical', message: `Vence en ${daysUntilExpiry} días` };
            } else if (daysUntilExpiry <= 30) {
                return { class: 'stock-low', message: `Vence en ${daysUntilExpiry} días` };
            } else {
                return { class: 'stock-good', message: `Vence en ${daysUntilExpiry} días` };
            }
        }

        async function populateInventoryFilters() {
            try {
                // Configurar modal según filtro global
                const inventoryCenterRow = document.getElementById('inventoryCenterRow');
                const inventoryDepartmentOnly = document.getElementById('inventoryDepartmentOnly');
                const inventoryCenter = document.getElementById('inventoryCenter');

                if (selectedCenterId) {
                    // Si hay un centro seleccionado globalmente, ocultar selector de centro
                    inventoryCenterRow.style.display = 'none';
                    inventoryDepartmentOnly.style.display = 'block';

                    // Pre-seleccionar el centro
                    inventoryCenter.value = selectedCenterId;
                } else {
                    // Mostrar selector de centro
                    inventoryCenterRow.style.display = 'flex';
                    inventoryDepartmentOnly.style.display = 'none';

                    // Populate inventory center select in modal
                    inventoryCenter.innerHTML = '<option value="">Seleccionar centro</option>' +
                        allCenters.map(center => `<option value="${center.id}">${center.name}</option>`).join('');
                }

                // Populate categories in modal
                const inventoryCategory = document.getElementById('inventoryCategory');
                inventoryCategory.innerHTML = '<option value="">Seleccionar categoría</option>' +
                    globalConfig.categories.map(cat => `<option value="${cat}">${formatCategoryName(cat)}</option>`).join('');

                // Populate departments in modal
                const inventoryDepartmentSelect = document.getElementById('inventoryDepartment');
                const inventoryDepartmentAlt = document.getElementById('inventoryDepartmentAlt');

                const departmentOptions = '<option value="">Seleccionar departamento</option>' +
                    globalConfig.departments.map(dept => `<option value="${dept}">${formatDepartmentName(dept)}</option>`).join('');

                inventoryDepartmentSelect.innerHTML = departmentOptions;
                inventoryDepartmentAlt.innerHTML = departmentOptions;

            } catch (error) {
                console.error('Error populating inventory filters:', error);
            }
        }

        async function handleAddInventory(e) {
            e.preventDefault();

            // Determinar centro y departamento según el filtro global
            const centerId = selectedCenterId || document.getElementById('inventoryCenter').value;
            const department = selectedCenterId ? 
                document.getElementById('inventoryDepartmentAlt').value : 
                document.getElementById('inventoryDepartment').value;

            // Validation
            if (!centerId) {
                showToast('Selecciona un centro', 'error');
                return;
            }

            if (!department) {
                showToast('Selecciona un departamento', 'error');
                return;
            }

            const productName = document.getElementById('inventoryProduct').value.trim();
            const category = document.getElementById('inventoryCategory').value;
            const currentStock = parseInt(document.getElementById('inventoryStock').value) || 0;
            const minStock = parseInt(document.getElementById('inventoryMinStock').value) || 0;
            const maxStock = parseInt(document.getElementById('inventoryMaxStock').value) || 0;

            if (!productName || !category) {
                showToast('Completa todos los campos obligatorios', 'error');
                return;
            }

            if (maxStock <= minStock) {
                showToast('El stock máximo debe ser mayor al stock mínimo', 'error');
                return;
            }

            const inventoryData = {
                centerId: centerId,
                department: department,
                productName: productName,
                category: category,
                currentStock: currentStock,
                minStock: minStock,
                maxStock: maxStock,
                expiryDate: document.getElementById('inventoryExpiry').value || null,
                lot: document.getElementById('inventoryLot').value.trim(),
                location: document.getElementById('inventoryLocation').value.trim(),
                notes: document.getElementById('inventoryNotes').value.trim(),
                createdAt: serverTimestamp(),
                createdBy: currentUser.uid,
                lastUpdated: serverTimestamp()
            };

            // Get center name
            try {
                const centerDoc = await getDoc(doc(db, 'centers', inventoryData.centerId));
                if (centerDoc.exists()) {
                    inventoryData.centerName = centerDoc.data().name;
                }
            } catch (error) {
                console.error('Error getting center name:', error);
                inventoryData.centerName = 'Centro desconocido';
            }

            try {
                await addDoc(collection(db, 'inventory'), inventoryData);

                showToast('Producto añadido al inventario correctamente', 'success');
                closeModal('addInventoryModal');
                loadInventory();

                // Reset form
                document.getElementById('addInventoryForm').reset();
            } catch (error) {
                console.error('Error adding inventory item:', error);
                showToast('Error al añadir producto al inventario: ' + error.message, 'error');
            }
        }

        async function adjustInventoryStock(itemId, adjustment) {
            try {
                const itemRef = doc(db, 'inventory', itemId);
                const itemDoc = await getDoc(itemRef);

                if (itemDoc.exists()) {
                    const currentData = itemDoc.data();
                    const newStock = Math.max(0, currentData.currentStock + adjustment);

                    await updateDoc(itemRef, {
                        currentStock: newStock,
                        lastUpdated: serverTimestamp()
                    });

                    loadInventory(); // Reload to show updated stock
                }
            } catch (error) {
                console.error('Error adjusting stock:', error);
                showToast('Error al ajustar stock', 'error');
            }
        }

        async function editStock(itemId) {
            try {
                const itemDoc = await getDoc(doc(db, 'inventory', itemId));
                if (itemDoc.exists()) {
                    const itemData = itemDoc.data();

                    // Populate modal with current data
                    document.getElementById('stockProductName').textContent = itemData.productName;
                    document.getElementById('stockProductDetails').textContent = 
                        `${itemData.centerName || 'Sin centro'} - ${formatDepartmentName(itemData.department)}`;
                    document.getElementById('stockQuantity').value = itemData.currentStock;
                    document.getElementById('stockItemId').value = itemId;

                    openModal('editStockModal');
                }
            } catch (error) {
                console.error('Error loading item for edit:', error);
                showToast('Error al cargar producto', 'error');
            }
        }

        async function handleEditStock(e) {
            e.preventDefault();

            const itemId = document.getElementById('stockItemId').value;
            const newStock = parseInt(document.getElementById('stockQuantity').value);
            const reason = document.getElementById('stockReason').value;
            const notes = document.getElementById('stockNotes').value;

            try {
                await updateDoc(doc(db, 'inventory', itemId), {
                    currentStock: newStock,
                    lastUpdated: serverTimestamp(),
                    lastUpdateReason: reason,
                    lastUpdateNotes: notes,
                    lastUpdatedBy: currentUser.uid
                });

                showToast('Stock actualizado correctamente', 'success');
                closeModal('editStockModal');
                loadInventory();

                // Reset form
                e.target.reset();
            } catch (error) {
                console.error('Error updating stock:', error);
                showToast('Error al actualizar stock', 'error');
            }
        }

        function adjustStock(adjustment) {
            const stockInput = document.getElementById('stockQuantity');
            const currentValue = parseInt(stockInput.value) || 0;
            const newValue = Math.max(0, currentValue + adjustment);
            stockInput.value = newValue;
        }

        function filterInventory() {
            const departmentFilter = document.getElementById('departmentFilter').value;

            const rows = document.querySelectorAll('#inventoryTableBody tr');

            rows.forEach(row => {
                let shouldShow = true;

                if (departmentFilter) {
                    const departmentCell = row.cells[2]?.textContent || '';
                    shouldShow = shouldShow && departmentCell.toLowerCase().includes(departmentFilter);
                }

                row.style.display = shouldShow ? '' : 'none';
            });
        }

        // Orders Functions
        async function loadOrders() {
            showLoading('ordersLoading');

            try {
                let ordersQuery = query(collection(db, 'orders'), orderBy('createdAt', 'desc'));

                // Aplicar filtro global de centro si está seleccionado
                if (selectedCenterId) {
                    ordersQuery = query(
                        collection(db, 'orders'),
                        where('centerId', '==', selectedCenterId),
                        orderBy('createdAt', 'desc')
                    );
                } else if (userData.role !== 'LIFE_ADMIN') {
                    ordersQuery = query(
                        collection(db, 'orders'),
                        where('centerId', 'in', userData.centerIds || []),
                        orderBy('createdAt', 'desc')
                    );
                }

                const snapshot = await getDocs(ordersQuery);
                allOrders = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                renderOrders(allOrders);
                populateOrderCenters();
            } catch (error) {
                console.error('Error loading orders:', error);
                showToast('Error al cargar pedidos', 'error');
            } finally {
                hideLoading('ordersLoading');
            }
        }

        function renderOrders(orders) {
            const ordersTableBody = document.getElementById('ordersTableBody');

            if (orders.length === 0) {
                ordersTableBody.innerHTML = '<tr><td colspan="7" class="text-center text-secondary">No hay pedidos registrados</td></tr>';
                return;
            }

            ordersTableBody.innerHTML = orders.map(order => `
                <tr>
                    <td>#${order.id.substring(0, 8)}</td>
                    <td>${order.centerName || 'Sin asignar'}</td>
                    <td>${formatDate(order.createdAt)}</td>
                    <td>${formatCurrency(order.totalAmount || 0)}</td>
                    <td><span class="badge badge-${order.status}">${getStatusDisplayName(order.status)}</span></td>
                    <td>${order.createdByName || 'Sistema'}</td>
                    <td>
                        <div class="flex gap-1">
                            <button class="btn btn-small btn-primary" onclick="viewOrder('${order.id}')">
                                <i class="fas fa-eye"></i>
                            </button>
                            ${canManageOrder(order) ? `
                                <button class="btn btn-small btn-outline" onclick="editOrder('${order.id}')">
                                    <i class="fas fa-edit"></i>
                                </button>
                                ${order.status === 'pending' ? `
                                    <button class="btn btn-small btn-success" onclick="approveOrder('${order.id}')">
                                        <i class="fas fa-check"></i>
                                    </button>
                                ` : ''}
                            ` : ''}
                        </div>
                    </td>
                </tr>
            `).join('');
        }

        function canManageOrder(order) {
            if (userData.role === 'LIFE_ADMIN') return true;
            if (userData.role === 'CENTER_ADMIN') {
                return userData.centerIds?.includes(order.centerId);
            }
            return false;
        }

        async function populateOrderCenters() {
            try {
                const orderCenterGroup = document.getElementById('orderCenterGroup');
                const orderCenter = document.getElementById('orderCenter');

                if (selectedCenterId) {
                    // Si hay un centro seleccionado globalmente, ocultar selector y pre-seleccionar
                    orderCenterGroup.style.display = 'none';
                    orderCenter.value = selectedCenterId;

                    // Marcar como no requerido ya que está oculto
                    orderCenter.removeAttribute('required');
                } else {
                    // Mostrar selector de centro
                    orderCenterGroup.style.display = 'block';
                    orderCenter.setAttribute('required', '');

                    orderCenter.innerHTML = '<option value="">Seleccionar centro</option>' +
                        allCenters.map(center => `<option value="${center.id}">${center.name}</option>`).join('');
                }

            } catch (error) {
                console.error('Error populating order centers:', error);
            }
        }

        async function handleAddOrder(e) {
            e.preventDefault();

            const centerId = selectedCenterId || document.getElementById('orderCenter').value;

            if (!centerId) {
                showToast('Selecciona un centro', 'error');
                return;
            }

            const orderItems = [];

            // Collect order items
            document.querySelectorAll('.order-item').forEach(item => {
                const product = item.querySelector('.order-product').value.trim();
                const quantity = parseInt(item.querySelector('.order-quantity').value) || 0;
                const urgency = item.querySelector('.order-urgency').value;

                if (product && quantity > 0) {
                    orderItems.push({
                        productName: product,
                        quantity: quantity,
                        urgency: urgency
                    });
                }
            });

            if (orderItems.length === 0) {
                showToast('Añade al menos un producto al pedido', 'error');
                return;
            }

            // Calculate total amount (simplified)
            const totalAmount = orderItems.reduce((sum, item) => sum + (item.quantity * 10), 0); // €10 per item as placeholder

            const orderData = {
                centerId: centerId,
                items: orderItems,
                status: totalAmount > 500 ? 'pending' : 'approved', // Auto-approve orders under €500
                totalAmount: totalAmount,
                notes: document.getElementById('orderNotes').value.trim(),
                createdAt: serverTimestamp(),
                createdBy: currentUser.uid,
                createdByName: userData.name || userData.email
            };

            // Get center name
            try {
                const centerDoc = await getDoc(doc(db, 'centers', centerId));
                if (centerDoc.exists()) {
                    orderData.centerName = centerDoc.data().name;
                } else {
                    orderData.centerName = 'Centro desconocido';
                }
            } catch (error) {
                console.error('Error getting center name:', error);
                orderData.centerName = 'Centro desconocido';
            }

            try {
                await addDoc(collection(db, 'orders'), orderData);

                showToast(`Pedido creado correctamente ${orderData.status === 'pending' ? '(pendiente de aprobación)' : '(aprobado automáticamente)'}`, 'success');
                closeModal('addOrderModal');
                loadOrders();

                // Reset form
                document.getElementById('addOrderForm').reset();
                resetOrderItems();
            } catch (error) {
                console.error('Error creating order:', error);
                showToast('Error al crear pedido: ' + error.message, 'error');
            }
        }

        function addOrderItem() {
            const orderItems = document.getElementById('orderItems');
            const newItem = document.createElement('div');
            newItem.className = 'order-item';
            newItem.style.cssText = 'display: flex; gap: 8px; margin-bottom: 8px; align-items: end;';

            newItem.innerHTML = `
                <div style="flex: 1;">
                    <label class="form-label text-xs">Producto</label>
                    <input type="text" class="form-input order-product" placeholder="Nombre del producto" required>
                </div>
                <div style="width: 100px;">
                    <label class="form-label text-xs">Cantidad</label>
                    <input type="number" class="form-input order-quantity" placeholder="1" min="1" required>
                </div>
                <div style="width: 120px;">
                    <label class="form-label text-xs">Urgencia</label>
                    <select class="form-select order-urgency">
                        <option value="normal">Normal</option>
                        <option value="urgente">Urgente</option>
                        <option value="critico">Crítico</option>
                    </select>
                </div>
                <button type="button" class="btn btn-danger btn-small" onclick="removeOrderItem(this)" style="height: 38px;">
                    <i class="fas fa-trash"></i>
                </button>
            `;

            orderItems.appendChild(newItem);
        }

        function removeOrderItem(button) {
            const orderItems = document.getElementById('orderItems');
            if (orderItems.children.length > 1) {
                button.closest('.order-item').remove();
            } else {
                showToast('Debe haber al menos un producto en el pedido', 'warning');
            }
        }

        function resetOrderItems() {
            const orderItems = document.getElementById('orderItems');
            orderItems.innerHTML = `
                <div class="order-item" style="display: flex; gap: 8px; margin-bottom: 8px; align-items: end;">
                    <div style="flex: 1;">
                        <label class="form-label text-xs">Producto</label>
                        <input type="text" class="form-input order-product" placeholder="Nombre del producto" required>
                    </div>
                    <div style="width: 100px;">
                        <label class="form-label text-xs">Cantidad</label>
                        <input type="number" class="form-input order-quantity" placeholder="1" min="1" required>
                    </div>
                    <div style="width: 120px;">
                        <label class="form-label text-xs">Urgencia</label>
                        <select class="form-select order-urgency">
                            <option value="normal">Normal</option>
                            <option value="urgente">Urgente</option>
                            <option value="critico">Crítico</option>
                        </select>
                    </div>
                    <button type="button" class="btn btn-danger btn-small" onclick="removeOrderItem(this)" style="height: 38px;">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            `;
        }

        async function approveOrder(orderId) {
            try {
                await updateDoc(doc(db, 'orders', orderId), {
                    status: 'approved',
                    approvedAt: serverTimestamp(),
                    approvedBy: currentUser.uid
                });

                showToast('Pedido aprobado correctamente', 'success');
                loadOrders();
            } catch (error) {
                console.error('Error approving order:', error);
                showToast('Error al aprobar pedido', 'error');
            }
        }

        // Configuration Functions
        async function loadConfiguration() {
            if (userData.role !== 'LIFE_ADMIN') {
                document.getElementById('configContent').innerHTML = 
                    '<div class="text-center"><p>No tienes permisos para acceder a la configuración</p></div>';
                return;
            }

            await loadGlobalConfig();
            renderConfigurationUI();
        }

        async function loadGlobalConfig() {
            try {
                const configDoc = await getDoc(doc(db, 'config', 'global'));
                if (configDoc.exists()) {
                    globalConfig = { ...globalConfig, ...configDoc.data() };
                }
            } catch (error) {
                console.error('Error loading global config:', error);
            }
        }

        function renderConfigurationUI() {
            renderCategoriesList();
            renderDepartmentsList();
        }

        function renderCategoriesList() {
            const categoriesList = document.getElementById('categoriesList');
            categoriesList.innerHTML = globalConfig.categories.map((category, index) => `
                <div style="display: flex; gap: 8px; margin-bottom: 8px; align-items: center;">
                    <input type="text" class="form-input" value="${category}" onchange="updateCategory(${index}, this.value)" style="flex: 1;">
                    <button type="button" class="btn btn-danger btn-small" onclick="removeCategory(${index})">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            `).join('');
        }

        function renderDepartmentsList() {
            const departmentsList = document.getElementById('departmentsList');
            departmentsList.innerHTML = globalConfig.departments.map((department, index) => `
                <div style="display: flex; gap: 8px; margin-bottom: 8px; align-items: center;">
                    <input type="text" class="form-input" value="${department}" onchange="updateDepartment(${index}, this.value)" style="flex: 1;">
                    <button type="button" class="btn btn-danger btn-small" onclick="removeDepartment(${index})">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            `).join('');
        }

        function addCategoryField() {
            globalConfig.categories.push('nueva_categoria');
            renderCategoriesList();
        }

        function addDepartmentField() {
            globalConfig.departments.push('nuevo_departamento');
            renderDepartmentsList();
        }

        function updateCategory(index, value) {
            globalConfig.categories[index] = value.toLowerCase().replace(/\s+/g, '_');
        }

        function updateDepartment(index, value) {
            globalConfig.departments[index] = value.toLowerCase().replace(/\s+/g, '_');
        }

        function removeCategory(index) {
            globalConfig.categories.splice(index, 1);
            renderCategoriesList();
        }

        function removeDepartment(index) {
            globalConfig.departments.splice(index, 1);
            renderDepartmentsList();
        }

        async function handleGlobalConfig(e) {
            e.preventDefault();

            try {
                await setDoc(doc(db, 'config', 'global'), globalConfig);
                showToast('Configuración guardada correctamente', 'success');
            } catch (error) {
                console.error('Error saving global config:', error);
                showToast('Error al guardar configuración', 'error');
            }
        }

        // Utility Functions
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            sidebar.classList.toggle('show');
        }

        function openModal(modalId) {
            document.getElementById(modalId).classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
            document.body.style.overflow = 'auto';
        }

        // Make functions global for onclick handlers
        window.closeModal = closeModal;
        window.removeOrderItem = removeOrderItem;
        window.addOrderItem = addOrderItem;
        window.adjustStock = adjustStock;
        window.editStock = editStock;
        window.adjustInventoryStock = adjustInventoryStock;
        window.toggleCenterStatus = toggleCenterStatus;
        window.approveOrder = approveOrder;
        window.editCenter = editCenter;
        window.viewCenterDetails = viewCenterDetails;
        window.editUser = editUser;
        window.deleteUser = deleteUser;
        window.viewUser = viewUser;
        window.viewOrder = viewOrder;
        window.editOrder = editOrder;
        window.deleteInventoryItem = deleteInventoryItem;
        window.updateCategory = updateCategory;
        window.updateDepartment = updateDepartment;
        window.removeCategory = removeCategory;
        window.removeDepartment = removeDepartment;

        function showLoading(loadingId) {
            const loadingElement = document.getElementById(loadingId);
            if (loadingElement) {
                loadingElement.classList.add('show');
            }
        }

        function hideLoading(loadingId) {
            const loadingElement = document.getElementById(loadingId);
            if (loadingElement) {
                loadingElement.classList.remove('show');
            }
        }

        function showToast(message, type = 'info') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = `toast ${type}`;
            toast.classList.add('show');

            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }

        function formatDate(timestamp) {
            if (!timestamp) return 'Sin fecha';

            let date;
            if (timestamp.toDate) {
                date = timestamp.toDate();
            } else {
                date = new Date(timestamp);
            }

            return date.toLocaleDateString('es-ES', {
                year: 'numeric',
                month: 'short',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        function formatCurrency(amount) {
            return new Intl.NumberFormat('es-ES', {
                style: 'currency',
                currency: 'EUR'
            }).format(amount);
        }

        function formatDepartmentName(department) {
            const departmentNames = {
                'enfermeria': 'Enfermería',
                'quirofano': 'Quirófano',
                'farmacia': 'Farmacia',
                'cocina': 'Cocina',
                'limpieza': 'Limpieza',
                'mantenimiento': 'Mantenimiento',
                'lavanderia': 'Lavandería',
                'recepcion': 'Recepción'
            };
            return departmentNames[department] || department.charAt(0).toUpperCase() + department.slice(1);
        }

        function formatCategoryName(category) {
            const categoryNames = {
                'material_sanitario': 'Material Sanitario',
                'alimentario': 'Alimentario',
                'limpieza': 'Limpieza',
                'farmacia': 'Farmacia',
                'amenities': 'Amenities',
                'textil': 'Textil',
                'mantenimiento': 'Mantenimiento'
            };
            return categoryNames[category] || category.charAt(0).toUpperCase() + category.slice(1).replace('_', ' ');
        }

        function getStatusDisplayName(status) {
            const statusNames = {
                'pending': 'Pendiente',
                'approved': 'Aprobado',
                'ordered': 'Pedido',
                'delivered': 'Entregado',
                'cancelled': 'Cancelado'
            };
            return statusNames[status] || status;
        }

        // Center Management Functions
        async function editCenter(centerId) {
            try {
                // First reset the form to its original state
                resetCenterForm();

                const centerDoc = await getDoc(doc(db, 'centers', centerId));
                if (centerDoc.exists()) {
                    const centerData = centerDoc.data();

                    // Populate edit form with current data
                    document.getElementById('centerName').value = centerData.name || '';
                    document.getElementById('centerType').value = centerData.type || '';
                    document.getElementById('centerAddress').value = centerData.address || '';
                    document.getElementById('centerPhone').value = centerData.phone || '';
                    document.getElementById('centerEmail').value = centerData.email || '';
                    document.getElementById('centerNotes').value = centerData.notes || '';

                    // Set departments after populating type
                    if (centerData.type) {
                        handleCenterTypeChange();
                        setTimeout(() => {
                            // Clear all checkboxes first
                            document.querySelectorAll('#centerDepartments input[type="checkbox"]').forEach(cb => cb.checked = false);
                            // Then check the ones from the center
                            centerData.departments?.forEach(dept => {
                                const checkbox = document.getElementById(`dept_${dept}`);
                                if (checkbox) checkbox.checked = true;
                            });
                        }, 200);
                    }

                    // Change form handler to update instead of create
                    const form = document.getElementById('addCenterForm');
                    form.onsubmit = async (e) => {
                        e.preventDefault();
                        await handleUpdateCenter(e, centerId);
                    };

                    // Mark as editing mode
                    form.dataset.editing = 'true';
                    form.dataset.centerId = centerId;

                    document.querySelector('#addCenterModal .modal-title').textContent = 'Editar Centro';
                    document.querySelector('#addCenterModal .btn-primary').innerHTML = '<i class="fas fa-save"></i> Actualizar Centro';

                    openModal('addCenterModal');
                }
            } catch (error) {
                console.error('Error loading center for edit:', error);
                showToast('Error al cargar centro', 'error');
            }
        }

        async function handleUpdateCenter(e, centerId) {
            e.preventDefault();

            const departments = Array.from(document.querySelectorAll('#centerDepartments input:checked'))
                .map(input => input.value);

            if (departments.length === 0) {
                showToast('Selecciona al menos un departamento', 'error');
                return;
            }

            const centerData = {
                name: document.getElementById('centerName').value,
                type: document.getElementById('centerType').value,
                address: document.getElementById('centerAddress').value,
                phone: document.getElementById('centerPhone').value,
                email: document.getElementById('centerEmail').value,
                departments: departments,
                adminId: document.getElementById('centerAdmin').value,
                notes: document.getElementById('centerNotes').value,
                updatedAt: serverTimestamp(),
                updatedBy: currentUser.uid
            };

            try {
                await updateDoc(doc(db, 'centers', centerId), centerData);
                showToast('Centro actualizado correctamente', 'success');
                closeModal('addCenterModal');
                resetCenterForm();
                loadCenters();
            } catch (error) {
                console.error('Error updating center:', error);
                showToast('Error al actualizar centro', 'error');
            }
        }

        function resetCenterForm() {
            const form = document.getElementById('addCenterForm');
            form.onsubmit = handleAddCenter;
            form.removeAttribute('data-editing');
            form.removeAttribute('data-center-id');
            document.querySelector('#addCenterModal .modal-title').textContent = 'Nuevo Centro';
            document.querySelector('#addCenterModal .btn-primary').innerHTML = '<i class="fas fa-save"></i> Crear Centro';
            form.reset();
        }

        async function viewCenterDetails(centerId) {
            try {
                const centerDoc = await getDoc(doc(db, 'centers', centerId));
                if (centerDoc.exists()) {
                    const centerData = centerDoc.data();

                    // Get center statistics
                    const usersQuery = query(collection(db, 'users'), where('centerIds', 'array-contains', centerId));
                    const usersSnapshot = await getDocs(usersQuery);

                    const inventoryQuery = query(collection(db, 'inventory'), where('centerId', '==', centerId));
                    const inventorySnapshot = await getDocs(inventoryQuery);

                    const ordersQuery = query(collection(db, 'orders'), where('centerId', '==', centerId));
                    const ordersSnapshot = await getDocs(ordersQuery);

                    const modalContent = `
                        <div class="modal" id="centerDetailsModal" style="display: flex;">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h3 class="modal-title">Detalles del Centro</h3>
                                    <button class="modal-close" onclick="closeModal('centerDetailsModal')">&times;</button>
                                </div>
                                <div class="modal-body">
                                    <div class="grid-2">
                                        <div>
                                            <h4 class="font-medium mb-2">${centerData.name}</h4>
                                            <p class="text-sm text-secondary mb-2">${centerData.type}</p>
                                            <p class="mb-2"><i class="fas fa-map-marker-alt"></i> ${centerData.address}</p>
                                            ${centerData.phone ? `<p class="mb-2"><i class="fas fa-phone"></i> ${centerData.phone}</p>` : ''}
                                            ${centerData.email ? `<p class="mb-2"><i class="fas fa-envelope"></i> ${centerData.email}</p>` : ''}
                                            <p class="mb-2"><i class="fas fa-building"></i> ${centerData.departments?.map(d => formatDepartmentName(d)).join(', ')}</p>
                                            ${centerData.notes ? `<p class="text-sm text-secondary mt-4">${centerData.notes}</p>` : ''}
                                        </div>
                                        <div>
                                            <h5 class="font-medium mb-2">Estadísticas</h5>
                                            <div class="stats-grid" style="grid-template-columns: 1fr;">
                                                <div class="stat-card">
                                                    <span class="stat-number">${usersSnapshot.size}</span>
                                                    <div class="stat-label">Usuarios</div>
                                                </div>
                                                <div class="stat-card">
                                                    <span class="stat-number">${inventorySnapshot.size}</span>
                                                    <div class="stat-label">Productos en Inventario</div>
                                                </div>
                                                <div class="stat-card">
                                                    <span class="stat-number">${ordersSnapshot.size}</span>
                                                    <div class="stat-label">Pedidos Total</div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-outline" onclick="closeModal('centerDetailsModal')">Cerrar</button>
                                    ${userData.role === 'LIFE_ADMIN' ? `<button type="button" class="btn btn-primary" onclick="closeModal('centerDetailsModal'); editCenter('${centerId}')">Editar Centro</button>` : ''}
                                </div>
                            </div>
                        </div>
                    `;

                    // Remove any existing modal
                    const existingModal = document.getElementById('centerDetailsModal');
                    if (existingModal) existingModal.remove();

                    // Add modal to body
                    document.body.insertAdjacentHTML('beforeend', modalContent);
                }
            } catch (error) {
                console.error('Error loading center details:', error);
                showToast('Error al cargar detalles del centro', 'error');
            }
        }

        // User Management Functions
        async function editUser(userId) {
            try {
                const userDoc = await getDoc(doc(db, 'users', userId));
                if (userDoc.exists()) {
                    const userData = userDoc.data();

                    // Populate edit form
                    document.getElementById('userName').value = userData.name || '';
                    document.getElementById('userEmail').value = userData.email;
                    document.getElementById('userRole').value = userData.role;
                    document.getElementById('userDepartment').value = userData.department || '';

                    // Set assigned centers
                    await populateUserCenters();
                    setTimeout(() => {
                        userData.centerIds?.forEach(centerId => {
                            const checkbox = document.getElementById(`center_${centerId}`);
                            if (checkbox) checkbox.checked = true;
                        });
                    }, 100);

                    // Hide password field for editing
                    const passwordGroup = document.querySelector('#userPassword').closest('.form-group');
                    passwordGroup.style.display = 'none';

                    // Change form handler
                    const form = document.getElementById('addUserForm');
                    form.onsubmit = async (e) => {
                        e.preventDefault();
                        await handleUpdateUser(e, userId);
                    };

                    document.querySelector('#addUserModal .modal-title').textContent = 'Editar Usuario';
                    document.querySelector('#addUserModal .btn-primary').innerHTML = '<i class="fas fa-save"></i> Actualizar Usuario';

                    openModal('addUserModal');
                }
            } catch (error) {
                console.error('Error loading user for edit:', error);
                showToast('Error al cargar usuario', 'error');
            }
        }

        async function handleUpdateUser(e, userId) {
            e.preventDefault();

            const selectedCenters = Array.from(document.querySelectorAll('#userCenters input:checked'))
                .map(input => input.value);

            const updatedUserData = {
                name: document.getElementById('userName').value,
                email: document.getElementById('userEmail').value,
                role: document.getElementById('userRole').value,
                centerIds: selectedCenters,
                department: document.getElementById('userDepartment').value,
                updatedAt: serverTimestamp(),
                updatedBy: currentUser.uid
            };

            try {
                await updateDoc(doc(db, 'users', userId), updatedUserData);
                showToast('Usuario actualizado correctamente', 'success');
                closeModal('addUserModal');
                resetUserForm();
                loadUsers();
            } catch (error) {
                console.error('Error updating user:', error);
                showToast('Error al actualizar usuario', 'error');
            }
        }

        function resetUserForm() {
            const form = document.getElementById('addUserForm');
            form.onsubmit = handleAddUser;
            const passwordGroup = document.querySelector('#userPassword').closest('.form-group');
            passwordGroup.style.display = 'block';
            document.querySelector('#addUserModal .modal-title').textContent = 'Nuevo Usuario';
            document.querySelector('#addUserModal .btn-primary').innerHTML = '<i class="fas fa-user-plus"></i> Crear Usuario';
        }

        async function deleteUser(userId) {
            if (!confirm('¿Estás seguro de que quieres eliminar este usuario? Esta acción no se puede deshacer.')) {
                return;
            }

            try {
                await deleteDoc(doc(db, 'users', userId));
                showToast('Usuario eliminado correctamente', 'success');
                loadUsers();
            } catch (error) {
                console.error('Error deleting user:', error);
                showToast('Error al eliminar usuario', 'error');
            }
        }

        async function viewUser(userId) {
            try {
                const userDoc = await getDoc(doc(db, 'users', userId));
                if (userDoc.exists()) {
                    const userData = userDoc.data();

                    // Get user's centers
                    let userCenters = [];
                    if (userData.centerIds?.length) {
                        const centersQuery = query(collection(db, 'centers'), where('__name__', 'in', userData.centerIds));
                        const centersSnapshot = await getDocs(centersQuery);
                        userCenters = centersSnapshot.docs.map(doc => doc.data().name);
                    }

                    const modalContent = `
                        <div class="modal" id="userDetailsModal" style="display: flex;">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h3 class="modal-title">Detalles del Usuario</h3>
                                    <button class="modal-close" onclick="closeModal('userDetailsModal')">&times;</button>
                                </div>
                                <div class="modal-body">
                                    <div class="grid-2">
                                        <div>
                                            <h4 class="font-medium mb-2">${userData.name || 'Sin nombre'}</h4>
                                            <p class="text-sm text-secondary mb-2">${userData.email}</p>
                                            <p class="mb-2"><strong>Rol:</strong> ${getRoleDisplayName(userData.role)}</p>
                                            ${userData.department ? `<p class="mb-2"><strong>Departamento:</strong> ${userData.department}</p>` : ''}
                                            <p class="mb-2"><strong>Estado:</strong> <span class="badge badge-active">Activo</span></p>
                                            <p class="text-sm text-secondary">Creado: ${formatDate(userData.createdAt)}</p>
                                        </div>
                                        <div>
                                            <h5 class="font-medium mb-2">Centros Asignados</h5>
                                            ${userCenters.length > 0 ? 
                                                userCenters.map(center => `<span class="badge badge-approved" style="margin: 2px;">${center}</span>`).join(' ') :
                                                '<p class="text-secondary">Sin centros asignados</p>'
                                            }
                                        </div>
                                    </div>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-outline" onclick="closeModal('userDetailsModal')">Cerrar</button>
                                    ${canManageUser(userData) ? `<button type="button" class="btn btn-primary" onclick="closeModal('userDetailsModal'); editUser('${userId}')">Editar Usuario</button>` : ''}
                                </div>
                            </div>
                        </div>
                    `;

                    // Remove any existing modal
                    const existingModal = document.getElementById('userDetailsModal');
                    if (existingModal) existingModal.remove();

                    // Add modal to body
                    document.body.insertAdjacentHTML('beforeend', modalContent);
                }
            } catch (error) {
                console.error('Error loading user details:', error);
                showToast('Error al cargar detalles del usuario', 'error');
            }
        }

        // Order Management Functions
        async function viewOrder(orderId) {
            try {
                const orderDoc = await getDoc(doc(db, 'orders', orderId));
                if (orderDoc.exists()) {
                    const orderData = orderDoc.data();

                    const modalContent = `
                        <div class="modal" id="orderDetailsModal" style="display: flex;">
                            <div class="modal-content" style="max-width: 800px;">
                                <div class="modal-header">
                                    <h3 class="modal-title">Detalles del Pedido #${orderId.substring(0, 8)}</h3>
                                    <button class="modal-close" onclick="closeModal('orderDetailsModal')">&times;</button>
                                </div>
                                <div class="modal-body">
                                    <div class="grid-2" style="margin-bottom: 20px;">
                                        <div>
                                            <h5 class="font-medium mb-2">Información General</h5>
                                            <p><strong>Centro:</strong> ${orderData.centerName || 'Sin asignar'}</p>
                                            <p><strong>Estado:</strong> <span class="badge badge-${orderData.status}">${getStatusDisplayName(orderData.status)}</span></p>
                                            <p><strong>Total:</strong> ${formatCurrency(orderData.totalAmount || 0)}</p>
                                            <p><strong>Creado por:</strong> ${orderData.createdByName || 'Sistema'}</p>
                                            <p><strong>Fecha:</strong> ${formatDate(orderData.createdAt)}</p>
                                        </div>
                                        <div>
                                            ${orderData.notes ? `
                                                <h5 class="font-medium mb-2">Observaciones</h5>
                                                <p class="text-sm">${orderData.notes}</p>
                                            ` : ''}
                                        </div>
                                    </div>

                                    <h5 class="font-medium mb-2">Productos del Pedido</h5>
                                    <div class="table-container">
                                        <table class="table">
                                            <thead>
                                                <tr>
                                                    <th>Producto</th>
                                                    <th>Cantidad</th>
                                                    <th>Urgencia</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                ${orderData.items?.map(item => `
                                                    <tr>
                                                        <td>${item.productName}</td>
                                                        <td>${item.quantity}</td>
                                                        <td><span class="badge badge-${item.urgency === 'critico' ? 'inactive' : item.urgency === 'urgente' ? 'pending' : 'active'}">${item.urgency}</span></td>
                                                    </tr>
                                                `).join('') || '<tr><td colspan="3">Sin productos</td></tr>'}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-outline" onclick="closeModal('orderDetailsModal')">Cerrar</button>
                                    ${canManageOrder(orderData) && orderData.status === 'pending' ? `
                                        <button type="button" class="btn btn-success" onclick="closeModal('orderDetailsModal'); approveOrder('${orderId}')">
                                            <i class="fas fa-check"></i> Aprobar Pedido
                                        </button>
                                    ` : ''}
                                    ${canManageOrder(orderData) ? `
                                        <button type="button" class="btn btn-primary" onclick="closeModal('orderDetailsModal'); editOrder('${orderId}')">
                                            <i class="fas fa-edit"></i> Editar Pedido
                                        </button>
                                    ` : ''}
                                </div>
                            </div>
                        </div>
                    `;

                    // Remove any existing modal
                    const existingModal = document.getElementById('orderDetailsModal');
                    if (existingModal) existingModal.remove();

                    // Add modal to body
                    document.body.insertAdjacentHTML('beforeend', modalContent);
                }
            } catch (error) {
                console.error('Error loading order details:', error);
                showToast('Error al cargar detalles del pedido', 'error');
            }
        }

        async function editOrder(orderId) {
            try {
                const orderDoc = await getDoc(doc(db, 'orders', orderId));
                if (orderDoc.exists()) {
                    const orderData = orderDoc.data();

                    // Populate order center
                    await populateOrderCenters();
                    document.getElementById('orderCenter').value = orderData.centerId;
                    document.getElementById('orderNotes').value = orderData.notes || '';

                    // Populate order items
                    const orderItemsContainer = document.getElementById('orderItems');
                    orderItemsContainer.innerHTML = '';

                    orderData.items?.forEach((item, index) => {
                        const itemDiv = document.createElement('div');
                        itemDiv.className = 'order-item';
                        itemDiv.style.cssText = 'display: flex; gap: 8px; margin-bottom: 8px; align-items: end;';
                        itemDiv.innerHTML = `
                            <div style="flex: 1;">
                                <label class="form-label text-xs">Producto</label>
                                <input type="text" class="form-input order-product" placeholder="Nombre del producto" value="${item.productName}" required>
                            </div>
                            <div style="width: 100px;">
                                <label class="form-label text-xs">Cantidad</label>
                                <input type="number" class="form-input order-quantity" placeholder="1" min="1" value="${item.quantity}" required>
                            </div>
                            <div style="width: 120px;">
                                <label class="form-label text-xs">Urgencia</label>
                                <select class="form-select order-urgency">
                                    <option value="normal" ${item.urgency === 'normal' ? 'selected' : ''}>Normal</option>
                                    <option value="urgente" ${item.urgency === 'urgente' ? 'selected' : ''}>Urgente</option>
                                    <option value="critico" ${item.urgency === 'critico' ? 'selected' : ''}>Crítico</option>
                                </select>
                            </div>
                            <button type="button" class="btn btn-danger btn-small" onclick="removeOrderItem(this)" style="height: 38px;">
                                <i class="fas fa-trash"></i>
                            </button>
                        `;
                        orderItemsContainer.appendChild(itemDiv);
                    });

                    // Change form handler
                    const form = document.getElementById('addOrderForm');
                    form.onsubmit = async (e) => {
                        e.preventDefault();
                        await handleUpdateOrder(e, orderId);
                    };

                    document.querySelector('#addOrderModal .modal-title').textContent = 'Editar Pedido';
                    document.querySelector('#addOrderModal .btn-primary').innerHTML = '<i class="fas fa-save"></i> Actualizar Pedido';

                    openModal('addOrderModal');
                }
            } catch (error) {
                console.error('Error loading order for edit:', error);
                showToast('Error al cargar pedido', 'error');
            }
        }

        async function handleUpdateOrder(e, orderId) {
            e.preventDefault();

            const centerId = document.getElementById('orderCenter').value;
            const orderItems = [];

            // Collect order items
            document.querySelectorAll('.order-item').forEach(item => {
                const product = item.querySelector('.order-product').value;
                const quantity = parseInt(item.querySelector('.order-quantity').value);
                const urgency = item.querySelector('.order-urgency').value;

                if (product && quantity > 0) {
                    orderItems.push({
                        productName: product,
                        quantity: quantity,
                        urgency: urgency
                    });
                }
            });

            if (orderItems.length === 0) {
                showToast('Añade al menos un producto al pedido', 'error');
                return;
            }

            const totalAmount = orderItems.reduce((sum, item) => sum + (item.quantity * 10), 0);

            const updateData = {
                centerId: centerId,
                items: orderItems,
                totalAmount: totalAmount,
                notes: document.getElementById('orderNotes').value,
                updatedAt: serverTimestamp(),
                updatedBy: currentUser.uid
            };

            // Get center name
            try {
                const centerDoc = await getDoc(doc(db, 'centers', centerId));
                if (centerDoc.exists()) {
                    updateData.centerName = centerDoc.data().name;
                }
            } catch (error) {
                console.error('Error getting center name:', error);
            }

            try {
                await updateDoc(doc(db, 'orders', orderId), updateData);
                showToast('Pedido actualizado correctamente', 'success');
                closeModal('addOrderModal');
                resetOrderForm();
                loadOrders();
            } catch (error) {
                console.error('Error updating order:', error);
                showToast('Error al actualizar pedido', 'error');
            }
        }

        function resetOrderForm() {
            const form = document.getElementById('addOrderForm');
            form.onsubmit = handleAddOrder;
            document.querySelector('#addOrderModal .modal-title').textContent = 'Nuevo Pedido';
            document.querySelector('#addOrderModal .btn-primary').innerHTML = '<i class="fas fa-shopping-cart"></i> Crear Pedido';
            resetOrderItems();
        }

        // Inventory Management Functions
        async function deleteInventoryItem(itemId) {
            if (!confirm('¿Estás seguro de que quieres eliminar este producto del inventario? Esta acción no se puede deshacer.')) {
                return;
            }

            try {
                await deleteDoc(doc(db, 'inventory', itemId));
                showToast('Producto eliminado del inventario correctamente', 'success');
                loadInventory();
            } catch (error) {
                console.error('Error deleting inventory item:', error);
                showToast('Error al eliminar producto del inventario', 'error');
            }
        }

        // Event Handlers
        document.addEventListener('click', (e) => {
            if (e.target.classList.contains('modal')) {
                e.target.classList.remove('active');
                document.body.style.overflow = 'auto';
            }
        });

        document.addEventListener('click', (e) => {
            const sidebar = document.getElementById('sidebar');
            const menuToggle = document.getElementById('menuToggle');

            if (window.innerWidth <= 768 && 
                !sidebar.contains(e.target) && 
                !menuToggle.contains(e.target) &&
                sidebar.classList.contains('show')) {
                sidebar.classList.remove('show');
            }
        });

        window.addEventListener('resize', () => {
            const sidebar = document.getElementById('sidebar');
            const mainContent = document.getElementById('mainContent');

            if (window.innerWidth > 768) {
                sidebar.classList.remove('show');
                sidebar.classList.remove('collapsed');
                mainContent.classList.remove('expanded');
            }
        });

        // Calendar Functions
        async function loadCalendar() {
            try {
                await loadEvents();
                renderCalendar();
                populateEventCenters();
            } catch (error) {
                console.error('Error loading calendar:', error);
                showToast('Error al cargar calendario', 'error');
            }
        }

        async function loadEvents() {
            try {
                let eventsQuery = collection(db, 'events');

                if (selectedCenterId) {
                    eventsQuery = query(eventsQuery, where('centerId', '==', selectedCenterId));
                } else if (userData.role !== 'LIFE_ADMIN') {
                    eventsQuery = query(eventsQuery, where('centerId', 'in', userData.centerIds || []));
                }

                const snapshot = await getDocs(eventsQuery);
                allEvents = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            } catch (error) {
                console.error('Error loading events:', error);
            }
        }

        function renderCalendar() {
            const year = currentCalendarDate.getFullYear();
            const month = currentCalendarDate.getMonth();

            // Update title
            const monthNames = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio',
                'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
            document.getElementById('calendarTitle').textContent = `${monthNames[month]} ${year}`;

            // Get first day of month and days in month
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const startDate = new Date(firstDay);
            startDate.setDate(startDate.getDate() - firstDay.getDay());

            const calendarGrid = document.getElementById('calendarGrid');
            calendarGrid.innerHTML = '';

            // Day headers
            const dayHeaders = ['Dom', 'Lun', 'Mar', 'Mié', 'Jue', 'Vie', 'Sáb'];
            dayHeaders.forEach(day => {
                const dayHeader = document.createElement('div');
                dayHeader.className = 'calendar-day-header';
                dayHeader.textContent = day;
                calendarGrid.appendChild(dayHeader);
            });

            // Generate calendar days
            const today = new Date();
            for (let i = 0; i < 42; i++) { // 6 weeks
                const currentDate = new Date(startDate);
                currentDate.setDate(startDate.getDate() + i);

                const dayElement = document.createElement('div');
                dayElement.className = 'calendar-day';

                if (currentDate.getMonth() !== month) {
                    dayElement.classList.add('other-month');
                }

                if (currentDate.toDateString() === today.toDateString()) {
                    dayElement.classList.add('today');
                }

                dayElement.innerHTML = `
                    <div class="calendar-day-number">${currentDate.getDate()}</div>
                    <div class="calendar-events" id="events-${currentDate.toISOString().split('T')[0]}"></div>
                `;

                dayElement.onclick = () => openDayEvents(currentDate);
                calendarGrid.appendChild(dayElement);

                // Add events for this day
                const dayEvents = allEvents.filter(event => {
                    const eventDate = new Date(event.date);
                    return eventDate.toDateString() === currentDate.toDateString();
                });

                const eventsContainer = dayElement.querySelector('.calendar-events');
                dayEvents.forEach(event => {
                    const eventElement = document.createElement('div');
                    eventElement.className = `calendar-event event-${event.priority}`;
                    eventElement.textContent = event.title;
                    eventElement.onclick = (e) => {
                        e.stopPropagation();
                        viewEvent(event.id);
                    };
                    eventsContainer.appendChild(eventElement);
                });
            }
        }

        function changeMonth(direction) {
            currentCalendarDate.setMonth(currentCalendarDate.getMonth() + direction);
            renderCalendar();
        }

        function goToToday() {
            currentCalendarDate = new Date();
            renderCalendar();
        }

        async function populateEventCenters() {
            try {
                const eventCenterSelect = document.getElementById('eventCenter');
                eventCenterSelect.innerHTML = '<option value="">Todos los centros</option>' +
                    allCenters.map(center => `<option value="${center.id}">${center.name}</option>`).join('');

                if (selectedCenterId) {
                    eventCenterSelect.value = selectedCenterId;
                }
            } catch (error) {
                console.error('Error populating event centers:', error);
            }
        }

        async function handleAddEvent(e) {
            e.preventDefault();

            const eventData = {
                title: document.getElementById('eventTitle').value.trim(),
                type: document.getElementById('eventType').value,
                date: document.getElementById('eventDate').value,
                time: document.getElementById('eventTime').value,
                centerId: document.getElementById('eventCenter').value || null,
                priority: document.getElementById('eventPriority').value,
                description: document.getElementById('eventDescription').value.trim(),
                createdAt: serverTimestamp(),
                createdBy: currentUser.uid,
                createdByName: userData.name || userData.email
            };

            // Get center name if centerId is provided
            if (eventData.centerId) {
                const center = allCenters.find(c => c.id === eventData.centerId);
                eventData.centerName = center?.name || 'Centro desconocido';
            }

            try {
                await addDoc(collection(db, 'events'), eventData);
                showToast('Evento creado correctamente', 'success');
                closeModal('addEventModal');
                document.getElementById('addEventForm').reset();
                loadCalendar();
            } catch (error) {
                console.error('Error creating event:', error);
                showToast('Error al crear evento', 'error');
            }
        }

        // Time Log Functions
        async function loadTimeLog() {
            try {
                await loadTimeEntries();
                renderTimeEntries();
                updateTimeSummary();
                populateTimeEntryCenters();
            } catch (error) {
                console.error('Error loading time log:', error);
                showToast('Error al cargar registro de horas', 'error');
            }
        }

        async function loadTimeEntries() {
            try {
                let timeEntriesQuery = collection(db, 'timeEntries');

                if (selectedCenterId) {
                    timeEntriesQuery = query(
                        timeEntriesQuery, 
                        where('centerId', '==', selectedCenterId),
                        orderBy('date', 'desc')
                    );
                } else if (userData.role !== 'LIFE_ADMIN') {
                    timeEntriesQuery = query(
                        timeEntriesQuery,
                        where('userId', '==', currentUser.uid),
                        orderBy('date', 'desc')
                    );
                } else {
                    timeEntriesQuery = query(timeEntriesQuery, orderBy('date', 'desc'));
                }

                const snapshot = await getDocs(timeEntriesQuery);
                allTimeEntries = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            } catch (error) {
                console.error('Error loading time entries:', error);
            }
        }

        function renderTimeEntries(filteredEntries = null) {
            const entries = filteredEntries || allTimeEntries;
            const timeEntriesList = document.getElementById('timeEntriesList');

            if (entries.length === 0) {
                timeEntriesList.innerHTML = '<p class="text-center text-secondary">No hay entradas de tiempo registradas</p>';
                return;
            }

            timeEntriesList.innerHTML = entries.map(entry => `
                <div class="time-entry">
                    <div style="flex: 1;">
                        <div class="font-medium">${entry.task}</div>
                        <div class="text-sm text-secondary">${entry.category} - ${formatDate(entry.date)}</div>
                        ${entry.centerName ? `<div class="text-xs text-secondary">${entry.centerName}</div>` : ''}
                    </div>
                    <div class="font-medium">${formatDuration(entry.hours)}</div>
                    <div class="flex gap-1">
                        <button class="btn btn-small btn-outline" onclick="editTimeEntry('${entry.id}')">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-small btn-danger" onclick="deleteTimeEntry('${entry.id}')">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            `).join('');
        }

        function updateTimeSummary() {
            const today = new Date().toISOString().split('T')[0];
            const thisWeekStart = getWeekStart(new Date());
            const thisMonthStart = new Date();
            thisMonthStart.setDate(1);

            const todayHours = allTimeEntries
                .filter(entry => entry.date === today)
                .reduce((sum, entry) => sum + entry.hours, 0);

            const weekHours = allTimeEntries
                .filter(entry => new Date(entry.date) >= thisWeekStart)
                .reduce((sum, entry) => sum + entry.hours, 0);

            const monthHours = allTimeEntries
                .filter(entry => new Date(entry.date) >= thisMonthStart)
                .reduce((sum, entry) => sum + entry.hours, 0);

            document.getElementById('todayHours').textContent = formatDuration(todayHours);
            document.getElementById('weekHours').textContent = formatDuration(weekHours);
            document.getElementById('monthHours').textContent = formatDuration(monthHours);
        }

        function startTimer() {
            const task = document.getElementById('activeTask').value.trim();
            if (!task) {
                showToast('Ingresa una descripción de la tarea', 'warning');
                return;
            }

            timerState.isRunning = true;
            timerState.startTime = Date.now() - timerState.elapsed;
            timerState.task = task;

            document.getElementById('startTimer').classList.add('hidden');
            document.getElementById('pauseTimer').classList.remove('hidden');
            document.getElementById('stopTimer').classList.remove('hidden');
            document.getElementById('activeTaskInfo').textContent = `Trabajando en: ${task}`;

            timerState.interval = setInterval(updateTimerDisplay, 1000);
            updateTimerDisplay();
        }

        function pauseTimer() {
            timerState.isRunning = false;
            timerState.elapsed = Date.now() - timerState.startTime;

            document.getElementById('startTimer').classList.remove('hidden');
            document.getElementById('pauseTimer').classList.add('hidden');
            document.getElementById('activeTaskInfo').textContent = `Pausado: ${timerState.task}`;

            clearInterval(timerState.interval);
        }

        async function stopTimer() {
            if (timerState.elapsed === 0) {
                showToast('El timer no ha registrado tiempo', 'warning');
                return;
            }

            const totalMinutes = Math.floor(timerState.elapsed / 60000);
            const hours = totalMinutes / 60;

            if (hours < 0.1) {
                showToast('Tiempo muy corto para registrar (mínimo 6 minutos)', 'warning');
                resetTimer();
                return;
            }

            // Save time entry
            const timeEntryData = {
                task: timerState.task,
                hours: parseFloat(hours.toFixed(2)),
                date: new Date().toISOString().split('T')[0],
                category: 'operational',
                centerId: selectedCenterId || null,
                centerName: selectedCenterId ? allCenters.find(c => c.id === selectedCenterId)?.name : null,
                userId: currentUser.uid,
                userName: userData.name || userData.email,
                createdAt: serverTimestamp(),
                fromTimer: true
            };

            try {
                await addDoc(collection(db, 'timeEntries'), timeEntryData);
                showToast(`Tiempo registrado: ${formatDuration(hours)} para "${timerState.task}"`, 'success');
                resetTimer();
                loadTimeLog();
            } catch (error) {
                console.error('Error saving time entry:', error);
                showToast('Error al guardar entrada de tiempo', 'error');
            }
        }

        function resetTimer() {
            timerState.isRunning = false;
            timerState.startTime = null;
            timerState.elapsed = 0;
            timerState.task = '';

            document.getElementById('startTimer').classList.remove('hidden');
            document.getElementById('pauseTimer').classList.add('hidden');
            document.getElementById('stopTimer').classList.add('hidden');
            document.getElementById('activeTimer').textContent = '00:00:00';
            document.getElementById('activeTask').value = '';
            document.getElementById('activeTaskInfo').textContent = 'Sin tarea activa';

            clearInterval(timerState.interval);
        }

        function updateTimerDisplay() {
            if (timerState.isRunning) {
                timerState.elapsed = Date.now() - timerState.startTime;
            }

            const hours = Math.floor(timerState.elapsed / 3600000);
            const minutes = Math.floor((timerState.elapsed % 3600000) / 60000);
            const seconds = Math.floor((timerState.elapsed % 60000) / 1000);

            const display = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            document.getElementById('activeTimer').textContent = display;
            document.getElementById('activeTimer').className = `timer-display ${timerState.isRunning ? 'timer-running' : 'timer-paused'}`;
        }

        async function populateTimeEntryCenters() {
            try {
                const timeEntryCenterSelect = document.getElementById('timeEntryCenter');
                timeEntryCenterSelect.innerHTML = '<option value="">Seleccionar centro</option>' +
                    allCenters.map(center => `<option value="${center.id}">${center.name}</option>`).join('');

                if (selectedCenterId) {
                    timeEntryCenterSelect.value = selectedCenterId;
                }
            } catch (error) {
                console.error('Error populating time entry centers:', error);
            }
        }

        async function handleAddTimeEntry(e) {
            e.preventDefault();

            const timeEntryData = {
                task: document.getElementById('timeEntryTask').value.trim(),
                category: document.getElementById('timeEntryCategory').value,
                date: document.getElementById('timeEntryDate').value,
                hours: parseFloat(document.getElementById('timeEntryHours').value),
                centerId: document.getElementById('timeEntryCenter').value || null,
                notes: document.getElementById('timeEntryNotes').value.trim(),
                userId: currentUser.uid,
                userName: userData.name || userData.email,
                createdAt: serverTimestamp(),
                fromTimer: false
            };

            // Get center name if centerId is provided
            if (timeEntryData.centerId) {
                const center = allCenters.find(c => c.id === timeEntryData.centerId);
                timeEntryData.centerName = center?.name || 'Centro desconocido';
            }

            try {
                await addDoc(collection(db, 'timeEntries'), timeEntryData);
                showToast('Entrada de tiempo registrada correctamente', 'success');
                closeModal('addTimeEntryModal');
                document.getElementById('addTimeEntryForm').reset();
                loadTimeLog();
            } catch (error) {
                console.error('Error creating time entry:', error);
                showToast('Error al registrar entrada de tiempo', 'error');
            }
        }

        function filterTimeEntries() {
            const dateFilter = document.getElementById('timelogDateFilter').value;
            const taskFilter = document.getElementById('timelogTaskFilter').value.toLowerCase();

            let filteredEntries = allTimeEntries;

            if (dateFilter) {
                filteredEntries = filteredEntries.filter(entry => entry.date === dateFilter);
            }

            if (taskFilter) {
                filteredEntries = filteredEntries.filter(entry => 
                    entry.task.toLowerCase().includes(taskFilter) ||
                    entry.category.toLowerCase().includes(taskFilter)
                );
            }

            renderTimeEntries(filteredEntries);
        }

        // Suppliers Functions
        async function loadSuppliers() {
            showLoading('suppliersLoading');

            try {
                let suppliersQuery = collection(db, 'suppliers');

                const snapshot = await getDocs(suppliersQuery);
                allSuppliers = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                renderSuppliers(allSuppliers);
                populateSupplierFilters();
                
                // Load purchase orders
                await loadPurchaseOrders();
            } catch (error) {
                console.error('Error loading suppliers:', error);
                showToast('Error al cargar proveedores', 'error');
            } finally {
                hideLoading('suppliersLoading');
            }
        }

        function renderSuppliers(suppliers) {
            const suppliersTableBody = document.getElementById('suppliersTableBody');

            if (suppliers.length === 0) {
                suppliersTableBody.innerHTML = '<tr><td colspan="7" class="text-center text-secondary">No hay proveedores registrados</td></tr>';
                return;
            }

            suppliersTableBody.innerHTML = suppliers.map(supplier => `
                <tr>
                    <td>
                        <strong>${supplier.name}</strong>
                        <br><small class="text-secondary">${supplier.taxId}</small>
                    </td>
                    <td>
                        ${supplier.categories?.map(cat => 
                            `<span class="badge badge-approved" style="margin: 1px;">${formatCategoryName(cat)}</span>`
                        ).join(' ') || 'Sin categorías'}
                    </td>
                    <td>
                        <div>${supplier.email}</div>
                        <div class="text-sm text-secondary">${supplier.phone}</div>
                        ${supplier.contactPerson ? `<div class="text-xs text-secondary">Contacto: ${supplier.contactPerson}</div>` : ''}
                    </td>
                    <td>
                        <div class="flex items-center gap-1">
                            ${renderStarRating(supplier.rating || 0)}
                            <span class="text-sm">(${(supplier.rating || 0).toFixed(1)})</span>
                        </div>
                    </td>
                    <td>${supplier.deliveryTime || 'N/A'} días</td>
                    <td><span class="badge badge-${supplier.isActive ? 'active' : 'inactive'}">${supplier.isActive ? 'Activo' : 'Inactivo'}</span></td>
                    <td>
                        <div class="flex gap-1">
                            <button class="btn btn-small btn-primary" onclick="viewSupplierProducts('${supplier.id}')">
                                <i class="fas fa-box"></i>
                            </button>
                            <button class="btn btn-small btn-outline" onclick="requestQuote(['${supplier.id}'])">
                                <i class="fas fa-file-invoice"></i>
                            </button>
                            ${userData.role === 'LIFE_ADMIN' || userData.role === 'CENTER_ADMIN' ? `
                                <button class="btn btn-small btn-outline" onclick="editSupplier('${supplier.id}')">
                                    <i class="fas fa-edit"></i>
                                </button>
                            ` : ''}
                            <button class="btn btn-small btn-success" onclick="createPurchaseOrderForSupplier('${supplier.id}')">
                                <i class="fas fa-shopping-cart"></i>
                            </button>
                        </div>
                    </td>
                </tr>
            `).join('');
        }

        function renderStarRating(rating) {
            let stars = '';
            for (let i = 1; i <= 5; i++) {
                if (i <= rating) {
                    stars += '<i class="fas fa-star" style="color: #ffc107;"></i>';
                } else if (i - 0.5 <= rating) {
                    stars += '<i class="fas fa-star-half-alt" style="color: #ffc107;"></i>';
                } else {
                    stars += '<i class="far fa-star" style="color: #ffc107;"></i>';
                }
            }
            return stars;
        }

        async function populateSupplierFilters() {
            try {
                const supplierCategoryFilter = document.getElementById('supplierCategoryFilter');
                supplierCategoryFilter.innerHTML = '<option value="">Todas las categorías</option>' +
                    globalConfig.categories.map(cat => `<option value="${cat}">${formatCategoryName(cat)}</option>`).join('');
            } catch (error) {
                console.error('Error populating supplier filters:', error);
            }
        }

        async function populateSupplierCategories() {
            try {
                const supplierCategoriesContainer = document.getElementById('supplierCategories');
                supplierCategoriesContainer.innerHTML = globalConfig.categories.map(cat => `
                    <div class="checkbox-item">
                        <input type="checkbox" value="${cat}" id="supplier_cat_${cat}">
                        <label for="supplier_cat_${cat}">${formatCategoryName(cat)}</label>
                    </div>
                `).join('');
            } catch (error) {
                console.error('Error populating supplier categories:', error);
            }
        }

        async function handleAddSupplier(e) {
            e.preventDefault();

            const selectedCategories = Array.from(document.querySelectorAll('#supplierCategories input:checked'))
                .map(input => input.value);

            if (selectedCategories.length === 0) {
                showToast('Selecciona al menos una categoría de productos', 'error');
                return;
            }

            const supplierData = {
                name: document.getElementById('supplierName').value.trim(),
                taxId: document.getElementById('supplierTaxId').value.trim(),
                address: document.getElementById('supplierAddress').value.trim(),
                phone: document.getElementById('supplierPhone').value.trim(),
                email: document.getElementById('supplierEmail').value.trim(),
                contactPerson: document.getElementById('supplierContact').value.trim(),
                deliveryTime: parseInt(document.getElementById('supplierDeliveryTime').value) || null,
                categories: selectedCategories,
                minOrderAmount: parseFloat(document.getElementById('supplierMinOrder').value) || 0,
                volumeDiscount: parseFloat(document.getElementById('supplierDiscount').value) || 0,
                paymentTerms: document.getElementById('supplierPaymentTerms').value,
                notes: document.getElementById('supplierNotes').value.trim(),
                rating: 0,
                isActive: true,
                createdAt: serverTimestamp(),
                createdBy: currentUser.uid,
                lastUpdate: serverTimestamp()
            };

            try {
                await addDoc(collection(db, 'suppliers'), supplierData);
                showToast('Proveedor creado correctamente', 'success');
                closeModal('addSupplierModal');
                document.getElementById('addSupplierForm').reset();
                loadSuppliers();
            } catch (error) {
                console.error('Error creating supplier:', error);
                showToast('Error al crear proveedor', 'error');
            }
        }

        function filterSuppliers() {
            const categoryFilter = document.getElementById('supplierCategoryFilter').value;
            const rows = document.querySelectorAll('#suppliersTableBody tr');

            rows.forEach(row => {
                let shouldShow = true;

                if (categoryFilter) {
                    const categoriesCell = row.cells[1]?.textContent || '';
                    shouldShow = shouldShow && categoriesCell.toLowerCase().includes(formatCategoryName(categoryFilter).toLowerCase());
                }

                row.style.display = shouldShow ? '' : 'none';
            });
        }

        // Purchase Orders Functions
        async function loadPurchaseOrders() {
            showLoading('purchaseOrdersLoading');

            try {
                let purchaseOrdersQuery = collection(db, 'purchaseOrders');

                if (selectedCenterId) {
                    purchaseOrdersQuery = query(
                        purchaseOrdersQuery,
                        where('centerId', '==', selectedCenterId),
                        orderBy('createdAt', 'desc')
                    );
                } else if (userData.role !== 'LIFE_ADMIN') {
                    purchaseOrdersQuery = query(
                        purchaseOrdersQuery,
                        where('centerId', 'in', userData.centerIds || []),
                        orderBy('createdAt', 'desc')
                    );
                } else {
                    purchaseOrdersQuery = query(purchaseOrdersQuery, orderBy('createdAt', 'desc'));
                }

                const snapshot = await getDocs(purchaseOrdersQuery);
                allPurchaseOrders = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                renderPurchaseOrders(allPurchaseOrders);
            } catch (error) {
                console.error('Error loading purchase orders:', error);
                showToast('Error al cargar órdenes de compra', 'error');
            } finally {
                hideLoading('purchaseOrdersLoading');
            }
        }

        function renderPurchaseOrders(orders) {
            const purchaseOrdersTableBody = document.getElementById('purchaseOrdersTableBody');

            if (orders.length === 0) {
                purchaseOrdersTableBody.innerHTML = '<tr><td colspan="7" class="text-center text-secondary">No hay órdenes de compra registradas</td></tr>';
                return;
            }

            purchaseOrdersTableBody.innerHTML = orders.map(order => `
                <tr>
                    <td>#${order.id.substring(0, 8)}</td>
                    <td>${order.supplierName || 'Sin asignar'}</td>
                    <td>${order.centerName || 'Sin asignar'}</td>
                    <td>${formatDate(order.createdAt)}</td>
                    <td>${formatCurrency(order.totalAmount || 0)}</td>
                    <td><span class="badge badge-${getPurchaseOrderStatusBadge(order.status)}">${getPurchaseOrderStatusName(order.status)}</span></td>
                    <td>
                        <div class="flex gap-1">
                            <button class="btn btn-small btn-primary" onclick="viewPurchaseOrder('${order.id}')">
                                <i class="fas fa-eye"></i>
                            </button>
                            ${canManagePurchaseOrder(order) ? `
                                <button class="btn btn-small btn-outline" onclick="editPurchaseOrder('${order.id}')">
                                    <i class="fas fa-edit"></i>
                                </button>
                                ${order.status === 'draft' || order.status === 'sent' ? `
                                    <button class="btn btn-small btn-success" onclick="confirmPurchaseOrder('${order.id}')">
                                        <i class="fas fa-check"></i>
                                    </button>
                                ` : ''}
                                ${order.status === 'confirmed' ? `
                                    <button class="btn btn-small btn-warning" onclick="markInTransit('${order.id}')">
                                        <i class="fas fa-truck"></i>
                                    </button>
                                ` : ''}
                                ${order.status === 'in_transit' ? `
                                    <button class="btn btn-small btn-success" onclick="markDelivered('${order.id}')">
                                        <i class="fas fa-check-circle"></i>
                                    </button>
                                ` : ''}
                            ` : ''}
                        </div>
                    </td>
                </tr>
            `).join('');
        }

        function getPurchaseOrderStatusBadge(status) {
            const badges = {
                'draft': 'pending',
                'sent': 'active',
                'confirmed': 'approved',
                'in_transit': 'pending',
                'delivered': 'active',
                'cancelled': 'inactive'
            };
            return badges[status] || 'pending';
        }

        function getPurchaseOrderStatusName(status) {
            const names = {
                'draft': 'Borrador',
                'sent': 'Enviada',
                'confirmed': 'Confirmada',
                'in_transit': 'En Tránsito',
                'delivered': 'Entregada',
                'cancelled': 'Cancelada'
            };
            return names[status] || status;
        }

        function canManagePurchaseOrder(order) {
            if (userData.role === 'LIFE_ADMIN') return true;
            if (userData.role === 'CENTER_ADMIN') {
                return userData.centerIds?.includes(order.centerId);
            }
            return false;
        }

        async function populatePurchaseOrderData() {
            try {
                // Populate suppliers
                const purchaseOrderSupplier = document.getElementById('purchaseOrderSupplier');
                purchaseOrderSupplier.innerHTML = '<option value="">Seleccionar proveedor</option>' +
                    allSuppliers.filter(s => s.isActive).map(supplier => 
                        `<option value="${supplier.id}">${supplier.name}</option>`
                    ).join('');

                // Populate centers
                const purchaseOrderCenterGroup = document.getElementById('purchaseOrderCenterGroup');
                const purchaseOrderCenter = document.getElementById('purchaseOrderCenter');

                if (selectedCenterId) {
                    purchaseOrderCenterGroup.style.display = 'none';
                    purchaseOrderCenter.value = selectedCenterId;
                    purchaseOrderCenter.removeAttribute('required');
                } else {
                    purchaseOrderCenterGroup.style.display = 'block';
                    purchaseOrderCenter.setAttribute('required', '');
                    purchaseOrderCenter.innerHTML = '<option value="">Seleccionar centro</option>' +
                        allCenters.map(center => `<option value="${center.id}">${center.name}</option>`).join('');
                }

                // Set delivery date to one week from now
                const deliveryDate = new Date();
                deliveryDate.setDate(deliveryDate.getDate() + 7);
                document.getElementById('purchaseOrderDeliveryDate').value = deliveryDate.toISOString().split('T')[0];

            } catch (error) {
                console.error('Error populating purchase order data:', error);
            }
        }

        function resetPurchaseOrderItems() {
            const purchaseOrderItems = document.getElementById('purchaseOrderItems');
            purchaseOrderItems.innerHTML = `
                <div class="purchase-order-item" style="display: flex; gap: 8px; margin-bottom: 8px; align-items: end; padding: 12px; border: 1px solid var(--border); border-radius: 4px;">
                    <div style="flex: 1;">
                        <label class="form-label text-xs">Producto</label>
                        <input type="text" class="form-input po-product" placeholder="Nombre del producto" required>
                    </div>
                    <div style="width: 100px;">
                        <label class="form-label text-xs">Cantidad</label>
                        <input type="number" class="form-input po-quantity" placeholder="1" min="1" required onchange="calculatePurchaseOrderItemTotal(this)">
                    </div>
                    <div style="width: 120px;">
                        <label class="form-label text-xs">Precio Unit. (€)</label>
                        <input type="number" class="form-input po-price" placeholder="0.00" step="0.01" min="0" required onchange="calculatePurchaseOrderItemTotal(this)">
                    </div>
                    <div style="width: 120px;">
                        <label class="form-label text-xs">Total (€)</label>
                        <input type="number" class="form-input po-total" readonly style="background: #f8f9fa;">
                    </div>
                    <button type="button" class="btn btn-danger btn-small" onclick="removePurchaseOrderItem(this)" style="height: 38px;">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            `;
        }

        function addPurchaseOrderItem() {
            const purchaseOrderItems = document.getElementById('purchaseOrderItems');
            const newItem = document.createElement('div');
            newItem.className = 'purchase-order-item';
            newItem.style.cssText = 'display: flex; gap: 8px; margin-bottom: 8px; align-items: end; padding: 12px; border: 1px solid var(--border); border-radius: 4px;';

            newItem.innerHTML = `
                <div style="flex: 1;">
                    <label class="form-label text-xs">Producto</label>
                    <input type="text" class="form-input po-product" placeholder="Nombre del producto" required>
                </div>
                <div style="width: 100px;">
                    <label class="form-label text-xs">Cantidad</label>
                    <input type="number" class="form-input po-quantity" placeholder="1" min="1" required onchange="calculatePurchaseOrderItemTotal(this)">
                </div>
                <div style="width: 120px;">
                    <label class="form-label text-xs">Precio Unit. (€)</label>
                    <input type="number" class="form-input po-price" placeholder="0.00" step="0.01" min="0" required onchange="calculatePurchaseOrderItemTotal(this)">
                </div>
                <div style="width: 120px;">
                    <label class="form-label text-xs">Total (€)</label>
                    <input type="number" class="form-input po-total" readonly style="background: #f8f9fa;">
                </div>
                <button type="button" class="btn btn-danger btn-small" onclick="removePurchaseOrderItem(this)" style="height: 38px;">
                    <i class="fas fa-trash"></i>
                </button>
            `;

            purchaseOrderItems.appendChild(newItem);
        }

        function removePurchaseOrderItem(button) {
            const purchaseOrderItems = document.getElementById('purchaseOrderItems');
            if (purchaseOrderItems.children.length > 1) {
                button.closest('.purchase-order-item').remove();
                calculatePurchaseOrderTotal();
            } else {
                showToast('Debe haber al menos un producto en la orden', 'warning');
            }
        }

        function calculatePurchaseOrderItemTotal(input) {
            const item = input.closest('.purchase-order-item');
            const quantity = parseFloat(item.querySelector('.po-quantity').value) || 0;
            const price = parseFloat(item.querySelector('.po-price').value) || 0;
            const total = quantity * price;
            
            item.querySelector('.po-total').value = total.toFixed(2);
            calculatePurchaseOrderTotal();
        }

        function calculatePurchaseOrderTotal() {
            const items = document.querySelectorAll('.purchase-order-item');
            let total = 0;

            items.forEach(item => {
                const itemTotal = parseFloat(item.querySelector('.po-total').value) || 0;
                total += itemTotal;
            });

            document.getElementById('purchaseOrderTotal').value = formatCurrency(total);
        }

        async function handleCreatePurchaseOrder(e) {
            e.preventDefault();

            const supplierId = document.getElementById('purchaseOrderSupplier').value;
            const centerId = selectedCenterId || document.getElementById('purchaseOrderCenter').value;

            if (!supplierId) {
                showToast('Selecciona un proveedor', 'error');
                return;
            }

            if (!centerId) {
                showToast('Selecciona un centro', 'error');
                return;
            }

            const orderItems = [];
            let totalAmount = 0;

            // Collect order items
            document.querySelectorAll('.purchase-order-item').forEach(item => {
                const product = item.querySelector('.po-product').value.trim();
                const quantity = parseInt(item.querySelector('.po-quantity').value) || 0;
                const price = parseFloat(item.querySelector('.po-price').value) || 0;
                const itemTotal = quantity * price;

                if (product && quantity > 0 && price > 0) {
                    orderItems.push({
                        productName: product,
                        quantity: quantity,
                        unitPrice: price,
                        totalPrice: itemTotal
                    });
                    totalAmount += itemTotal;
                }
            });

            if (orderItems.length === 0) {
                showToast('Añade al menos un producto a la orden', 'error');
                return;
            }

            // Get supplier and center data
            const supplier = allSuppliers.find(s => s.id === supplierId);
            const center = allCenters.find(c => c.id === centerId);

            const purchaseOrderData = {
                supplierId: supplierId,
                supplierName: supplier?.name || 'Proveedor desconocido',
                centerId: centerId,
                centerName: center?.name || 'Centro desconocido',
                items: orderItems,
                totalAmount: totalAmount,
                status: 'draft',
                deliveryDate: document.getElementById('purchaseOrderDeliveryDate').value,
                notes: document.getElementById('purchaseOrderNotes').value.trim(),
                createdAt: serverTimestamp(),
                createdBy: currentUser.uid,
                createdByName: userData.name || userData.email,
                lastUpdate: serverTimestamp()
            };

            try {
                await addDoc(collection(db, 'purchaseOrders'), purchaseOrderData);
                showToast('Orden de compra creada correctamente', 'success');
                closeModal('createPurchaseOrderModal');
                document.getElementById('createPurchaseOrderForm').reset();
                resetPurchaseOrderItems();
                loadPurchaseOrders();
            } catch (error) {
                console.error('Error creating purchase order:', error);
                showToast('Error al crear orden de compra', 'error');
            }
        }

        function filterPurchaseOrders() {
            const statusFilter = document.getElementById('purchaseOrderStatusFilter').value;
            const rows = document.querySelectorAll('#purchaseOrdersTableBody tr');

            rows.forEach(row => {
                let shouldShow = true;

                if (statusFilter) {
                    const statusCell = row.cells[5]?.textContent || '';
                    shouldShow = shouldShow && statusCell.toLowerCase().includes(getPurchaseOrderStatusName(statusFilter).toLowerCase());
                }

                row.style.display = shouldShow ? '' : 'none';
            });
        }

        // Supplier Product Management
        async function viewSupplierProducts(supplierId) {
            try {
                const supplier = allSuppliers.find(s => s.id === supplierId);
                if (!supplier) return;

                document.getElementById('supplierProductsTitle').textContent = `${supplier.name} - Catálogo de Productos`;

                // Load supplier products (this would be a separate collection in a real implementation)
                const supplierProductsTableBody = document.getElementById('supplierProductsTableBody');
                supplierProductsTableBody.innerHTML = `
                    <tr><td colspan="6" class="text-center text-secondary">
                        Función de catálogo de productos del proveedor en desarrollo.<br>
                        <small>Esta funcionalidad permitirá gestionar el catálogo completo de productos de cada proveedor.</small>
                    </td></tr>
                `;

                openModal('supplierProductsModal');
            } catch (error) {
                console.error('Error loading supplier products:', error);
                showToast('Error al cargar productos del proveedor', 'error');
            }
        }

        // Quote Management
        async function requestQuote(supplierIds) {
            try {
                const selectedSuppliersContainer = document.getElementById('selectedSuppliersForQuote');
                
                const selectedSuppliers = allSuppliers.filter(s => supplierIds.includes(s.id));
                selectedSuppliersContainer.innerHTML = selectedSuppliers.map(supplier => `
                    <div class="checkbox-item">
                        <input type="checkbox" value="${supplier.id}" id="quote_supplier_${supplier.id}" checked>
                        <label for="quote_supplier_${supplier.id}">${supplier.name}</label>
                    </div>
                `).join('');

                // Set default deadline to 7 days from now
                const deadline = new Date();
                deadline.setDate(deadline.getDate() + 7);
                document.getElementById('quoteDeadline').value = deadline.toISOString().split('T')[0];

                resetQuoteItems();
                openModal('requestQuoteModal');
            } catch (error) {
                console.error('Error preparing quote request:', error);
                showToast('Error al preparar solicitud de cotización', 'error');
            }
        }

        function resetQuoteItems() {
            const quoteItems = document.getElementById('quoteItems');
            quoteItems.innerHTML = `
                <div class="quote-item" style="display: flex; gap: 8px; margin-bottom: 8px; align-items: end;">
                    <div style="flex: 1;">
                        <label class="form-label text-xs">Producto</label>
                        <input type="text" class="form-input quote-product" placeholder="Nombre del producto" required>
                    </div>
                    <div style="width: 100px;">
                        <label class="form-label text-xs">Cantidad</label>
                        <input type="number" class="form-input quote-quantity" placeholder="1" min="1" required>
                    </div>
                    <div style="width: 150px;">
                        <label class="form-label text-xs">Especificaciones</label>
                        <input type="text" class="form-input quote-specs" placeholder="Opcional">
                    </div>
                    <button type="button" class="btn btn-danger btn-small" onclick="removeQuoteItem(this)" style="height: 38px;">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            `;
        }

        function addQuoteItem() {
            const quoteItems = document.getElementById('quoteItems');
            const newItem = document.createElement('div');
            newItem.className = 'quote-item';
            newItem.style.cssText = 'display: flex; gap: 8px; margin-bottom: 8px; align-items: end;';

            newItem.innerHTML = `
                <div style="flex: 1;">
                    <label class="form-label text-xs">Producto</label>
                    <input type="text" class="form-input quote-product" placeholder="Nombre del producto" required>
                </div>
                <div style="width: 100px;">
                    <label class="form-label text-xs">Cantidad</label>
                    <input type="number" class="form-input quote-quantity" placeholder="1" min="1" required>
                </div>
                <div style="width: 150px;">
                    <label class="form-label text-xs">Especificaciones</label>
                    <input type="text" class="form-input quote-specs" placeholder="Opcional">
                </div>
                <button type="button" class="btn btn-danger btn-small" onclick="removeQuoteItem(this)" style="height: 38px;">
                    <i class="fas fa-trash"></i>
                </button>
            `;

            quoteItems.appendChild(newItem);
        }

        function removeQuoteItem(button) {
            const quoteItems = document.getElementById('quoteItems');
            if (quoteItems.children.length > 1) {
                button.closest('.quote-item').remove();
            } else {
                showToast('Debe haber al menos un producto en la cotización', 'warning');
            }
        }

        async function handleRequestQuote(e) {
            e.preventDefault();

            const selectedSuppliers = Array.from(document.querySelectorAll('#selectedSuppliersForQuote input:checked'))
                .map(input => input.value);

            if (selectedSuppliers.length === 0) {
                showToast('Selecciona al menos un proveedor', 'error');
                return;
            }

            const quoteItems = [];
            document.querySelectorAll('.quote-item').forEach(item => {
                const product = item.querySelector('.quote-product').value.trim();
                const quantity = parseInt(item.querySelector('.quote-quantity').value) || 0;
                const specs = item.querySelector('.quote-specs').value.trim();

                if (product && quantity > 0) {
                    quoteItems.push({
                        productName: product,
                        quantity: quantity,
                        specifications: specs
                    });
                }
            });

            if (quoteItems.length === 0) {
                showToast('Añade al menos un producto a la cotización', 'error');
                return;
            }

            const quoteData = {
                supplierIds: selectedSuppliers,
                items: quoteItems,
                deadline: document.getElementById('quoteDeadline').value,
                deliveryDate: document.getElementById('quoteDeliveryDate').value,
                notes: document.getElementById('quoteNotes').value.trim(),
                status: 'sent',
                centerId: selectedCenterId || null,
                centerName: selectedCenterId ? allCenters.find(c => c.id === selectedCenterId)?.name : null,
                requestedBy: currentUser.uid,
                requestedByName: userData.name || userData.email,
                createdAt: serverTimestamp()
            };

            try {
                await addDoc(collection(db, 'quotes'), quoteData);
                showToast(`Solicitud de cotización enviada a ${selectedSuppliers.length} proveedor(es)`, 'success');
                closeModal('requestQuoteModal');
                document.getElementById('requestQuoteForm').reset();
                resetQuoteItems();
            } catch (error) {
                console.error('Error sending quote request:', error);
                showToast('Error al enviar solicitud de cotización', 'error');
            }
        }

        // Purchase Order Actions
        async function confirmPurchaseOrder(orderId) {
            try {
                await updateDoc(doc(db, 'purchaseOrders', orderId), {
                    status: 'confirmed',
                    confirmedAt: serverTimestamp(),
                    confirmedBy: currentUser.uid,
                    lastUpdate: serverTimestamp()
                });

                showToast('Orden de compra confirmada', 'success');
                loadPurchaseOrders();
            } catch (error) {
                console.error('Error confirming purchase order:', error);
                showToast('Error al confirmar orden de compra', 'error');
            }
        }

        async function markInTransit(orderId) {
            try {
                await updateDoc(doc(db, 'purchaseOrders', orderId), {
                    status: 'in_transit',
                    inTransitAt: serverTimestamp(),
                    lastUpdate: serverTimestamp()
                });

                showToast('Orden marcada como en tránsito', 'success');
                loadPurchaseOrders();
            } catch (error) {
                console.error('Error marking order as in transit:', error);
                showToast('Error al marcar orden en tránsito', 'error');
            }
        }

        async function markDelivered(orderId) {
            try {
                const orderDoc = await getDoc(doc(db, 'purchaseOrders', orderId));
                if (orderDoc.exists()) {
                    const orderData = orderDoc.data();

                    await updateDoc(doc(db, 'purchaseOrders', orderId), {
                        status: 'delivered',
                        deliveredAt: serverTimestamp(),
                        lastUpdate: serverTimestamp()
                    });

                    // TODO: Automatically update inventory with received items
                    // This would require integration with the inventory system

                    showToast('Orden marcada como entregada', 'success');
                    loadPurchaseOrders();
                }
            } catch (error) {
                console.error('Error marking order as delivered:', error);
                showToast('Error al marcar orden como entregada', 'error');
            }
        }

        // Helper functions for purchase orders
        function createPurchaseOrderForSupplier(supplierId) {
            populatePurchaseOrderData();
            document.getElementById('purchaseOrderSupplier').value = supplierId;
            resetPurchaseOrderItems();
            openModal('createPurchaseOrderModal');
        }

        async function viewPurchaseOrder(orderId) {
            // TODO: Implement detailed view modal for purchase orders
            console.log('Viewing purchase order:', orderId);
            showToast('Vista detallada de orden de compra en desarrollo', 'info');
        }

        async function editPurchaseOrder(orderId) {
            // TODO: Implement edit functionality for purchase orders
            console.log('Editing purchase order:', orderId);
            showToast('Edición de orden de compra en desarrollo', 'info');
        }

        async function editSupplier(supplierId) {
            // TODO: Implement edit functionality for suppliers
            console.log('Editing supplier:', supplierId);
            showToast('Edición de proveedor en desarrollo', 'info');
        }

        // Make functions global for onclick handlers
        window.viewSupplierProducts = viewSupplierProducts;
        window.requestQuote = requestQuote;
        window.editSupplier = editSupplier;
        window.createPurchaseOrderForSupplier = createPurchaseOrderForSupplier;
        window.addPurchaseOrderItem = addPurchaseOrderItem;
        window.removePurchaseOrderItem = removePurchaseOrderItem;
        window.calculatePurchaseOrderItemTotal = calculatePurchaseOrderItemTotal;
        window.addQuoteItem = addQuoteItem;
        window.removeQuoteItem = removeQuoteItem;
        window.viewPurchaseOrder = viewPurchaseOrder;
        window.editPurchaseOrder = editPurchaseOrder;
        window.confirmPurchaseOrder = confirmPurchaseOrder;
        window.markInTransit = markInTransit;
        window.markDelivered = markDelivered;

        // Utility Functions for Calendar and Time Log
        function setTodayDate(inputId) {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById(inputId).value = today;
        }

        function formatDuration(hours) {
            const wholeHours = Math.floor(hours);
            const minutes = Math.round((hours - wholeHours) * 60);
            return `${wholeHours}:${minutes.toString().padStart(2, '0')}`;
        }

        function getWeekStart(date) {
            const start = new Date(date);
            const day = start.getDay();
            const diff = start.getDate() - day;
            start.setDate(diff);
            start.setHours(0, 0, 0, 0);
            return start;
        }

        // Event handlers for calendar and time log
        function openDayEvents(date) {
            // TODO: Implement day events modal
            console.log('Opening events for', date);
        }

        function viewEvent(eventId) {
            // TODO: Implement event details modal
            console.log('Viewing event', eventId);
        }

        async function editTimeEntry(entryId) {
            // TODO: Implement edit time entry
            console.log('Editing time entry', entryId);
        }

        async function deleteTimeEntry(entryId) {
            if (!confirm('¿Estás seguro de que quieres eliminar esta entrada de tiempo?')) {
                return;
            }

            try {
                await deleteDoc(doc(db, 'timeEntries', entryId));
                showToast('Entrada eliminada correctamente', 'success');
                loadTimeLog();
            } catch (error) {
                console.error('Error deleting time entry:', error);
                showToast('Error al eliminar entrada', 'error');
            }
        }

        // Accounting Functions
        async function loadAccounting() {
            try {
                await loadTransactions();
                await loadBudgets();
                await updateFinancialSummary();
                showAccountingTab(currentAccountingTab);
            } catch (error) {
                console.error('Error loading accounting:', error);
                showToast('Error al cargar contabilidad', 'error');
            }
        }

        async function loadTransactions() {
            try {
                let transactionsQuery = collection(db, 'transactions');

                if (selectedCenterId) {
                    transactionsQuery = query(
                        transactionsQuery,
                        where('centerId', '==', selectedCenterId),
                        orderBy('date', 'desc')
                    );
                } else if (userData.role !== 'LIFE_ADMIN') {
                    transactionsQuery = query(
                        transactionsQuery,
                        where('centerId', 'in', userData.centerIds || []),
                        orderBy('date', 'desc')
                    );
                } else {
                    transactionsQuery = query(transactionsQuery, orderBy('date', 'desc'));
                }

                const snapshot = await getDocs(transactionsQuery);
                allTransactions = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                renderTransactions(allTransactions);
            } catch (error) {
                console.error('Error loading transactions:', error);
            }
        }

        async function loadBudgets() {
            try {
                let budgetsQuery = collection(db, 'budgets');

                if (selectedCenterId) {
                    budgetsQuery = query(budgetsQuery, where('centerId', '==', selectedCenterId));
                } else if (userData.role !== 'LIFE_ADMIN') {
                    budgetsQuery = query(budgetsQuery, where('centerId', 'in', userData.centerIds || []));
                }

                const snapshot = await getDocs(budgetsQuery);
                allBudgets = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                renderBudgets(allBudgets);
            } catch (error) {
                console.error('Error loading budgets:', error);
            }
        }

        function showAccountingTab(tabName) {
            currentAccountingTab = tabName;

            // Update tab buttons
            document.querySelectorAll('.accounting-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelector(`[onclick="showAccountingTab('${tabName}')"]`).classList.add('active');

            // Update tab content
            document.querySelectorAll('.accounting-tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(`accounting${tabName.charAt(0).toUpperCase() + tabName.slice(1)}`).classList.add('active');

            // Load specific content
            switch (tabName) {
                case 'overview':
                    loadAccountingOverview();
                    break;
                case 'transactions':
                    loadTransactions();
                    break;
                case 'budgets':
                    loadBudgets();
                    break;
            }
        }

        async function loadAccountingOverview() {
            renderCenterFinancialSummary();
        }

        function renderCenterFinancialSummary() {
            const container = document.getElementById('centerFinancialSummary');
            
            if (allCenters.length === 0) {
                container.innerHTML = '<p class="text-center text-secondary">No hay centros disponibles</p>';
                return;
            }

            container.innerHTML = allCenters.map(center => {
                const centerTransactions = allTransactions.filter(t => t.centerId === center.id);
                const currentMonth = new Date().toISOString().slice(0, 7);
                const monthlyIncome = centerTransactions
                    .filter(t => t.type === 'income' && t.date?.startsWith(currentMonth))
                    .reduce((sum, t) => sum + (t.amount || 0), 0);
                const monthlyExpenses = centerTransactions
                    .filter(t => t.type === 'expense' && t.date?.startsWith(currentMonth))
                    .reduce((sum, t) => sum + (t.amount || 0), 0);

                return `
                    <div class="financial-summary-card">
                        <div class="financial-summary-header">
                            <div class="financial-summary-center">${center.name}</div>
                            <div class="financial-summary-period">Este mes</div>
                        </div>
                        <div class="financial-summary-metrics">
                            <div class="financial-metric">
                                <div class="financial-metric-value">€${monthlyIncome.toFixed(0)}</div>
                                <div class="financial-metric-label">Ingresos</div>
                            </div>
                            <div class="financial-metric">
                                <div class="financial-metric-value">€${monthlyExpenses.toFixed(0)}</div>
                                <div class="financial-metric-label">Gastos</div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function renderTransactions(transactions) {
            const transactionsTableBody = document.getElementById('transactionsTableBody');

            if (transactions.length === 0) {
                transactionsTableBody.innerHTML = '<tr><td colspan="8" class="text-center text-secondary">No hay transacciones registradas</td></tr>';
                return;
            }

            transactionsTableBody.innerHTML = transactions.map(transaction => `
                <tr>
                    <td>${formatDate(transaction.date)}</td>
                    <td>
                        <span class="transaction-type-${transaction.type}">
                            ${transaction.type === 'income' ? 'Ingreso' : 'Gasto'}
                        </span>
                    </td>
                    <td>${transaction.description}</td>
                    <td>${transaction.centerName || 'Sin asignar'}</td>
                    <td>${transaction.category}</td>
                    <td>
                        <span class="transaction-amount-${transaction.type === 'income' ? 'positive' : 'negative'}">
                            ${transaction.type === 'income' ? '+' : '-'}${formatCurrency(transaction.amount)}
                        </span>
                    </td>
                    <td><span class="badge badge-${transaction.status === 'completed' ? 'active' : 'pending'}">${getTransactionStatusName(transaction.status)}</span></td>
                    <td>
                        <div class="flex gap-1">
                            <button class="btn btn-small btn-outline" onclick="editTransaction('${transaction.id}')">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-small btn-danger" onclick="deleteTransaction('${transaction.id}')">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                </tr>
            `).join('');
        }

        function renderBudgets(budgets) {
            const budgetsGrid = document.getElementById('budgetsGrid');

            if (budgets.length === 0) {
                budgetsGrid.innerHTML = '<div class="col-span-2"><p class="text-center text-secondary">No hay presupuestos configurados</p></div>';
                return;
            }

            budgetsGrid.innerHTML = budgets.map(budget => {
                const totalBudget = budget.categories?.reduce((sum, cat) => sum + (cat.amount || 0), 0) || 0;
                const spent = calculateBudgetSpent(budget);
                const percentage = totalBudget > 0 ? (spent / totalBudget) * 100 : 0;
                const remaining = totalBudget - spent;

                return `
                    <div class="budget-card">
                        <div class="budget-header">
                            <div>
                                <div class="budget-title">${budget.centerName || 'Centro desconocido'}</div>
                                <div class="budget-period">${formatBudgetPeriod(budget.period)} - ${formatDate(budget.startDate)} a ${formatDate(budget.endDate)}</div>
                            </div>
                            <div class="flex gap-1">
                                <button class="btn btn-small btn-outline" onclick="editBudget('${budget.id}')">
                                    <i class="fas fa-edit"></i>
                                </button>
                            </div>
                        </div>
                        <div class="budget-progress">
                            <div class="budget-progress-bar">
                                <div class="budget-progress-fill ${percentage > 90 ? 'danger' : percentage > 75 ? 'warning' : ''}" 
                                     style="width: ${Math.min(percentage, 100)}%"></div>
                            </div>
                        </div>
                        <div class="budget-details">
                            <div class="budget-spent">Gastado: ${formatCurrency(spent)}</div>
                            <div class="budget-remaining">Restante: ${formatCurrency(remaining)}</div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        async function updateFinancialSummary() {
            const currentMonth = new Date().toISOString().slice(0, 7);
            
            const monthlyIncome = allTransactions
                .filter(t => t.type === 'income' && t.date?.startsWith(currentMonth))
                .reduce((sum, t) => sum + (t.amount || 0), 0);
            
            const monthlyExpenses = allTransactions
                .filter(t => t.type === 'expense' && t.date?.startsWith(currentMonth))
                .reduce((sum, t) => sum + (t.amount || 0), 0);
            
            const netProfit = monthlyIncome - monthlyExpenses;
            
            const pendingPayments = allTransactions
                .filter(t => t.status === 'pending')
                .reduce((sum, t) => sum + (t.amount || 0), 0);

            document.getElementById('totalIncome').textContent = formatCurrency(monthlyIncome);
            document.getElementById('totalExpenses').textContent = formatCurrency(monthlyExpenses);
            document.getElementById('netProfit').textContent = formatCurrency(netProfit);
            document.getElementById('netProfit').style.color = netProfit >= 0 ? 'var(--success)' : 'var(--error)';
            document.getElementById('pendingPayments').textContent = formatCurrency(pendingPayments);
        }

        async function populateTransactionCenters() {
            try {
                const transactionCenterGroup = document.getElementById('transactionCenterGroup');
                const transactionCenter = document.getElementById('transactionCenter');

                if (selectedCenterId) {
                    transactionCenterGroup.style.display = 'none';
                    transactionCenter.value = selectedCenterId;
                } else {
                    transactionCenterGroup.style.display = 'block';
                    transactionCenter.innerHTML = '<option value="">Seleccionar centro</option>' +
                        allCenters.map(center => `<option value="${center.id}">${center.name}</option>`).join('');
                }
            } catch (error) {
                console.error('Error populating transaction centers:', error);
            }
        }

        async function populateBudgetCenters() {
            try {
                const budgetCenter = document.getElementById('budgetCenter');
                budgetCenter.innerHTML = '<option value="">Seleccionar centro</option>' +
                    allCenters.map(center => `<option value="${center.id}">${center.name}</option>`).join('');

                if (selectedCenterId) {
                    budgetCenter.value = selectedCenterId;
                }
            } catch (error) {
                console.error('Error populating budget centers:', error);
            }
        }

        async function handleAddTransaction(e) {
            e.preventDefault();

            const centerId = selectedCenterId || document.getElementById('transactionCenter').value || null;
            
            const transactionData = {
                type: document.getElementById('transactionType').value,
                date: document.getElementById('transactionDate').value,
                description: document.getElementById('transactionDescription').value.trim(),
                amount: parseFloat(document.getElementById('transactionAmount').value),
                category: document.getElementById('transactionCategory').value,
                centerId: centerId,
                centerName: centerId ? allCenters.find(c => c.id === centerId)?.name : null,
                paymentMethod: document.getElementById('transactionPaymentMethod').value,
                status: document.getElementById('transactionStatus').value,
                notes: document.getElementById('transactionNotes').value.trim(),
                createdAt: serverTimestamp(),
                createdBy: currentUser.uid,
                createdByName: userData.name || userData.email
            };

            try {
                await addDoc(collection(db, 'transactions'), transactionData);
                showToast('Transacción registrada correctamente', 'success');
                closeModal('addTransactionModal');
                document.getElementById('addTransactionForm').reset();
                loadAccounting();
            } catch (error) {
                console.error('Error creating transaction:', error);
                showToast('Error al registrar transacción', 'error');
            }
        }

        async function handleAddBudget(e) {
            e.preventDefault();

            const budgetCategories = [];
            document.querySelectorAll('.budget-category-item').forEach(item => {
                const category = item.querySelector('.budget-category').value;
                const amount = parseFloat(item.querySelector('.budget-amount').value) || 0;
                
                if (category && amount > 0) {
                    budgetCategories.push({ category, amount });
                }
            });

            if (budgetCategories.length === 0) {
                showToast('Añade al menos una categoría con presupuesto', 'error');
                return;
            }

            const centerId = document.getElementById('budgetCenter').value;
            const budgetData = {
                centerId: centerId,
                centerName: allCenters.find(c => c.id === centerId)?.name || 'Centro desconocido',
                period: document.getElementById('budgetPeriod').value,
                startDate: document.getElementById('budgetStartDate').value,
                endDate: document.getElementById('budgetEndDate').value,
                categories: budgetCategories,
                notes: document.getElementById('budgetNotes').value.trim(),
                createdAt: serverTimestamp(),
                createdBy: currentUser.uid,
                createdByName: userData.name || userData.email
            };

            try {
                await addDoc(collection(db, 'budgets'), budgetData);
                showToast('Presupuesto creado correctamente', 'success');
                closeModal('addBudgetModal');
                document.getElementById('addBudgetForm').reset();
                resetBudgetCategories();
                loadAccounting();
            } catch (error) {
                console.error('Error creating budget:', error);
                showToast('Error al crear presupuesto', 'error');
            }
        }

        function addBudgetCategory() {
            const budgetCategories = document.getElementById('budgetCategories');
            const newItem = document.createElement('div');
            newItem.className = 'budget-category-item';
            newItem.style.cssText = 'display: flex; gap: 8px; margin-bottom: 8px; align-items: center; padding: 8px; border: 1px solid var(--border); border-radius: 4px;';

            newItem.innerHTML = `
                <div style="flex: 1;">
                    <select class="form-select budget-category" required>
                        <option value="">Seleccionar categoría</option>
                        <option value="supplies">Suministros</option>
                        <option value="maintenance">Mantenimiento</option>
                        <option value="utilities">Servicios</option>
                        <option value="personnel">Personal</option>
                        <option value="equipment">Equipamiento</option>
                    </select>
                </div>
                <div style="width: 120px;">
                    <input type="number" class="form-input budget-amount" placeholder="€0.00" step="0.01" min="0" required>
                </div>
                <button type="button" class="btn btn-danger btn-small" onclick="removeBudgetCategory(this)">
                    <i class="fas fa-trash"></i>
                </button>
            `;

            budgetCategories.appendChild(newItem);
        }

        function removeBudgetCategory(button) {
            const budgetCategories = document.getElementById('budgetCategories');
            if (budgetCategories.children.length > 1) {
                button.closest('.budget-category-item').remove();
            } else {
                showToast('Debe haber al menos una categoría en el presupuesto', 'warning');
            }
        }

        function resetBudgetCategories() {
            const budgetCategories = document.getElementById('budgetCategories');
            budgetCategories.innerHTML = `
                <div class="budget-category-item" style="display: flex; gap: 8px; margin-bottom: 8px; align-items: center; padding: 8px; border: 1px solid var(--border); border-radius: 4px;">
                    <div style="flex: 1;">
                        <select class="form-select budget-category" required>
                            <option value="">Seleccionar categoría</option>
                            <option value="supplies">Suministros</option>
                            <option value="maintenance">Mantenimiento</option>
                            <option value="utilities">Servicios</option>
                            <option value="personnel">Personal</option>
                            <option value="equipment">Equipamiento</option>
                        </select>
                    </div>
                    <div style="width: 120px;">
                        <input type="number" class="form-input budget-amount" placeholder="€0.00" step="0.01" min="0" required>
                    </div>
                    <button type="button" class="btn btn-danger btn-small" onclick="removeBudgetCategory(this)">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            `;
        }

        function setDefaultBudgetDates() {
            const today = new Date();
            const firstDay = new Date(today.getFullYear(), today.getMonth(), 1);
            const lastDay = new Date(today.getFullYear(), today.getMonth() + 1, 0);
            
            document.getElementById('budgetStartDate').value = firstDay.toISOString().split('T')[0];
            document.getElementById('budgetEndDate').value = lastDay.toISOString().split('T')[0];
        }

        function filterTransactions() {
            const typeFilter = document.getElementById('transactionTypeFilter').value;
            const monthFilter = document.getElementById('transactionMonthFilter').value;

            let filteredTransactions = allTransactions;

            if (typeFilter) {
                filteredTransactions = filteredTransactions.filter(t => t.type === typeFilter);
            }

            if (monthFilter) {
                filteredTransactions = filteredTransactions.filter(t => t.date?.startsWith(monthFilter));
            }

            renderTransactions(filteredTransactions);
        }

        function calculateBudgetSpent(budget) {
            const budgetTransactions = allTransactions.filter(t => 
                t.centerId === budget.centerId &&
                t.type === 'expense' &&
                t.date >= budget.startDate &&
                t.date <= budget.endDate
            );

            return budgetTransactions.reduce((sum, t) => sum + (t.amount || 0), 0);
        }

        function getTransactionStatusName(status) {
            const names = {
                'completed': 'Completado',
                'pending': 'Pendiente',
                'cancelled': 'Cancelado'
            };
            return names[status] || status;
        }

        function formatBudgetPeriod(period) {
            const periods = {
                'monthly': 'Mensual',
                'quarterly': 'Trimestral',
                'annual': 'Anual'
            };
            return periods[period] || period;
        }

        function generateReport() {
            showToast('Generación de reportes en desarrollo', 'info');
        }

        async function editTransaction(transactionId) {
            showToast('Edición de transacciones en desarrollo', 'info');
        }

        async function deleteTransaction(transactionId) {
            if (!confirm('¿Estás seguro de que quieres eliminar esta transacción?')) {
                return;
            }

            try {
                await deleteDoc(doc(db, 'transactions', transactionId));
                showToast('Transacción eliminada correctamente', 'success');
                loadAccounting();
            } catch (error) {
                console.error('Error deleting transaction:', error);
                showToast('Error al eliminar transacción', 'error');
            }
        }

        async function editBudget(budgetId) {
            showToast('Edición de presupuestos en desarrollo', 'info');
        }

        // Make accounting functions global
        window.showAccountingTab = showAccountingTab;
        window.addBudgetCategory = addBudgetCategory;
        window.removeBudgetCategory = removeBudgetCategory;
        window.generateReport = generateReport;
        window.editTransaction = editTransaction;
        window.deleteTransaction = deleteTransaction;
        window.editBudget = editBudget;

        // Initialize app when DOM is loaded
        document.addEventListener('DOMContentLoaded', initApp);

    </script>
</body>
</html>
